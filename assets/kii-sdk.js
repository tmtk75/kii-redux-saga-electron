if(typeof jQuery==="undefined"){if(typeof process==="object"&&typeof process.versions==="object"){var XMLHttpRequest=require("xmlhttprequest").XMLHttpRequest}}(function(){var ctor=function(){if(!Object.keys){Object.keys=function(){var hasOwnProperty=Object.prototype.hasOwnProperty,hasDontEnumBug=!{toString:null}.propertyIsEnumerable("toString"),dontEnums=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],dontEnumsLength=dontEnums.length;return function(obj){if(typeof obj!=="object"&&typeof obj!=="function"||obj===null)throw new TypeError("Object.keys called on non-object");var result=[];for(var prop in obj){if(hasOwnProperty.call(obj,prop))result.push(prop)}if(hasDontEnumBug){for(var i=0;i<dontEnumsLength;i++){if(hasOwnProperty.call(obj,dontEnums[i]))result.push(dontEnums[i])}}return result}}()}if(typeof Promise==="undefined"){!function(n,t){function c(n,t){return(typeof t)[0]==n}function u(i,o){return o=function f(e,h,l,a,s,p){function y(n){return function(t){s&&(s=0,f(c,n,t))}}if(a=f.q,e!=c)return u(function(n,t){a.push({p:this,r:n,j:t,1:e,0:h})});if(l&&c(n,l)|c(t,l))try{s=l.then}catch(j){h=0,l=j}if(c(n,s))try{s.call(l,y(1),h=y(0))}catch(j){h(j)}else for(o=function(t,o){return c(n,t=h?t:o)?u(function(n,c){r(this,n,c,l,t)}):i},p=0;p<a.length;)s=a[p++],c(n,e=s[h])?r(s.p,s.r,s.j,l,e):(h?s.r:s.j)(l)},o.q=[],i.call(i={then:function(n,t){return o(n,t)},"catch":function(n){return o(0,n)}},function(n){o(c,1,n)},function(n){o(c,0,n)}),i}function r(u,r,i,o,f){setTimeout(function(){try{o=f(o),f=o&&c(t,o)|c(n,o)&&o.then,c(n,f)?o==u?i(TypeError()):f.call(o,r,i):r(o)}catch(e){i(e)}})}function i(n){return u(function(t){t(n)})}Promise=u,u.resolve=i,u.reject=function(n){return u(function(t,c){c(n)})},u.all=function(n){return u(function(t,c,u,r){r=[],u=n.length||t(r),n.map(function(n,o){i(n).then(function(n){r[o]=n,--u||t(r)},c)})})}}("f","o")}var KiiAnalyticsJQXHRWrapper,KiiAnalyticsTiXHRWrapper,KiiAnalyticsXHRWrapper,KiiAnalyticsXHRWrapperFactory,KiiJQXHRWrapper,KiiJQueryHttpRequest,KiiRequest,KiiTiXHRWrapper,KiiTitaniumHttpRequest,KiiUtilities,KiiXHRWrapper,KiiXHRWrapperFactory,KiiXMLHttpRequest,_Kii,_KiiAnalytics,_KiiSocialConnect,root,bind=function(fn,me){return function(){return fn.apply(me,arguments)}},extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty;root=typeof exports!=="undefined"&&exports!==null?new Object:this;root.KiiSocialNetworkName={FACEBOOK:1,TWITTER:2,QQ:3,GOOGLEPLUS:4,RENREN:5};root.KiiSite={US:"https://api.kii.com/api",JP:"https://api-jp.kii.com/api",CN:"https://api-cn2.kii.com/api",SG:"https://api-sg.kii.com/api",CN3:"https://api-cn3.kii.com/api",EU:"https://api-eu.kii.com/api"};root.Kii=function(){var _additionalHeaders,_instance;function Kii(){}_instance=null;_additionalHeaders=null;Kii.getBuildNumber=function(){return"1"};Kii.getSDKVersion=function(){return"2.4.7"};Kii.getBaseURL=function(){return _instance._baseURL};Kii.getAppID=function(){return _instance._appID};Kii.getAdditionalHeaders=function(){return _additionalHeaders};Kii.setAdditionalHeaders=function(additionalHeaders){return _additionalHeaders=additionalHeaders};Kii.getAppKey=function(){return _instance._appKey};Kii.isLogging=function(){return _instance._logging};Kii.setLogging=function(logging){_instance._logging=logging;root.Kii.logger("Setting logging: "+logging);return root.Kii.logger("Base URL: "+_instance._baseURL)};Kii.setAccessTokenExpiration=function(expiresIn){if(!_instance){throw new root.IllegalStateException("Kii is not initialized")}if(isNaN(parseInt(expiresIn,10))){throw new root.InvalidArgumentException("expiresIn should be a number")}if(expiresIn<0){throw new root.InvalidArgumentException("expiresIn should not negative number")}if(_instance){return _instance._expiresIn=expiresIn}};Kii.getAccessTokenExpiration=function(){if(!_instance){throw new root.IllegalStateException("Kii is not initialized")}return _instance._expiresIn};Kii.initializeWithSite=function(appID,appKey,site,analyticsOption){_instance=new _Kii(appID,appKey,site);root.Kii.logger("Initialized "+appID+", "+appKey+", "+site);if(KiiUtilities._type(analyticsOption)==="object"){return root.KiiAnalytics._initializeWithSite(appID,appKey,site,analyticsOption.deviceId)}};Kii.initialize=function(appID,appKey,analyticsOption){return root.Kii.initializeWithSite(appID,appKey,root.KiiSite.US,analyticsOption)};Kii.logger=function(message){if(_instance._logging){return console.log(message)}};Kii.bucketWithName=function(bucketName){var bucket;bucket=new root.KiiBucket(bucketName,null);return bucket};Kii.encryptedBucketWithName=function(bucketName){var bucket;bucket=new root.KiiEncryptedBucket(bucketName,null);return bucket};Kii.groupWithName=function(groupName){return new root.Kii.groupWithNameAndMembers(groupName,null)};Kii.groupWithNameAndMembers=function(groupName,members){return new root.KiiGroup.groupWithNameAndMembers(groupName,members)};Kii.logOut=function(){_instance._currentUser=null;return root.KiiSocialConnect.logOutAll()};Kii.loggedIn=function(){return _instance._currentUser!=null};Kii.getCurrentUser=function(){var user;if(_instance._currentUser!=null){user=new root.KiiUser;user._uuid=_instance._currentUser._uuid;user._username=_instance._currentUser._username;user._displayName=_instance._currentUser._displayName;user._password=_instance._currentUser._password;user._emailAddress=_instance._currentUser._emailAddress;user._phoneNumber=_instance._currentUser._phoneNumber;user._country=_instance._currentUser._country;user._created=_instance._currentUser._created;user._modified=_instance._currentUser._modified;user._emailVerified=_instance._currentUser._emailVerified;user._phoneVerified=_instance._currentUser._phoneVerified;user._accessToken=_instance._currentUser._accessToken;user._customInfo=_instance._currentUser._customInfo;user._expiresAt=_instance._currentUser._expiresAt;user._thirdPartyAccounts=_instance._currentUser._thirdPartyAccounts;user._disabled=_instance._currentUser._disabled;root.Kii.logger("my instance:");root.Kii.logger(user);return user}else{return null}};Kii.setCurrentUser=function(user){_instance._currentUser=new root.KiiUser;_instance._currentUser._uuid=user._uuid;_instance._currentUser._username=user._username;_instance._currentUser._displayName=user._displayName;_instance._currentUser._password=user._password;_instance._currentUser._emailAddress=user._emailAddress;_instance._currentUser._phoneNumber=user._phoneNumber;_instance._currentUser._country=user._country;_instance._currentUser._created=user._created;_instance._currentUser._modified=user._modified;_instance._currentUser._emailVerified=user._emailVerified;_instance._currentUser._phoneVerified=user._phoneVerified;_instance._currentUser._accessToken=user._accessToken;_instance._currentUser._customInfo=user._customInfo;_instance._currentUser._expiresAt=user._expiresAt;_instance._currentUser._thirdPartyAccounts=user._thirdPartyAccounts;_instance._currentUser._disabled=user._disabled;root.Kii.logger("my instance:");return root.Kii.logger(_instance._currentUser)};Kii.authenticateAsAppAdmin=function(clientId,clientSecret,callbacks){return new Promise(function(_this){return function(resolve,reject){var authenticateAsAppAdminCallbacks;authenticateAsAppAdminCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments[0])},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[0]))}};return _this._authenticateAsAppAdminUsingCallbacks(clientId,clientSecret,authenticateAsAppAdminCallbacks)}}(this))};Kii._authenticateAsAppAdminUsingCallbacks=function(clientId,clientSecret,callbacks){var authCallbacks,request;request=new KiiRequest("/oauth2/token",false);request.setAnonymous(true);request.setMethod("POST");request.setData({client_id:clientId,client_secret:clientSecret});authCallbacks={success:function(_this){return function(data){var admin,id,token;token=data.access_token;id=data.id;root.Kii.logger("token: "+token);root.Kii.logger("id: "+id);admin=new root.KiiAppAdminContext({token:token,id:id});if(callbacks!=null){return callbacks.success(admin)}}}(this),failure:function(_this){return function(error,statusCode){root.Kii.logger("error: "+error);root.Kii.logger("statusCode: "+statusCode);if(callbacks!=null){return callbacks.failure(error,statusCode)}}}(this)};return request.execute(authCallbacks,false)};Kii.authenticateAsAdminWithToken=function(token){return new root.KiiAppAdminContext({token:token})};Kii.serverCodeEntry=function(entryName){if(!KiiUtilities._validateServerCodeEntryName(entryName)){throw new root.InvalidArgumentException("entryName is invalid")}return new root.KiiServerCodeEntry(entryName)};Kii.serverCodeEntryWithVersion=function(entryName,version){if(!KiiUtilities._validateServerCodeEntryName(entryName)){throw new root.InvalidArgumentException("entryName is invalid")}if(!KiiUtilities._validateServerCodeEnryVersion(version)){throw new root.InvalidArgumentException("version is invalid")}return new root.KiiServerCodeEntry(entryName,version)};Kii._setHttpRequestType=function(requestType){root.Kii.logger("Set http request as "+requestType);return _instance._httpRequestType=requestType};Kii._getHttpRequestType=function(){return _instance._httpRequestType};Kii._getKiiUtilities=function(){return KiiUtilities};Kii.topicWithName=function(topicName){var puri;if(typeof topicName!=="string"||topicName===""){throw new root.InvalidArgumentException("topicName should not null or empty")}puri=root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID();return new root.KiiTopic(puri,topicName)};Kii.listTopics=function(callbacks,paginationKey){return Kii._listTopics(callbacks,paginationKey)};Kii._listTopics=function(callbacks,paginationKey,context){return new Promise(function(resolve,reject){var listTopicsCallbacks;listTopicsCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments)},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(arguments[0])}};return Kii._listTopicsUsingCallbacks(listTopicsCallbacks,paginationKey,context)})};Kii._listTopicsUsingCallbacks=function(callbacks,paginationKey,context){var listCallbacks,uri,wrapper;uri=root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+"/topics";if(typeof paginationKey==="string"&&paginationKey!==""){uri=uri+"?paginationKey="+encodeURIComponent(paginationKey)}wrapper=KiiXHRWrapperFactory.createXHRWrapper("GET",uri);wrapper.setKiiHeaders();if(context!=null){wrapper.setAuthToken(context._getToken())}else{wrapper.setCurrentUserToken()}listCallbacks={success:function(){var j,json,len,ref,topic,topics;json=JSON.parse(wrapper.xhr.responseText);topics=[];ref=json.topics;for(j=0,len=ref.length;j<len;j++){topic=ref[j];topics.push(Kii.topicWithName(topic.topicID))}return callbacks!=null?callbacks.success(topics,json.paginationKey===void 0?null:json.paginationKey):void 0},failure:function(){var errObj,errString;errString=wrapper.getErrorString("list topics");errObj=KiiUtilities._Error(errString,Kii);return callbacks!=null?callbacks.failure(errObj):void 0}};return wrapper.send(listCallbacks)};Kii.authenticateAsThing=function(vendorThingID,password,callbacks){return new Promise(function(_this){return function(resolve,reject){var errObj,sendCallbacks,wrapper;if(!KiiUtilities._isNonEmptyString(vendorThingID)||!KiiUtilities._isNonEmptyString(password)){errObj=KiiUtilities._Error("vendorThingID or password is invalid");if(callbacks!=null){callbacks.failure(errObj)}reject(errObj);return}wrapper=KiiXHRWrapperFactory.createXHRWrapper("POST",root.Kii.getBaseURL()+"/oauth2/token");wrapper.setKiiHeaders();wrapper.setContentType("application/vnd.kii.OauthTokenRequest+json");sendCallbacks={success:function(){var accessToken,errString,respJson,thingAuthContext,thingID;respJson=JSON.parse(decodeURIComponent(wrapper.xhr.responseText));thingID=respJson.id;accessToken=respJson.access_token;if(thingID!=null&&accessToken!=null){thingAuthContext=new root.KiiThingContext({thingId:thingID,token:accessToken,vendorThingID:vendorThingID});if(callbacks!=null){callbacks.success(thingAuthContext)}return resolve(thingAuthContext)}else{errString=wrapper.getErrorString("invalid format response when authenticate thing ");errObj=KiiUtilities._Error(errString);if(callbacks!=null){callbacks.failure(errObj)}return reject(errObj)}},failure:function(){var errString;errString=wrapper.getErrorString("authenticate as thing");errObj=KiiUtilities._Error(errString);if(callbacks!=null){callbacks.failure(errObj)}return reject(errObj)}};return wrapper.sendData(JSON.stringify({username:"VENDOR_THING_ID:"+vendorThingID,password:password}),sendCallbacks)}}(this))};Kii.authenticateAsThingWithToken=function(thingID,token,callbacks){return new Promise(function(_this){return function(resolve,reject){var errObj,thingAuthContext;if(!KiiUtilities._isNonEmptyString(thingID)||!KiiUtilities._isNonEmptyString(token)){errObj=KiiUtilities._Error("thingID or token is invalid");if(callbacks!=null){callbacks.failure(errObj)}return reject(errObj)}else{thingAuthContext=new root.KiiThingContext({thingId:thingID,token:token});if(callbacks!=null){callbacks.success(thingAuthContext)}return resolve(thingAuthContext)}}}(this))};return Kii}();root._KiiHttpRequestType={jQuery:"jQuery",XMLHttpRequest:"XMLHttpRequest",Titanium:"Titanium"};_Kii=function(){_Kii.prototype._logging=false;_Kii.prototype._baseURL=null;_Kii.prototype._currentUser=null;_Kii.prototype._httpRequestType=null;function _Kii(appID,appKey,site){this._appKey=appKey;this._appID=appID;this._baseURL=site;this._expiresIn=0}return _Kii}();root.KiiACL=function(){function KiiACL(){this._thingWithID=bind(this._thingWithID,this);this._userWithID=bind(this._userWithID,this);this._groupWithID=bind(this._groupWithID,this);this._getRequest=bind(this._getRequest,this);this._saveItr=bind(this._saveItr,this);this._saveUsingCallbacks=bind(this._saveUsingCallbacks,this);this.save=bind(this.save,this);this._getKeyOfEntry=bind(this._getKeyOfEntry,this);this.removeACLEntry=bind(this.removeACLEntry,this);this.putACLEntry=bind(this.putACLEntry,this);this._listACLEntriesUsingCallbacks=bind(this._listACLEntriesUsingCallbacks,this);this.listACLEntries=bind(this.listACLEntries,this);this.aclPath=bind(this.aclPath,this);this._setParent=bind(this._setParent,this);this._entriesMap={}}KiiACL.prototype._setParent=function(_parent){this._parent=_parent};KiiACL.prototype.aclPath=function(){var bucket,bucketName,group,object,objectId,path,stringToRemove,thing,topic,user;if(this._parent instanceof root.KiiObject){object=this._parent;if(object.getBucket().getUser()!=null){user=object.getBucket().getUser()}else if(object.getBucket().getGroup()!=null){group=object.getBucket().getGroup()}else if(object.getBucket().getThing()!=null){thing=object.getBucket().getThing()}bucketName=object.getBucket()._getQualifiedBucketName();objectId=object.getUUID()}else if(this._parent instanceof root.KiiBucket){bucket=this._parent;if(bucket.getUser()!=null){user=bucket.getUser()}else if(bucket.getGroup()!=null){group=bucket.getGroup()}else if(bucket.getThing()!=null){thing=bucket.getThing()}bucketName=bucket._getQualifiedBucketName()}else if(this._parent instanceof root.KiiTopic){topic=this._parent}else{root.Kii.logger("Invalid ACL parent. Must belong to a KiiObject")}path="/";if(group!=null){path+="groups/"+group.getUUID()+"/"}else if(user!=null){path+="users/"+user.getUUID()+"/"}else if(thing!=null){path+="things/"+thing.getThingID()+"/"}if(topic){stringToRemove=root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+"/";if(topic._uri.indexOf(stringToRemove)!==0){path=null}else{path+=topic._uri.substr(stringToRemove.length)+"/acl"}}else{if(objectId!=null){path+="buckets/"+bucketName+"/objects/"+objectId+"/acl"}else{path+="buckets/"+bucketName+"/acl"}}return path};KiiACL.prototype.listACLEntries=function(callbacks){return new Promise(function(_this){return function(resolve,reject){var listACLEntriesCallbacks;listACLEntriesCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments)},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[1],_this))}};return _this._listACLEntriesUsingCallbacks(listACLEntriesCallbacks)}}(this))};KiiACL.prototype._listACLEntriesUsingCallbacks=function(callbacks){var listCallbacks,request;root.Kii.logger("Listing ACL entries");request=this._getRequest({path:this.aclPath(),withApp:true});listCallbacks={success:function(_this){return function(data,statusCode){var action,entity,j,key,len,results,subject,value;if(statusCode<300&&statusCode>=200){results=[];for(key in data){value=data[key];if(key==="WRITE_EXISTING_OBJECT"){action=root.KiiACLAction.KiiACLObjectActionWrite}else if(key==="READ_EXISTING_OBJECT"){action=root.KiiACLAction.KiiACLObjectActionRead}else if(key==="QUERY_OBJECTS_IN_BUCKET"){action=root.KiiACLAction.KiiACLBucketActionQueryObjects}else if(key==="CREATE_OBJECTS_IN_BUCKET"){action=root.KiiACLAction.KiiACLBucketActionCreateObjects}else if(key==="DROP_BUCKET_WITH_ALL_CONTENT"){action=root.KiiACLAction.KiiACLBucketActionDropBucket}else if(key==="READ_OBJECTS_IN_BUCKET"){action=root.KiiACLAction.KiiACLBucketActionReadObjects}else if(key==="SUBSCRIBE_TO_TOPIC"){action=root.KiiACLAction.KiiACLSubscribeToTopic}else if(key==="SEND_MESSAGE_TO_TOPIC"){action=root.KiiACLAction.KiiACLSendMessageToTopic}else{continue}for(j=0,len=value.length;j<len;j++){entity=value[j];if(entity.groupID!=null){subject=_this._groupWithID(entity.groupID)}else if(entity.userID!=null){subject=_this._userWithID(entity.userID)}else if(entity.thingID!=null){subject=_this._thingWithID(entity.thingID)}else{continue}results.push(root.KiiACLEntry.entryWithSubject(subject,action))}}return callbacks.success(_this,results)}else{return callbacks.failure(_this,"Unable to retrieve ACL list")}}}(this),failure:function(_this){return function(error,statusCode){return callbacks.failure(_this,error)}}(this)};return request.execute(listCallbacks,false)};KiiACL.prototype.putACLEntry=function(entry){var key;if(!(entry instanceof root.KiiACLEntry)){throw new root.InvalidArgumentException("invalid entry")}key=this._getKeyOfEntry(entry);return this._entriesMap[key]=entry};KiiACL.prototype.removeACLEntry=function(entry){var key;if(!(entry instanceof root.KiiACLEntry)){throw new root.InvalidArgumentException("invalid entry")}key=this._getKeyOfEntry(entry);return delete this._entriesMap[key]};KiiACL.prototype._getKeyOfEntry=function(entry){var key1,key2,key3;key1=entry.getActionString();key2=entry.getEntityString();key3=entry.getGrant();return key1+"/"+key2+":"+key3};KiiACL.prototype.save=function(callbacks){return new Promise(function(_this){return function(resolve,reject){var saveCallbacks;saveCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments[0])},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[1],_this))}};return _this._saveUsingCallbacks(saveCallbacks)}}(this))};KiiACL.prototype._saveUsingCallbacks=function(callbacks){var keys;root.Kii.logger("SAving acl");if(!this._entriesMap){callbacks.failure(this,"There is no entry to save.");return}keys=Object.keys(this._entriesMap);root.Kii.logger("Saving total entries : "+keys.length);if(keys.length<1){callbacks.failure(this,"There is no entry to save.");return}return this._saveItr(keys,0,callbacks)};KiiACL.prototype._saveItr=function(keys,idx,callbacks){var _errorStr,aclEntry,path,request;aclEntry=this._entriesMap[keys[idx]];path=this.aclPath()+"/"+aclEntry.getActionString()+"/"+aclEntry.getEntityString();root.Kii.logger("Saving single @path: "+path);root.Kii.logger("Saving  entries index : "+idx);request=this._getRequest({path:path,withApp:true});request.setMethod(aclEntry.getGrant()===true?"PUT":"DELETE");_errorStr=null;return request.execute({success:function(_this){return function(data,status,xhr){_this.removeACLEntry(aclEntry);if(idx<keys.length-1){return _this._saveItr(keys,idx+1,callbacks)}else{return callbacks.success(_this)}}}(this),failure:function(_this){return function(errorStr,statusCode,errorCode){return callbacks.failure(_this,errorStr)}}(this)},false)};KiiACL.aclWithParent=function(parent){var acl;acl=new root.KiiACL;acl._setParent(parent);return acl};KiiACL.prototype._getRequest=function(spec){var path,request,withApp;path=spec.path;withApp=spec.withApp;request=new KiiRequest(path,withApp);return request};KiiACL.prototype._groupWithID=function(id){var group;group=root.KiiGroup.groupWithID(id);return group};KiiACL.prototype._userWithID=function(id){if(id==="ANONYMOUS_USER"){return new root.KiiAnonymousUser}else if(id==="ANY_AUTHENTICATED_USER"){return new root.KiiAnyAuthenticatedUser}else{return root.KiiUser.userWithID(id)}};KiiACL.prototype._thingWithID=function(id){return root.KiiThing.thingWithID(id)};return KiiACL}();root.KiiACLAction={KiiACLActionStart:-1,KiiACLBucketActionCreateObjects:0,KiiACLBucketActionQueryObjects:1,KiiACLBucketActionDropBucket:2,KiiACLBucketActionReadObjects:3,KiiACLObjectActionRead:4,KiiACLObjectActionWrite:5,KiiACLSubscribeToTopic:6,KiiACLSendMessageToTopic:7,KiiACLActionEnd:8};root.KiiACLEntry=function(){function KiiACLEntry(){this.getEntityString=bind(this.getEntityString,this);this.getActionString=bind(this.getActionString,this);this.getGrant=bind(this.getGrant,this);this.setGrant=bind(this.setGrant,this);this.getSubject=bind(this.getSubject,this);this.setSubject=bind(this.setSubject,this);this.getAction=bind(this.getAction,this);this.setAction=bind(this.setAction,this);this._action=-1;this._grant=true}KiiACLEntry.prototype.setAction=function(value){if(value>root.KiiACLAction.KiiACLActionStart&&value<root.KiiACLAction.KiiACLActionEnd){return this._action=value}else{throw new root.InvalidACLAction}};KiiACLEntry.prototype.getAction=function(){return this._action};KiiACLEntry.prototype.setSubject=function(value){if(value instanceof root.KiiGroup&&value.getID()!=null||value instanceof root.KiiUser&&value.getID()!=null||value instanceof root.KiiAnyAuthenticatedUser||value instanceof root.KiiAnonymousUser||value instanceof root.KiiThing&&value.getThingID()!=null){return this._subject=value}else{throw new root.InvalidACLSubject}};KiiACLEntry.prototype.getSubject=function(){return this._subject};KiiACLEntry.prototype.setGrant=function(value){if(value===true||value===false){return this._grant=value}else{throw new root.InvalidACLGrant}};KiiACLEntry.prototype.getGrant=function(){return this._grant};KiiACLEntry.entryWithSubject=function(subject,action){var entry;root.Kii.logger("EWS: "+subject+", "+action);entry=new root.KiiACLEntry;entry.setSubject(subject);entry.setAction(action);return entry};KiiACLEntry.prototype.getActionString=function(){var retString;root.Kii.logger("Action: "+this.action);switch(this._action){case root.KiiACLAction.KiiACLBucketActionCreateObjects:retString="CREATE_OBJECTS_IN_BUCKET";break;case root.KiiACLAction.KiiACLBucketActionQueryObjects:retString="QUERY_OBJECTS_IN_BUCKET";break;case root.KiiACLAction.KiiACLBucketActionDropBucket:retString="DROP_BUCKET_WITH_ALL_CONTENT";break;case root.KiiACLAction.KiiACLBucketActionReadObjects:retString="READ_OBJECTS_IN_BUCKET";break;case root.KiiACLAction.KiiACLObjectActionRead:retString="READ_EXISTING_OBJECT";break;case root.KiiACLAction.KiiACLObjectActionWrite:retString="WRITE_EXISTING_OBJECT";break;case root.KiiACLAction.KiiACLSubscribeToTopic:retString="SUBSCRIBE_TO_TOPIC";break;case root.KiiACLAction.KiiACLSendMessageToTopic:retString="SEND_MESSAGE_TO_TOPIC";break;default:return retString}return retString};KiiACLEntry.prototype.getEntityString=function(){var entityId,type;if(this._subject instanceof root.KiiGroup){entityId=this._subject.getUUID();type="GroupID"}else if(this._subject instanceof root.KiiUser){entityId=this._subject.getUUID();type="UserID"}else if(this._subject instanceof root.KiiAnyAuthenticatedUser){type="UserID";entityId="ANY_AUTHENTICATED_USER"}else if(this._subject instanceof root.KiiAnonymousUser){type="UserID";entityId="ANONYMOUS_USER"}else if(this._subject instanceof root.KiiThing){type="ThingID";entityId=this._subject.getThingID()}return type+":"+entityId};return KiiACLEntry}();root.KiiBucket=function(){KiiBucket.prototype._className="KiiBucket";KiiBucket.prototype.getUser=function(){return this._user};KiiBucket.prototype.getGroup=function(){return this._group};KiiBucket.prototype.getThing=function(){return this._thing};KiiBucket.prototype.getBucketName=function(){return this._bucketName};KiiBucket.prototype._setBucketName=function(_bucketName){this._bucketName=_bucketName};KiiBucket.prototype._getQualifiedBucketName=function(){return this._bucketName};KiiBucket.prototype.createObject=function(){return root.KiiObject.objectWithBucket(this,null)};KiiBucket.prototype.createObjectWithType=function(type){return root.KiiObject.objectWithBucket(this,type)};KiiBucket.prototype.createObjectWithID=function(objectID){if(!root.KiiObject.isValidObjectID(objectID)){throw root.InvalidArgumentException("Specified obejctID is invalid.")}return root.KiiObject.objectWithID(this,objectID)};KiiBucket.prototype.acl=function(){return root.KiiACL.aclWithParent(this)};KiiBucket.prototype.executeQuery=function(query,callbacks){return new Promise(function(_this){return function(resolve,reject){var executeQueryCallbacks;executeQueryCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments)},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[1],_this))}};return _this._executeQueryUsingCallbacks(query,executeQueryCallbacks)}}(this))};KiiBucket.prototype._executeQueryUsingCallbacks=function(query,callbacks){var data,executeCallbacks,path,request;path=this._generatePath()+"/query";data={};if(query!=null){data=query._dictValue()}else{data.bucketQuery={clause:root.KiiQuery._emptyDictValue()}}request=this._getRequest({path:path,withApp:true});request.setMethod("POST");request.setContentType("application/vnd.kii.QueryRequest+json");request.setData(data);executeCallbacks={success:function(_this){return function(data,statusCode){var j,len,nextQuery,ref,result,resultSet;if(statusCode<300&&statusCode>=200){resultSet=[];ref=data.results;for(j=0,len=ref.length;j<len;j++){result=ref[j];resultSet.push(_this.objectWithJSON(result))}if(data.nextPaginationKey!=null){nextQuery=new root.KiiQuery(query);nextQuery.setPaginationKey(data.nextPaginationKey)}else{nextQuery=null}if(callbacks!=null){return callbacks.success(query,resultSet,nextQuery)}}else if(callbacks!=null){return callbacks.failure(_this,"Unable to parse response")}}}(this),failure:function(_this){return function(error,statusCode){if(callbacks!=null){return callbacks.failure(_this,error)}}}(this)};return request.execute(executeCallbacks,false)};KiiBucket.prototype.countWithQuery=function(query,callbacks){return new Promise(function(_this){return function(resolve,reject){var countWithQueryCallbacks;countWithQueryCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments)},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[1],_this))}};return _this._countWithQueryUsingCallbacks(query,countWithQueryCallbacks)}}(this))};KiiBucket.prototype._countWithQueryUsingCallbacks=function(query,callbacks){var data,executeCallbacks,path,request;path=this._generatePath()+"/query";data={};if(query!=null){data=query._dictValue()}else{data.bucketQuery={clause:root.KiiQuery._emptyDictValue()};query=root.KiiQuery.queryWithClause()}data.bucketQuery.aggregations=[{type:"COUNT",putAggregationInto:"count_field"}];request=this._getRequest({path:path,withApp:true});request.setMethod("POST");request.setContentType("application/vnd.kii.QueryRequest+json");request.setData(data);executeCallbacks={success:function(_this){return function(data,statusCode){var count;if(statusCode<300&&statusCode>=200){count=data.aggregations.count_field;if(callbacks!=null){return callbacks.success(_this,query,count)}}else if(callbacks!=null){return callbacks.failure(_this,"Unable to parse response")}}}(this),failure:function(_this){return function(error,statusCode){if(callbacks!=null){return callbacks.failure(_this,error)}}}(this)};return request.execute(executeCallbacks,false)};KiiBucket.prototype.count=function(callbacks){var all_query;all_query=root.KiiQuery.queryWithClause();return this.countWithQuery(all_query,callbacks)};KiiBucket.prototype["delete"]=function(callbacks){return new Promise(function(_this){return function(resolve,reject){var deleteCallbacks;deleteCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments[0])},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[1],_this))}};return _this._deleteUsingCallbacks(deleteCallbacks)}}(this))};KiiBucket.prototype._deleteUsingCallbacks=function(callbacks){var executeCallbacks,request;request=this._getRequest({path:this._generatePath(),withApp:true});request.setMethod("DELETE");executeCallbacks={success:function(_this){return function(data,statusCode){if(callbacks!=null){return callbacks.success(_this)}}}(this),failure:function(_this){return function(error,statusCode){if(callbacks!=null){return callbacks.failure(_this,error)}}}(this)};return request.execute(executeCallbacks,true)};function KiiBucket(bucketName,parent){this.objectWithJSON=bind(this.objectWithJSON,this);this._getHttpUri=bind(this._getHttpUri,this);this._generatePath=bind(this._generatePath,this);this._getRequest=bind(this._getRequest,this);this._deleteUsingCallbacks=bind(this._deleteUsingCallbacks,this);this["delete"]=bind(this["delete"],this);this.count=bind(this.count,this);this._countWithQueryUsingCallbacks=bind(this._countWithQueryUsingCallbacks,this);this.countWithQuery=bind(this.countWithQuery,this);this._executeQueryUsingCallbacks=bind(this._executeQueryUsingCallbacks,this);this.executeQuery=bind(this.executeQuery,this);this.acl=bind(this.acl,this);this.createObjectWithID=bind(this.createObjectWithID,this);this.createObjectWithType=bind(this.createObjectWithType,this);this.createObject=bind(this.createObject,this);this._getQualifiedBucketName=bind(this._getQualifiedBucketName,this);this._setBucketName=bind(this._setBucketName,this);this.getBucketName=bind(this.getBucketName,this);this.getThing=bind(this.getThing,this);this.getGroup=bind(this.getGroup,this);this.getUser=bind(this.getUser,this);if(!KiiUtilities._isNonEmptyString(bucketName)){throw root.InvalidArgumentException("Specified bucket name is null or empty.")}this._bucketName=bucketName;if(parent!=null){if(parent instanceof root.KiiGroup){this._group=parent}else if(parent instanceof root.KiiUser){this._user=parent}else if(parent instanceof root.KiiThing){this._thing=parent}}}KiiBucket._bucketWithName=function(bucketName,parent){var bucket;bucket=new root.KiiBucket(bucketName,parent);return bucket};KiiBucket.prototype._getRequest=function(spec){var path,request,withApp;path=spec.path;withApp=spec.withApp;request=new KiiRequest(path,withApp);return request};KiiBucket.prototype._generatePath=function(){var path;if(this._user!=null){path="/users/"+this._user.getUUID()+"/buckets/"+this._getQualifiedBucketName()}else if(this._group!=null){path="/groups/"+this._group.getUUID()+"/buckets/"+this._getQualifiedBucketName()}else if(this._thing!=null){
path="/things/"+this._thing.getThingID()+"/buckets/"+this._getQualifiedBucketName()}else{path="/buckets/"+this._getQualifiedBucketName()}return path};KiiBucket.prototype._getHttpUri=function(){return root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+"/"+this._generatePath()};KiiBucket.prototype.objectWithJSON=function(json){var newobject;newobject=this.createObject();newobject._updateWithJSON(json);return newobject};return KiiBucket}();root.KiiEncryptedBucket=function(superClass){extend(KiiEncryptedBucket,superClass);function KiiEncryptedBucket(bucketName,parent){this._getQualifiedBucketName=bind(this._getQualifiedBucketName,this);if(!KiiUtilities._isNonEmptyString(bucketName)){throw root.InvalidArgumentException("Specified bucket name is null or empty.")}if(root.KiiEncryptedBucket._isEncrypted(bucketName)){KiiEncryptedBucket.__super__.constructor.call(this,bucketName.replace("CRYPTO:",""),parent)}else{KiiEncryptedBucket.__super__.constructor.call(this,bucketName,parent)}}KiiEncryptedBucket.prototype._getQualifiedBucketName=function(){return"CRYPTO:"+this._bucketName};KiiEncryptedBucket._bucketWithName=function(bucketName,parent){var bucket;bucket=new root.KiiEncryptedBucket(bucketName,parent);return bucket};KiiEncryptedBucket._isEncrypted=function(bucketName){var isEncrypted;isEncrypted=bucketName.indexOf("CRYPTO:")===0;return isEncrypted};return KiiEncryptedBucket}(root.KiiBucket);root.KiiEncryptedBucketWithToken=function(superClass){extend(KiiEncryptedBucketWithToken,superClass);function KiiEncryptedBucketWithToken(bucketName,parent,token){this.acl=bind(this.acl,this);this.createObjectWithID=bind(this.createObjectWithID,this);this.createObjectWithType=bind(this.createObjectWithType,this);this.createObject=bind(this.createObject,this);this._getRequest=bind(this._getRequest,this);KiiEncryptedBucketWithToken.__super__.constructor.call(this,bucketName,parent);this._authToken=token}KiiEncryptedBucketWithToken.prototype._getRequest=function(spec){var request;request=KiiEncryptedBucketWithToken.__super__._getRequest.call(this,spec);request.setAdminToken(this._authToken);return request};KiiEncryptedBucketWithToken.prototype.createObject=function(){return root.KiiObjectWithToken.objectWithBucket(this,null,this._authToken)};KiiEncryptedBucketWithToken.prototype.createObjectWithType=function(type){return root.KiiObjectWithToken.objectWithBucket(this,type,this._authToken)};KiiEncryptedBucketWithToken.prototype.createObjectWithID=function(id){return root.KiiObjectWithToken.objectWithID(this,id,this._authToken)};KiiEncryptedBucketWithToken.prototype.acl=function(){var acl;acl=new root.KiiACLWithToken(this,this._authToken);return acl};return KiiEncryptedBucketWithToken}(root.KiiEncryptedBucket);root.KiiBucketWithToken=function(superClass){extend(KiiBucketWithToken,superClass);function KiiBucketWithToken(bucketName,parent,token){this.acl=bind(this.acl,this);this.createObjectWithID=bind(this.createObjectWithID,this);this.createObjectWithType=bind(this.createObjectWithType,this);this.createObject=bind(this.createObject,this);this._getRequest=bind(this._getRequest,this);KiiBucketWithToken.__super__.constructor.call(this,bucketName,parent);this._authToken=token}KiiBucketWithToken.prototype._getRequest=function(spec){var request;request=KiiBucketWithToken.__super__._getRequest.call(this,spec);request.setAdminToken(this._authToken);return request};KiiBucketWithToken.prototype.createObject=function(){return root.KiiObjectWithToken.objectWithBucket(this,null,this._authToken)};KiiBucketWithToken.prototype.createObjectWithType=function(type){return root.KiiObjectWithToken.objectWithBucket(this,type,this._authToken)};KiiBucketWithToken.prototype.createObjectWithID=function(id){return root.KiiObjectWithToken.objectWithID(this,id,this._authToken)};KiiBucketWithToken.prototype.acl=function(){var acl;acl=new root.KiiACLWithToken(this,this._authToken);return acl};return KiiBucketWithToken}(root.KiiBucket);root.KiiGroup=function(){KiiGroup.prototype._getAddMembers=function(){return this._addMembers};KiiGroup.prototype._getRemoveMembers=function(){return this._removeMembers};function KiiGroup(){this._setAuthToken=bind(this._setAuthToken,this);this._getHttpURI=bind(this._getHttpURI,this);this._listTopicsUsingCallbacks=bind(this._listTopicsUsingCallbacks,this);this.listTopics=bind(this.listTopics,this);this.topicWithName=bind(this.topicWithName,this);this._setOwnerFromContext=bind(this._setOwnerFromContext,this);this._userWithID=bind(this._userWithID,this);this._getRequest=bind(this._getRequest,this);this._updateWithJSON=bind(this._updateWithJSON,this);this._getOwnerUsingCallbacks=bind(this._getOwnerUsingCallbacks,this);this.getOwner=bind(this.getOwner,this);this._deleteUsingCallbacks=bind(this._deleteUsingCallbacks,this);this["delete"]=bind(this["delete"],this);this._refreshUsingCallbacks=bind(this._refreshUsingCallbacks,this);this.refresh=bind(this.refresh,this);this._saveWithOwnerUsingCallbacks=bind(this._saveWithOwnerUsingCallbacks,this);this.saveWithOwner=bind(this.saveWithOwner,this);this._saveUsingCallbacks=bind(this._saveUsingCallbacks,this);this.save=bind(this.save,this);this._changeGroupNameUsingCallbacks=bind(this._changeGroupNameUsingCallbacks,this);this.changeGroupName=bind(this.changeGroupName,this);this._changeOwner=bind(this._changeOwner,this);this._saveMembers=bind(this._saveMembers,this);this._getMemberListUsingCallbacks=bind(this._getMemberListUsingCallbacks,this);this.getMemberList=bind(this.getMemberList,this);this._removeMember=bind(this._removeMember,this);this._addMember=bind(this._addMember,this);this.removeUser=bind(this.removeUser,this);this.addUser=bind(this.addUser,this);this.encryptedBucketWithName=bind(this.encryptedBucketWithName,this);this.bucketWithName=bind(this.bucketWithName,this);this.objectURI=bind(this.objectURI,this);this._setOwner=bind(this._setOwner,this);this.getCachedOwner=bind(this.getCachedOwner,this);this._setName=bind(this._setName,this);this.getName=bind(this.getName,this);this.getID=bind(this.getID,this);this._setUUID=bind(this._setUUID,this);this.getUUID=bind(this.getUUID,this);this._setAddMembers=bind(this._setAddMembers,this);this._getRemoveMembers=bind(this._getRemoveMembers,this);this._getAddMembers=bind(this._getAddMembers,this);this._addMembers={};this._removeMembers={}}KiiGroup.prototype._setAddMembers=function(members){var j,len,member,results1;if(members!=null){results1=[];for(j=0,len=members.length;j<len;j++){member=members[j];results1.push(this.addUser(member))}return results1}};KiiGroup.prototype.getUUID=function(){return this._uuid};KiiGroup.prototype._setUUID=function(_uuid){this._uuid=_uuid};KiiGroup.prototype.getID=function(){return this._uuid};KiiGroup.prototype.getName=function(){return this._groupName};KiiGroup.prototype._setName=function(_groupName){this._groupName=_groupName};KiiGroup.prototype.getCachedOwner=function(){return this._owner};KiiGroup.prototype._setOwner=function(_owner){this._owner=_owner};KiiGroup.prototype.objectURI=function(){if(this._uuid!=null){return"kiicloud://groups/"+this._uuid}else{return null}};KiiGroup.registerGroupWithID=function(groupID,groupName,members,callbacks){return new Promise(function(resolve,reject){var ref,ref1,registerGroupWithIDCallbacks;registerGroupWithIDCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments[0])},failure:function(){var error;if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}error=KiiUtilities._Error(arguments[1],arguments[0]);error.addMembersArray=arguments[2];error.removeMembersArray=arguments[3];return reject(error)}};return KiiGroup._registerGroupWithIDUsingCallbacks((ref=root.KiiUser.getCurrentUser())!=null?ref.getAccessToken():void 0,groupID,groupName,(ref1=root.Kii.getCurrentUser())!=null?ref1.getID():void 0,members,registerGroupWithIDCallbacks)})};KiiGroup._registerGroupWithIDUsingCallbacks=function(token,groupID,groupName,owner,members,callbacks){var data,i,j,len,member,memberIDs,requestCallbacks,url,wrapper,xhr;if(!KiiUtilities._isNonEmptyString(groupID)){callbacks.failure(null,"groupID is null or empty",members,null);return}if(!KiiUtilities._validateGroupID(groupID)){callbacks.failure(null,"invalid groupID : "+groupID,members,null);return}if(!KiiUtilities._isNonEmptyString(groupName)){callbacks.failure(null,"groupName is null or empty",members,null);return}if(owner==null){callbacks.failure(null,"owner is null",members,null);return}url=root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+"/groups/"+groupID;wrapper=KiiXHRWrapperFactory.createXHRWrapper("PUT",url);xhr=wrapper.xhr;wrapper.setKiiHeaders();wrapper.setAuthToken(token);wrapper.setContentType("application/vnd.kii.GroupCreationRequest+json");data={};data.name=groupName;data.owner=owner;if(members!=null&&members.length>0){memberIDs=[];for(i=j=0,len=members.length;j<len;i=++j){member=members[i];memberIDs.push(member.getID())}data.members=memberIDs}requestCallbacks={success:function(){var error1,group;try{group=KiiGroup.groupWithNameAndMembers(groupName,members);group._setUUID(groupID);return callbacks.success(group)}catch(error1){return callbacks.failure(null,wrapper.getErrorString("failed to register group."))}},failure:function(){var errString;errString=wrapper.getErrorString("failed to register group.");return callbacks.failure(null,errString,members,null)}};return wrapper.sendData(JSON.stringify(data),requestCallbacks)};KiiGroup.prototype.bucketWithName=function(bucketName){var bucket;bucket=new root.KiiBucket(bucketName,this);return bucket};KiiGroup.prototype.encryptedBucketWithName=function(bucketName){var bucket;bucket=new root.KiiEncryptedBucket(bucketName,this);return bucket};KiiGroup.prototype.addUser=function(member){var userID;if(member==null){root.Kii.logger("Passed member is null");return}if(member.getUUID()==null){root.Kii.logger("Passed member ID is null");return}userID=member.getUUID();if(!(userID in this._addMembers)){this._addMembers[userID]=member}if(userID in this._removeMembers){return delete this._removeMembers[userID]}};KiiGroup.prototype.removeUser=function(member){var userID;if(member==null){root.Kii.logger("Passed member is null");return}if(member.getUUID()==null){root.Kii.logger("Passed member uuid is null");return}userID=member.getUUID();if(!(userID in this._removeMembers)){this._removeMembers[userID]=member}if(userID in this._addMembers){return delete this._addMembers[userID]}};KiiGroup.prototype._addMember=function(member,callback){var memberCallbacks,request;root.Kii.logger("Adding member "+member.getUUID()+" to group "+this._groupName);request=this._getRequest({path:"/groups/"+this._uuid+"/members/"+member.getUUID(),withApp:true});request.setMethod("PUT");memberCallbacks={success:function(_this){return function(data,statusCode){delete _this._addMembers[member.getUUID()];return _this._saveMembers(callback)}}(this),failure:function(_this){return function(error,statusCode){var addMembersArray,removeMembersArray,userID;addMembersArray=function(){var ref,results1;ref=this._addMembers;results1=[];for(userID in ref){member=ref[userID];results1.push(member)}return results1}.call(_this);removeMembersArray=function(){var ref,results1;ref=this._removeMembers;results1=[];for(userID in ref){member=ref[userID];results1.push(member)}return results1}.call(_this);return callback.failure(_this,error,addMembersArray,removeMembersArray)}}(this)};return request.execute(memberCallbacks,false)};KiiGroup.prototype._removeMember=function(member,callback){var removeCallbacks,request;root.Kii.logger("Removing member "+member.getUUID()+" to group "+this._groupName);request=this._getRequest({path:"/groups/"+this._uuid+"/members/"+member.getUUID(),withApp:true});request.setMethod("DELETE");removeCallbacks={success:function(_this){return function(data,statusCode){delete _this._getRemoveMembers()[member.getUUID()];return _this._saveMembers(callback)}}(this),failure:function(_this){return function(error,statusCode){var addMembersArray,removeMembersArray,userID;addMembersArray=function(){var ref,results1;ref=this._addMembers;results1=[];for(userID in ref){member=ref[userID];results1.push(member)}return results1}.call(_this);removeMembersArray=function(){var ref,results1;ref=this._removeMembers;results1=[];for(userID in ref){member=ref[userID];results1.push(member)}return results1}.call(_this);return callback.failure(_this,error,addMembersArray,removeMembersArray)}}(this)};return request.execute(removeCallbacks,false)};KiiGroup.prototype.getMemberList=function(callbacks){return new Promise(function(_this){return function(resolve,reject){var getMemberListCallbacks;getMemberListCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments)},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[1],_this))}};return _this._getMemberListUsingCallbacks(getMemberListCallbacks)}}(this))};KiiGroup.prototype._getMemberListUsingCallbacks=function(callbacks){var listCallbacks,request;root.Kii.logger("Getting member list for group "+this._groupName);request=this._getRequest({path:"/groups/"+this._uuid+"/members",withApp:true});request.setAccept("application/vnd.kii.MembersRetrievalResponse+json");listCallbacks={success:function(_this){return function(data,statusCode){var j,len,member,memberList,members;if(statusCode<300&&statusCode>=200){memberList=[];members=data["members"];for(j=0,len=members.length;j<len;j++){member=members[j];memberList.push(_this._userWithID(member.userID))}if(callbacks!=null){return callbacks.success(_this,memberList)}}else if(callbacks!=null){return callbacks.failure(_this,"Unable to get member list of group")}}}(this),failure:function(_this){return function(error,statusCode){if(callbacks!=null){return callbacks.failure(_this,error)}}}(this)};return request.execute(listCallbacks,false)};KiiGroup.prototype._saveMembers=function(callbacks){var addMemberKeys,removeMemberKeys;addMemberKeys=Object.keys(this._addMembers);removeMemberKeys=Object.keys(this._removeMembers);if(addMemberKeys.length===0&&removeMemberKeys.length===0){callbacks.success(this)}if(addMemberKeys.length>0){this._addMember(this._addMembers[addMemberKeys[0]],callbacks);return}if(removeMemberKeys.length>0){this._removeMember(this._removeMembers[removeMemberKeys[0]],callbacks)}};KiiGroup.prototype._changeOwner=function(owner,callbacks){var data,request,saveCallbacks;request=this._getRequest({path:"/groups/"+this._uuid+"/owner",withApp:true});request.setContentType("application/vnd.kii.GroupOwnerChangeRequest+json");request.setMethod("PUT");data={};data.owner=owner;request.setData(data);saveCallbacks={success:function(_this){return function(data,statusCode){if(statusCode<300&&statusCode>=200){return callbacks.success(_this)}}}(this),failure:function(_this){return function(error,statusCode){if(callbacks!=null){return callbacks.failure(_this,error)}}}(this)};return request.execute(saveCallbacks,false)};KiiGroup.prototype.changeGroupName=function(newName,callbacks){return new Promise(function(_this){return function(resolve,reject){var changeGroupNameCallbacks;changeGroupNameCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments[0])},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[1],_this))}};return _this._changeGroupNameUsingCallbacks(newName,changeGroupNameCallbacks)}}(this))};KiiGroup.prototype._changeGroupNameUsingCallbacks=function(newName,callbacks){var request,saveCallbacks;root.Kii.logger("Saving group: "+this.name);if(this._uuid!=null){request=this._getRequest({path:"/groups/"+this._uuid+"/name",withApp:true});request.setContentType("text/plain");request.setMethod("PUT");request.setData(newName);saveCallbacks={success:function(_this){return function(data,statusCode){if(statusCode<300&&statusCode>=200){_this._setName(newName);if(callbacks!=null){return callbacks.success(_this)}}else if(callbacks!=null){return callbacks.failure(_this,"Unable to change group name - invalid response")}}}(this),failure:function(_this){return function(error,statusCode){if(callbacks!=null){return callbacks.failure(_this,error)}}}(this)};return request.execute(saveCallbacks,true)}else{return callbacks.failure(this,"Invalid group. Save the group on the server before updating the name.")}};KiiGroup.prototype.save=function(callbacks){return new Promise(function(_this){return function(resolve,reject){var saveCallbacks;saveCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments[0])},failure:function(){var error;if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}error=KiiUtilities._Error(arguments[1],_this);error.addMembersArray=arguments[2];error.removeMembersArray=arguments[3];return reject(error)}};return _this._saveUsingCallbacks(saveCallbacks)}}(this))};KiiGroup.prototype._saveUsingCallbacks=function(callbacks){var data,request,saveCallbacks;root.Kii.logger("Saving group: "+this.name);if(this._uuid==null){request=this._getRequest({path:"/groups",withApp:true});request.setContentType("application/vnd.kii.GroupCreationRequest+json");request.setMethod("POST");data={};if(this._groupName!=null){data.name=this._groupName}this._setOwnerFromContext(data);request.setData(data);saveCallbacks={success:function(_this){return function(data,statusCode){if(statusCode<300&&statusCode>=200){_this._setUUID(data.groupID);return _this._saveMembers(callbacks)}}}(this),failure:function(_this){return function(error,statusCode){var addMembersArray,member,removeMembersArray,userID;if(callbacks!=null){addMembersArray=function(){var ref,results1;ref=this._addMembers;results1=[];for(userID in ref){member=ref[userID];results1.push(member)}return results1}.call(_this);removeMembersArray=function(){var ref,results1;ref=this._removeMembers;results1=[];for(userID in ref){member=ref[userID];results1.push(member)}return results1}.call(_this);return callbacks.failure(_this,error,addMembersArray,removeMembersArray)}}}(this)};return request.execute(saveCallbacks,false)}else{return this._saveMembers(callbacks)}};KiiGroup.prototype.saveWithOwner=function(owner,callbacks){return new Promise(function(_this){return function(resolve,reject){var saveCallbacks;saveCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments[0])},failure:function(){var error;if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}error=KiiUtilities._Error(arguments[1],_this);error.addMembersArray=arguments[2];error.removeMembersArray=arguments[3];return reject(error)}};return _this._saveWithOwnerUsingCallbacks(owner,saveCallbacks)}}(this))};KiiGroup.prototype._saveWithOwnerUsingCallbacks=function(owner,callbacks){var data,request,saveCallbacks,saveMemberCallbacks;if(this._uuid==null){request=this._getRequest({path:"/groups",withApp:true});request.setContentType("application/vnd.kii.GroupCreationRequest+json");request.setMethod("POST");data={};if(this._groupName!=null){data.name=this._groupName}data.owner=owner;request.setData(data);saveCallbacks={success:function(_this){return function(data,statusCode){if(statusCode<300&&statusCode>=200){_this._setUUID(data.groupID);return _this._saveMembers(callbacks)}}}(this),failure:function(_this){return function(error,statusCode){var addMembersArray,member,removeMembersArray,userID;if(callbacks!=null){addMembersArray=function(){var ref,results1;ref=this._addMembers;results1=[];for(userID in ref){member=ref[userID];results1.push(member)}return results1}.call(_this);removeMembersArray=function(){var ref,results1;ref=this._removeMembers;results1=[];for(userID in ref){member=ref[userID];results1.push(member)}return results1}.call(_this);return callbacks.failure(_this,error,addMembersArray,removeMembersArray)}}}(this)};return request.execute(saveCallbacks,false)}else{saveMemberCallbacks={success:function(_this){return function(group){return _this._changeOwner(owner,callbacks)}}(this),failure:function(_this){return function(group,error){var addMembersArray,member,removeMembersArray,userID;addMembersArray=function(){var ref,results1;ref=this._addMembers;results1=[];for(userID in ref){member=ref[userID];results1.push(member)}return results1}.call(_this);removeMembersArray=function(){var ref,results1;ref=this._removeMembers;results1=[];for(userID in ref){member=ref[userID];results1.push(member)}return results1}.call(_this);return callbacks.failure(_this,error,addMembersArray,removeMembersArray)}}(this)};return this._saveMembers(saveMemberCallbacks)}};KiiGroup.prototype.refresh=function(callbacks){return new Promise(function(_this){return function(resolve,reject){var refreshCallbacks;refreshCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments[0])},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[1],_this))}};return _this._refreshUsingCallbacks(refreshCallbacks)}}(this))};KiiGroup.prototype._refreshUsingCallbacks=function(callbacks){var refreshCallbacks,request;root.Kii.logger("Refreshing group: "+this._groupName);request=new this._getRequest({path:"/groups/"+this._uuid,withApp:true});request.setAccept("application/vnd.kii.GroupRetrievalResponse+json");refreshCallbacks={success:function(_this){return function(data,statusCode){_this._updateWithJSON(data);if(callbacks!=null){return callbacks.success(_this)}}}(this),failure:function(_this){return function(error,statusCode){if(callbacks!=null){return callbacks.failure(_this,error)}}}(this)};return request.execute(refreshCallbacks,false)};KiiGroup.prototype["delete"]=function(callbacks){return new Promise(function(_this){return function(resolve,reject){var deleteCallbacks;deleteCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments[0])},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[1],_this))}};return _this._deleteUsingCallbacks(deleteCallbacks)}}(this))};KiiGroup.prototype._deleteUsingCallbacks=function(callbacks){var deleteCallbacks,request;root.Kii.logger("Deleting group: "+this._groupName);request=this._getRequest({path:"/groups/"+this._uuid,withApp:true});request.setMethod("DELETE");deleteCallbacks={success:function(_this){return function(data,statusCode){if(statusCode<300&&statusCode>=200&&callbacks!=null){return callbacks.success(_this)}else if(callbacks!=null){return callbacks.failure(_this,"Unable to parse response")}}}(this),failure:function(_this){return function(error,statusCode){if(callbacks!=null){return callbacks.failure(_this,error)}}}(this)};return request.execute(deleteCallbacks,true)};KiiGroup.prototype.getOwner=function(callbacks){return new Promise(function(_this){return function(resolve,reject){var getOwnerCallbacks;getOwnerCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments)},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[1],_this))}};return _this._getOwnerUsingCallbacks(getOwnerCallbacks)}}(this))};KiiGroup.prototype._getOwnerUsingCallbacks=function(callbacks){root.Kii.logger("Getting owner of group "+this._groupName);return this.refresh({success:function(_this){return function(group){if(callbacks!=null){return callbacks.success(group,group.getCachedOwner())}}}(this),failure:function(_this){return function(group,error){if(callbacks!=null){return callbacks.failure(group,error)}}}(this)})};KiiGroup.groupWithName=function(groupName){return root.KiiGroup.groupWithNameAndMembers(groupName,null)};KiiGroup.groupWithNameAndMembers=function(groupName,members){var group;group=new root.KiiGroup;group._setName(groupName);group._setAddMembers(members);return group};KiiGroup.groupWithID=function(groupID){var group;if(groupID==null||groupID===""){throw new root.InvalidArgumentException("groupID should not null or empty")}group=new root.KiiGroup;group._setUUID(groupID);return group};KiiGroup.groupWithURI=function(uri){var compLength,components,group,newURI;group=null;newURI=uri.substr("kiicloud://".length);components=newURI.split("/");compLength=components.length;if(compLength>0){group=new root.KiiGroup;group._setUUID(components[compLength-1])}else{throw new root.InvalidURIException}return group};KiiGroup._groupWithJSON=function(json){var group;group=new root.KiiGroup;if(json.groupID!=null){group._setUUID(json.groupID)}if(json.name!=null){group._setName(json.name)}if(json.owner!=null){group._setOwner(root.KiiUser.userWithID(json.owner))}return group};KiiGroup.prototype._updateWithJSON=function(json){if(json.groupID!=null){this._setUUID(json.groupID)}if(json.name!=null){this._setName(json.name)}else{this._setName(null)}if(json.owner!=null){return this._setOwner(this._userWithID(json.owner))}else{return this._setOwner(null)}};KiiGroup.prototype._getRequest=function(spec){var path,request,withApp;path=spec.path;withApp=spec.withApp;request=new KiiRequest(path,withApp);return request};KiiGroup.prototype._userWithID=function(id){var user;user=root.KiiUser.userWithID(id);return user};KiiGroup.prototype._setOwnerFromContext=function(data){if(root.Kii.getCurrentUser()!=null){this._owner=root.Kii.getCurrentUser();return data.owner=this._owner.getUUID()}};KiiGroup.prototype.topicWithName=function(topicName){var id,puri;if(typeof topicName!=="string"||topicName===""){throw new root.InvalidArgumentException("topicName should not null or empty")}id=this.getID();if(!id){throw"can not instantiate topic from instance which doesn't have ID"}puri=this._getHttpURI();return new root.KiiTopic(puri,topicName)};KiiGroup.prototype.listTopics=function(callbacks,paginationKey){return new Promise(function(_this){return function(resolve,reject){var listTopicsCallbacks;listTopicsCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments)},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(arguments[0])}};return _this._listTopicsUsingCallbacks(listTopicsCallbacks,paginationKey)}}(this))};KiiGroup.prototype._listTopicsUsingCallbacks=function(callbacks,paginationKey){var listCallbacks,uri,wrapper;uri=this._getHttpURI()+"/topics";if(typeof paginationKey==="string"&&paginationKey!==""){uri=uri+"?paginationKey="+encodeURIComponent(paginationKey)}wrapper=KiiXHRWrapperFactory.createXHRWrapper("GET",uri);wrapper.setKiiHeaders();this._setAuthToken(wrapper);listCallbacks={success:function(_this){return function(){var j,json,len,ref,topic,topics;json=JSON.parse(wrapper.xhr.responseText);topics=[];ref=json.topics;for(j=0,len=ref.length;j<len;j++){topic=ref[j];topics.push(_this.topicWithName(topic.topicID))}return callbacks!=null?callbacks.success(topics,json.paginationKey===void 0?null:json.paginationKey):void 0}}(this),failure:function(_this){return function(){var errObj,errString;errString=wrapper.getErrorString("list topics");errObj=KiiUtilities._Error(errString,_this);return callbacks!=null?callbacks.failure(errObj):void 0}}(this)};return wrapper.send(listCallbacks)};KiiGroup.prototype._getHttpURI=function(){return root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+"/groups/"+this.getID()};KiiGroup.prototype._setAuthToken=function(wrapper){return wrapper.setCurrentUserToken()};return KiiGroup}();root.KiiObject=function(){KiiObject.prototype.getUUID=function(){return this._uuid};KiiObject.prototype._setUUID=function(_uuid){this._uuid=_uuid};KiiObject.prototype.getID=function(){return this._uuid};KiiObject.prototype.getCreated=function(){return this._created};KiiObject.prototype._setCreated=function(_created){this._created=_created};KiiObject.prototype.getModified=function(){return this._modified};KiiObject.prototype._setModified=function(_modified){this._modified=_modified};KiiObject.prototype.getObjectType=function(){return this._objectType};KiiObject.prototype._setObjectType=function(_objectType){this._objectType=_objectType};KiiObject.prototype.getBucket=function(){root.Kii.logger("GEtting bucket "+this._bucket);return this._bucket};KiiObject.prototype._setBucket=function(_bucket){this._bucket=_bucket};KiiObject.prototype.getBodyContentType=function(){return this._bodyContentType};KiiObject.prototype._setBodyContentType=function(_bodyContentType){this._bodyContentType=_bodyContentType};function KiiObject(){this._deleteBodyUsingCallbacks=bind(this._deleteBodyUsingCallbacks,this);this.deleteBody=bind(this.deleteBody,this);this._publishBodyExpiresInUsingCallbacks=bind(this._publishBodyExpiresInUsingCallbacks,this);this.publishBodyExpiresIn=bind(this.publishBodyExpiresIn,this);this._publishBodyExpiresAtUsingCallbacks=bind(this._publishBodyExpiresAtUsingCallbacks,this);this.publishBodyExpiresAt=bind(this.publishBodyExpiresAt,this);this._publishBodyUsingCallbacks=bind(this._publishBodyUsingCallbacks,this);this.publishBody=bind(this.publishBody,this);this._downloadBodyUsingCallbacks=bind(this._downloadBodyUsingCallbacks,this);this.downloadBody=bind(this.downloadBody,this);this._uploadBodyUsingCallbacks=bind(this._uploadBodyUsingCallbacks,this);this.uploadBody=bind(this.uploadBody,this);this._moveBodyUsingCallbacks=bind(this._moveBodyUsingCallbacks,this);this.moveBody=bind(this.moveBody,this);this._parseObjectUri=bind(this._parseObjectUri,this);this._userWithID=bind(this._userWithID,this);this._setAuthorizationHeader=bind(this._setAuthorizationHeader,this);this._getToken=bind(this._getToken,this);this._getRequest=bind(this._getRequest,this);this._setETag=bind(this._setETag,this);this._deleteUsingCallbacks=bind(this._deleteUsingCallbacks,this);this["delete"]=bind(this["delete"],this);this._refreshUsingCallbacks=bind(this._refreshUsingCallbacks,this);this.refresh=bind(this.refresh,this);this._saveUsingCallbacks=bind(this._saveUsingCallbacks,this);this.save=bind(this.save,this);this._saveAllFieldsUsingCallbacks=bind(this._saveAllFieldsUsingCallbacks,this);this.saveAllFields=bind(this.saveAllFields,this);this._performUpdate=bind(this._performUpdate,this);this._performSave=bind(this._performSave,this);this._updateWithJSON=bind(this._updateWithJSON,this);this._convertToObjectType=bind(this._convertToObjectType,this);this.objectURI=bind(this.objectURI,this);this.objectACL=bind(this.objectACL,this);this.getGeoPoint=bind(this.getGeoPoint,this);this.setGeoPoint=bind(this.setGeoPoint,this);this.get=bind(this.get,this);this.set=bind(this.set,this);this._getPath=bind(this._getPath,this);this._setBodyContentType=bind(this._setBodyContentType,this);this.getBodyContentType=bind(this.getBodyContentType,this);this._setBucket=bind(this._setBucket,this);this.getBucket=bind(this.getBucket,this);this._setObjectType=bind(this._setObjectType,this);this.getObjectType=bind(this.getObjectType,this);this._setModified=bind(this._setModified,this);this.getModified=bind(this.getModified,this);this._setCreated=bind(this._setCreated,this);this.getCreated=bind(this.getCreated,this);this.getID=bind(this.getID,this);this._setUUID=bind(this._setUUID,this);this.getUUID=bind(this.getUUID,this);this._customInfo={};this._alteredFields=[]}KiiObject.prototype._getPath=function(){var path;if(this._bucket.getUser()!=null){path="/users/"+this._bucket.getUser().getUUID()+"/buckets/"+this._bucket._getQualifiedBucketName()+"/objects/"}else if(this._bucket.getGroup()!=null){path="/groups/"+this._bucket.getGroup().getUUID()+"/buckets/"+this._bucket._getQualifiedBucketName()+"/objects/"}else if(this._bucket.getThing()!=null){path="/things/"+this._bucket.getThing().getThingID()+"/buckets/"+this._bucket._getQualifiedBucketName()+"/objects/"}else{path="/buckets/"+this._bucket._getQualifiedBucketName()+"/objects/"}if(this._uuid!=null){
path+=this._uuid}return path};KiiObject.prototype.set=function(key,value){if(!KiiUtilities._isNonEmptyString(key)||key.indexOf("_")===0){root.Kii.logger("[WARN] Reserved key is used for custom field. key="+key);return}this._customInfo[key]=value;return this._alteredFields.push(key)};KiiObject.prototype.get=function(key){return this._customInfo[key]};KiiObject.prototype.setGeoPoint=function(key,kiiGeoPoint){if(!(kiiGeoPoint instanceof root.KiiGeoPoint)){throw root.InvalidArgumentException("Specified kiiGeoPoint is not an instance of KiiGeoPoint")}this._customInfo[key]=kiiGeoPoint._toDict();return this._alteredFields.push(key)};KiiObject.prototype.getGeoPoint=function(key){var lat,lon,point;point=this._customInfo[key];lat=point.lat;lon=point.lon;return root.KiiGeoPoint.geoPoint(lat,lon)};KiiObject.prototype.objectACL=function(){return root.KiiACL.aclWithParent(this)};KiiObject.prototype.objectURI=function(){var base,uri;base="kiicloud://";if(this._bucket!=null&&this._uuid!=null){uri=base;if(this._bucket.getGroup()!=null){uri+="groups/"+this._bucket.getGroup().getUUID()+"/"}else if(this._bucket.getUser()!=null){uri+="users/"+this._bucket.getUser().getUUID()+"/"}else if(this._bucket.getThing()!=null){uri+="things/"+this._bucket.getThing().getThingID()+"/"}uri+="buckets/"+this._bucket._getQualifiedBucketName()+"/objects/"+this._uuid}return uri};KiiObject.prototype._convertToObjectType=function(contentType){var result;if("application/json"===contentType){return{success:true,type:null}}result=contentType.match(RegExp("$application\\/vnd\\."+root.Kii.getAppID()+"\\.([^\\.])+\\+json"));if(result!=null){return{success:true,type:result}}return{success:false,type:null}};KiiObject.prototype._updateWithJSON=function(json){var key,results1,val;results1=[];for(key in json){val=json[key];if(key==="_id"){if(this._uuid==null){root.Kii.logger("Setting uuid: "+val);results1.push(this._uuid=val)}else{results1.push(void 0)}}else if(key==="_created"){results1.push(this._created=val)}else if(key==="_modified"){results1.push(this._modified=val)}else if(key==="_owner"){results1.push(this._owner=this._userWithID(val))}else if(key==="_dataType"){results1.push(this._objectType=val)}else if(key==="_calculated"){results1.push(this._customInfo[key]=val)}else if(key[0]!=="_"){results1.push(this._customInfo[key]=val)}else if(key==="_version"){results1.push(this._etag=val)}else{results1.push(void 0)}}return results1};KiiObject.prototype._performSave=function(callbacks){var data,path,request,saveCallbacks;path=this._getPath();path=path.slice(0,+(path.length-2)+1||9e9);request=new this._getRequest({path:path,withApp:true});request.setMethod("POST");data=this._customInfo;request.setData(data);if(this._objectType!=null){request.setContentType("application/vnd."+root.Kii.getAppID()+"."+this._objectType+"+json")}saveCallbacks={success:function(_this){return function(data,statusCode,headers){var result;if(statusCode<300&&statusCode>=200){_this._etag=headers["etag"];if(data["objectID"]!=null){_this._uuid=data["objectID"];if(data["createdAt"]!=null){_this._created=data["createdAt"]}if(data["dataType"]!=null){result=_this._convertToObjectType(data["dataType"]);if(result["success"]){_this._objectType=result["type"]}}_this._modified=_this._created;_this._alteredFields=[];if(callbacks!=null){return callbacks.success(_this)}}else{return callbacks.failure(_this,"No objectID response")}}else if(callbacks!=null){return callbacks.failure(_this,"Unable to parse response")}}}(this),failure:function(_this){return function(error,statusCode){if(callbacks!=null){return callbacks.failure(_this,error)}}}(this)};return request.execute(saveCallbacks,false)};KiiObject.prototype._performUpdate=function(patch,callbacks,overwrite){var data,isSaved,j,key,len,path,ref,request,updateCallbacks;path=this._getPath();request=new this._getRequest({path:path,withApp:true});data={};if(patch){request.addHeader("X-HTTP-Method-Override","PATCH");request.setMethod("POST");ref=this._alteredFields;for(j=0,len=ref.length;j<len;j++){key=ref[j];data[key]=this._customInfo[key]}}else{request.setMethod("PUT");data=this._customInfo}request.setData(data);isSaved=this._created>0;if(!overwrite){if(isSaved){if(this._etag==null){callbacks.failure(this,"IllegalState! Call KiiObject#refresh() prior call this method.");return}request.addHeader("If-Match",this._etag)}else{if(patch&&this._etag==null){callbacks.failure(this,"IllegalState! Call KiiObject#refresh() prior call this method.");return}request.addHeader("If-None-Match","*")}}if(this._objectType!=null){request.setContentType("application/vnd."+root.Kii.getAppID()+"."+this._objectType+"+json")}updateCallbacks={success:function(_this){return function(data,statusCode,headers){if(statusCode<300&&statusCode>=200){_this._etag=headers["etag"];if(patch){_this._updateWithJSON(data)}else{if(data["createdAt"]!=null){_this._created=data["createdAt"]}if(data["modifiedAt"]!=null){_this._modified=data["modifiedAt"]}}_this._alteredFields=[];if(callbacks!=null){return callbacks.success(_this)}}else if(callbacks!=null){return callbacks.failure(_this,"Unable to parse response")}}}(this),failure:function(_this){return function(error,statusCode){if(callbacks!=null){return callbacks.failure(_this,error)}}}(this)};return request.execute(updateCallbacks,false)};KiiObject.prototype.saveAllFields=function(callbacks,overwrite){if(overwrite==null){overwrite=true}return new Promise(function(_this){return function(resolve,reject){var saveCallbacks;saveCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments[0])},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[1],_this))}};return _this._saveAllFieldsUsingCallbacks(saveCallbacks,overwrite)}}(this))};KiiObject.prototype._saveAllFieldsUsingCallbacks=function(callbacks,overwrite){if(overwrite==null){overwrite=true}if(this._uuid!=null){return this._performUpdate(false,callbacks,overwrite)}else{return this._performSave(callbacks)}};KiiObject.prototype.save=function(callbacks,overwrite){if(overwrite==null){overwrite=true}return new Promise(function(_this){return function(resolve,reject){var saveCallbacks;saveCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments[0])},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[1],_this))}};return _this._saveUsingCallbacks(saveCallbacks,overwrite)}}(this))};KiiObject.prototype._saveUsingCallbacks=function(callbacks,overwrite){if(overwrite==null){overwrite=true}if(this._uuid!=null){return this._performUpdate(true,callbacks,overwrite)}else{return this._performSave(callbacks)}};KiiObject.prototype.refresh=function(callbacks){return new Promise(function(_this){return function(resolve,reject){var refreshCallbacks;refreshCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments[0])},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[1],_this))}};return _this._refreshUsingCallbacks(refreshCallbacks)}}(this))};KiiObject.prototype._refreshUsingCallbacks=function(callbacks){var path,refreshCallbacks,request;path=this._getPath();request=new this._getRequest({path:path,withApp:true});refreshCallbacks={success:function(_this){return function(data,statusCode,headers){if(statusCode<300&&statusCode>=200){_this._etag=headers["etag"];_this._updateWithJSON(data);if(callbacks!=null){return callbacks.success(_this)}}else if(callbacks!=null){return callbacks.failure(_this,"Unable to parse response")}}}(this),failure:function(_this){return function(error,statusCode){if(callbacks!=null){return callbacks.failure(_this,error)}}}(this)};return request.execute(refreshCallbacks,false)};KiiObject.prototype["delete"]=function(callbacks){return new Promise(function(_this){return function(resolve,reject){var deleteCallbacks;deleteCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments[0])},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[1],_this))}};return _this._deleteUsingCallbacks(deleteCallbacks)}}(this))};KiiObject.prototype._deleteUsingCallbacks=function(callbacks){var path,refreshCallbacks,request;path=this._getPath();request=new this._getRequest({path:path,withApp:true});request.setMethod("DELETE");refreshCallbacks={success:function(_this){return function(data,statusCode){if(statusCode<300&&statusCode>=200&&callbacks!=null){return callbacks.success(_this)}else if(callbacks!=null){return callbacks.failure(_this,"Unable to parse response")}}}(this),failure:function(_this){return function(error,statusCode){if(callbacks!=null){return callbacks.failure(_this,error)}}}(this)};return request.execute(refreshCallbacks,true)};KiiObject.objectWithBucket=function(bucket,type){var obj;root.Kii.logger("Creating object w type: "+type);obj=new root.KiiObject;obj._setBucket(bucket);obj._setObjectType(type);root.Kii.logger(obj);return obj};KiiObject.objectWithID=function(bucket,objectID){var obj;root.Kii.logger("Creating object with id: "+objectID);obj=new root.KiiObject;obj._setBucket(bucket);obj._setUUID(objectID);root.Kii.logger(obj);return obj};KiiObject.prototype._setETag=function(_etag){this._etag=_etag};KiiObject.objectWithURI=function(uri){var bucket,bucketIndex,bucketName,compLength,components,newURI,obj,subject;newURI=uri.substr("kiicloud://".length);components=newURI.split("/");compLength=components.length;root.Kii.logger(components);if(compLength>=4){bucketIndex=compLength===4?1:3;bucketName=components[bucketIndex];subject=null;if(components[0]==="groups"){subject=new root.KiiGroup.groupWithID(components[1])}else if(components[0]==="users"){subject=root.KiiUser.userWithID(components[1])}else if(components[0]==="things"){subject=root.KiiThing.thingWithID(components[1])}bucket=null;if(root.KiiEncryptedBucket._isEncrypted(bucketName)){bucket=new root.KiiEncryptedBucket._bucketWithName(bucketName,subject)}else{bucket=new root.KiiBucket._bucketWithName(bucketName,subject)}root.Kii.logger(bucket);obj=bucket.createObject();obj._setUUID(components[compLength-1]);root.Kii.logger(obj)}else{throw new root.InvalidURIException}return obj};KiiObject.prototype._getRequest=function(spec){var path,request,withApp;path=spec.path;withApp=spec.withApp;request=new KiiRequest(path,withApp);return request};KiiObject.prototype._getToken=function(){var currUser,token;currUser=root.KiiUser.getCurrentUser();token=currUser?currUser.getAccessToken():null;if(token){return token}else{return null}};KiiObject.prototype._setAuthorizationHeader=function(xhr){var token;token=this._getToken();if(token){return xhr.setRequestHeader("Authorization","Bearer "+token)}};KiiObject.prototype._userWithID=function(id){var user;user=root.KiiUser.userWithID(id);return user};KiiObject.prototype._parseObjectUri=function(uri){var data,targetData,uriElement,uriPrefix;uriElement=uri.replace(/^kiicloud:\/\//g,"").split("/");uriPrefix=uriElement[0];if(uriPrefix==="users"){targetData={appID:root.Kii.getAppID(),userID:uriElement[1],type:"APP_AND_USER"};if(root.KiiEncryptedBucket._isEncrypted(uriElement[3])){data={targetObjectScope:targetData,targetBucketType:"crypto",targetBucketID:uriElement[3].replace("CRYPTO:",""),targetObjectID:uriElement[5]}}else{data={targetObjectScope:targetData,targetBucketID:uriElement[3],targetObjectID:uriElement[5]}}}else if(uriPrefix==="groups"){targetData={appID:root.Kii.getAppID(),groupID:uriElement[1],type:"APP_AND_GROUP"};if(root.KiiEncryptedBucket._isEncrypted(uriElement[3])){data={targetObjectScope:targetData,targetBucketType:"crypto",targetBucketID:uriElement[3].replace("CRYPTO:",""),targetObjectID:uriElement[5]}}else{data={targetObjectScope:targetData,targetBucketID:uriElement[3],targetObjectID:uriElement[5]}}}else if(uriPrefix==="things"){throw new root.InvalidURIException}else{targetData={appID:root.Kii.getAppID(),type:"APP"};if(root.KiiEncryptedBucket._isEncrypted(uriElement[1])){data={targetObjectScope:targetData,targetBucketType:"crypto",targetBucketID:uriElement[1].replace("CRYPTO:",""),targetObjectID:uriElement[3]}}else{data={targetObjectScope:targetData,targetBucketID:uriElement[1],targetObjectID:uriElement[3]}}}return data};KiiObject.prototype.moveBody=function(targetObjectUri,callbacks){return new Promise(function(_this){return function(resolve,reject){var moveBodyCallbacks;moveBodyCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments)},failure:function(){var error;if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}error=KiiUtilities._Error(arguments[2],_this);error.targetObjectUri=arguments[1];return reject(error)}};return _this._moveBodyUsingCallbacks(targetObjectUri,moveBodyCallbacks)}}(this))};KiiObject.prototype._moveBodyUsingCallbacks=function(targetObjectUri,callbacks){var error1,errorMessage,moveCallbacks,path,request;if(targetObjectUri==null){return callbacks.failure(this,null,root.InvalidArgumentException("targetObjectUri is required"))}if(this.getUUID()==null){return callbacks.failure(this,targetObjectUri,root.InvalidArgumentException("Source object is not saved on the cloud"))}path=this._getPath()+"/body/move";request=new this._getRequest({path:path,withApp:true});request.setMethod("POST");request.setContentType("application/vnd.kii.ObjectBodyMoveRequest+json");try{request.setData(this._parseObjectUri(targetObjectUri))}catch(error1){errorMessage=error1;return callbacks.failure(this,targetObjectUri,"Not support to move body of thing scope object.")}moveCallbacks={success:function(_this){return function(data,statusCode){if(statusCode<300&&statusCode>=200&&callbacks!=null){return callbacks.success(_this,targetObjectUri)}else if(callbacks!=null){return callbacks.failure(_this,targetObjectUri,"Unable to parse response")}}}(this),failure:function(_this){return function(error,statusCode){if(callbacks!=null){return callbacks.failure(_this,targetObjectUri,error)}}}(this)};return request.execute(moveCallbacks,true)};KiiObject.prototype.uploadBody=function(srcDataBlob,callbacks){return new Promise(function(_this){return function(resolve,reject){var uploadBodyCallbacks;uploadBodyCallbacks={success:function(){var ref;if(callbacks!=null){if((ref=callbacks.success)!=null){ref.apply(callbacks,arguments)}}return resolve(arguments[0])},failure:function(){var ref;if(callbacks!=null){if((ref=callbacks.failure)!=null){ref.apply(callbacks,arguments)}}return reject(KiiUtilities._Error(arguments[1],_this))},progress:function(){var ref;return callbacks!=null?(ref=callbacks.progress)!=null?ref.apply(callbacks,arguments):void 0:void 0}};return _this._uploadBodyUsingCallbacks(srcDataBlob,uploadBodyCallbacks)}}(this))};KiiObject.prototype._uploadBodyUsingCallbacks=function(srcDataBlob,callbacks){var contentType,requestCallback,url,wrapper,xhr;if(!srcDataBlob||!(srcDataBlob instanceof Blob)){callbacks.failure(this,"Invalid parameter");return}url=root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+this._getPath()+"/body";contentType="application/octet-stream";if(srcDataBlob.type){contentType=srcDataBlob.type}wrapper=KiiXHRWrapperFactory.createXHRWrapper("PUT",url);xhr=wrapper.xhr;xhr.setRequestHeader("Content-Type",contentType);xhr.setRequestHeader("x-kii-appid",root.Kii.getAppID());xhr.setRequestHeader("x-kii-appkey",root.Kii.getAppKey());xhr.setRequestHeader("x-kii-sdk",root.KiiSDKClientInfo.getSDKClientInfo());this._setAuthorizationHeader(xhr);requestCallback={success:function(_this){return function(){var json;json=JSON.parse(xhr.responseText);if(json["modifiedAt"]!=null){_this._modified=json["modifiedAt"]}_this._setBodyContentType(contentType);if(callbacks!=null){return callbacks.success(_this)}}}(this),failure:function(_this){return function(){var errString,error1,json;errString="failed to upload body. statusCode: "+xhr.status;if(callbacks!=null){try{json=JSON.parse(decodeURIComponent(xhr.responseText));if(json.errorCode!=null){errString+=" error code: "+json.errorCode}if(json.message!=null){return errString+=" message: "+json.message}}catch(error1){}finally{root.Kii.logger("Failure: "+errString);root.Kii.logger(xhr.responseText);callbacks.failure(_this,errString)}}}}(this),progress:function(_this){return function(event){if(callbacks&&callbacks.progress){return callbacks.progress(event)}}}(this)};return wrapper.sendData(srcDataBlob,requestCallback)};KiiObject.prototype.downloadBody=function(callbacks){return new Promise(function(_this){return function(resolve,reject){var downloadBodyCallbacks;downloadBodyCallbacks={success:function(){var ref;if(callbacks!=null){if((ref=callbacks.success)!=null){ref.apply(callbacks,arguments)}}return resolve(arguments)},failure:function(){var ref;if(callbacks!=null){if((ref=callbacks.failure)!=null){ref.apply(callbacks,arguments)}}return reject(KiiUtilities._Error(arguments[1],_this))},progress:function(){var ref;return callbacks!=null?(ref=callbacks.progress)!=null?ref.apply(callbacks,arguments):void 0:void 0}};return _this._downloadBodyUsingCallbacks(downloadBodyCallbacks)}}(this))};KiiObject.prototype._downloadBodyUsingCallbacks=function(callbacks){var requestCallback,url,wrapper,xhr;url=root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+this._getPath()+"/body";wrapper=KiiXHRWrapperFactory.createXHRWrapper("GET",url);xhr=wrapper.xhr;xhr.setRequestHeader("x-kii-appid",root.Kii.getAppID());xhr.setRequestHeader("x-kii-appkey",root.Kii.getAppKey());xhr.setRequestHeader("x-kii-sdk",root.KiiSDKClientInfo.getSDKClientInfo());this._setAuthorizationHeader(xhr);xhr.responseType="blob";requestCallback={success:function(_this){return function(){var statusCode;statusCode=xhr.status;_this._setBodyContentType(xhr.getResponseHeader("content-type"));if(callbacks!=null){return callbacks.success(_this,xhr.response)}}}(this),failure:function(_this){return function(){var errString,fileReader,obj,responseText;if(callbacks!=null){errString="failed to download body. statusCode: "+xhr.status;fileReader=new FileReader;responseText=null;obj=_this;fileReader.onload=function(){var error1,json;responseText=this.result;try{json=JSON.parse(decodeURIComponent(responseText));if(json.errorCode!=null){errString+=" error code: "+json.errorCode}if(json.message!=null){return errString+=" message: "+json.message}}catch(error1){}finally{root.Kii.logger("Failure: "+errString);root.Kii.logger(xhr.response);callbacks.failure(obj,errString)}};return fileReader.readAsText(xhr.response)}}}(this),progress:function(_this){return function(event){if(callbacks&&callbacks.progress){return callbacks.progress(event)}}}(this)};return wrapper.send(requestCallback)};KiiObject.prototype.publishBody=function(callbacks){return new Promise(function(_this){return function(resolve,reject){var publishBodyCallbacks;publishBodyCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments)},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[1],_this))}};return _this._publishBodyUsingCallbacks(publishBodyCallbacks)}}(this))};KiiObject.prototype._publishBodyUsingCallbacks=function(callbacks){var jsonBody,requestBody,requestCallbacks,url,wrapper,xhr;url=root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+this._getPath()+"/body/publish";wrapper=KiiXHRWrapperFactory.createXHRWrapper("POST",url);xhr=wrapper.xhr;xhr.setRequestHeader("x-kii-appid",root.Kii.getAppID());xhr.setRequestHeader("x-kii-appkey",root.Kii.getAppKey());xhr.setRequestHeader("x-kii-sdk",root.KiiSDKClientInfo.getSDKClientInfo());xhr.setRequestHeader("Content-Type","application/vnd.kii.ObjectBodyPublicationRequest+json");this._setAuthorizationHeader(xhr);requestCallbacks={success:function(_this){return function(){var error1,json;if(callbacks!=null){try{json=JSON.parse(xhr.responseText);if(json.url){return callbacks.success(_this,json.url)}else{return callbacks.failure(_this,"failed to parse response")}}catch(error1){return callbacks.failure(_this,"failed to parse response")}}}}(this),failure:function(_this){return function(){var errString,error1,json;if(callbacks!=null){errString="failed to publish body. statusCode: "+xhr.status;try{json=JSON.parse(xhr.responseText);if(json.errorCode!=null){errString+=" error code: "+json.errorCode}if(json.message!=null){return errString+=" error message: "+json.message}}catch(error1){}finally{callbacks.failure(_this,errString)}}}}(this)};requestBody={};jsonBody=JSON.stringify(requestBody);return wrapper.sendData(jsonBody,requestCallbacks)};KiiObject.prototype.publishBodyExpiresAt=function(expiresAt,callbacks){return new Promise(function(_this){return function(resolve,reject){var publishBodyExpiresAtCallbacks;publishBodyExpiresAtCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments)},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[1],_this))}};return _this._publishBodyExpiresAtUsingCallbacks(expiresAt,publishBodyExpiresAtCallbacks)}}(this))};KiiObject.prototype._publishBodyExpiresAtUsingCallbacks=function(expiresAt,callbacks){var jsonBody,requestBody,requestCallbacks,url,wrapper,xhr;url=root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+this._getPath()+"/body/publish";wrapper=KiiXHRWrapperFactory.createXHRWrapper("POST",url);xhr=wrapper.xhr;xhr.setRequestHeader("x-kii-appid",root.Kii.getAppID());xhr.setRequestHeader("x-kii-appkey",root.Kii.getAppKey());xhr.setRequestHeader("x-kii-sdk",root.KiiSDKClientInfo.getSDKClientInfo());xhr.setRequestHeader("Content-Type","application/vnd.kii.ObjectBodyPublicationRequest+json");this._setAuthorizationHeader(xhr);requestCallbacks={success:function(_this){return function(){var error1,json;if(callbacks!=null){try{json=JSON.parse(xhr.responseText);if(json.url){return callbacks.success(_this,json.url)}else{return callbacks.failure(_this,"failed to parse response")}}catch(error1){return callbacks.failure(_this,"failed to parse response")}}}}(this),failure:function(_this){return function(){var errString,error1,json;if(callbacks!=null){errString="failed to publish body. statusCode: "+xhr.status;if(xhr.responseText==null){callbacks.failure(_this,errString);retunr}try{json=JSON.parse(xhr.responseText);if(json.errorCode!=null){errString+=" error code: "+json.errorCode}if(json.message!=null){return errString+=" error message: "+json.message}}catch(error1){}finally{callbacks.failure(_this,errString)}}}}(this)};requestBody={};requestBody.expiresAt=expiresAt;jsonBody=JSON.stringify(requestBody);return wrapper.sendData(jsonBody,requestCallbacks)};KiiObject.prototype.publishBodyExpiresIn=function(expiresIn,callbacks){return new Promise(function(_this){return function(resolve,reject){var publishBodyExpiresInCallbacks;publishBodyExpiresInCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments)},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[1],_this))}};return _this._publishBodyExpiresInUsingCallbacks(expiresIn,publishBodyExpiresInCallbacks)}}(this))};KiiObject.prototype._publishBodyExpiresInUsingCallbacks=function(expiresIn,callbacks){var jsonBody,requestBody,requestCallbacks,url,wrapper,xhr;url=root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+this._getPath()+"/body/publish";wrapper=KiiXHRWrapperFactory.createXHRWrapper("POST",url);xhr=wrapper.xhr;xhr.setRequestHeader("x-kii-appid",root.Kii.getAppID());xhr.setRequestHeader("x-kii-appkey",root.Kii.getAppKey());xhr.setRequestHeader("x-kii-sdk",root.KiiSDKClientInfo.getSDKClientInfo());xhr.setRequestHeader("Content-Type","application/vnd.kii.ObjectBodyPublicationRequest+json");this._setAuthorizationHeader(xhr);requestCallbacks={success:function(_this){return function(){var error1,json;try{json=JSON.parse(xhr.responseText);if(json.url){return callbacks.success(_this,json.url)}else{return callbacks.failure(_this,"failed to parse response")}}catch(error1){return callbacks.failure(_this,"failed to parse response")}}}(this),failure:function(_this){return function(){var errString,error1,json;errString="failed to publish body. statusCode: "+xhr.status;try{json=JSON.parse(xhr.responseText);if(json.errorCode!=null){errString+=" error code: "+json.errorCode}if(json.message!=null){return errString+=" error message: "+json.message}}catch(error1){}finally{callbacks.failure(_this,errString)}}}(this)};requestBody={};requestBody.expiresIn=expiresIn;jsonBody=JSON.stringify(requestBody);return wrapper.sendData(jsonBody,requestCallbacks)};KiiObject.prototype.deleteBody=function(callbacks){return new Promise(function(_this){return function(resolve,reject){var deleteBodyCallbacks;deleteBodyCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments[0])},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[1],_this))}};return _this._deleteBodyUsingCallbacks(deleteBodyCallbacks)}}(this))};KiiObject.prototype._deleteBodyUsingCallbacks=function(callbacks){var requestCallbacks,url,wrapper,xhr;url=root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+this._getPath()+"/body";wrapper=KiiXHRWrapperFactory.createXHRWrapper("DELETE",url);xhr=wrapper.xhr;xhr.setRequestHeader("x-kii-appid",root.Kii.getAppID());xhr.setRequestHeader("x-kii-appkey",root.Kii.getAppKey());xhr.setRequestHeader("x-kii-sdk",root.KiiSDKClientInfo.getSDKClientInfo());this._setAuthorizationHeader(xhr);requestCallbacks={success:function(_this){return function(){_this._setBodyContentType(null);if(callbacks!=null){return callbacks.success(_this)}}}(this),failure:function(_this){return function(){var errString,error1,json;if(callbacks!=null){errString="failed to delete body. statusCode: "+xhr.status;try{json=JSON.parse(xhr.responseText);if(json.errorCode!=null){errString+=" error code: "+json.errorCode}if(json.message!=null){return errString+=" error message: "+json.message}}catch(error1){}finally{callbacks.failure(_this,errString)}}}}(this)};return wrapper.send(requestCallbacks)};KiiObject.isValidObjectID=function(objectID){var pattern;pattern=/^[a-zA-Z0-9-_.]{2,100}$/i;if((typeof objectID).toLowerCase()!=="string"){return false}else if(objectID.match(pattern)!==null){return true}else{return false}};return KiiObject}();root.KiiQuery=function(){function KiiQuery(query){this._dictValue=bind(this._dictValue,this);this.sortByAsc=bind(this.sortByAsc,this);this.sortByDesc=bind(this.sortByDesc,this);this.setLimit=bind(this.setLimit,this);this.getLimit=bind(this.getLimit,this);this._setClause=bind(this._setClause,this);this.setPaginationKey=bind(this.setPaginationKey,this);this.getPaginationKey=bind(this.getPaginationKey,this);this._clone=bind(this._clone,this);return this._clone(query)}KiiQuery.prototype._clone=function(obj){var key,newInstance;if(obj==null||typeof obj!=="object"){return obj}newInstance=new obj.constructor;for(key in obj){newInstance[key]=this._clone(obj[key])}return newInstance};KiiQuery.prototype.getPaginationKey=function(){return this._paginationKey};KiiQuery.prototype.setPaginationKey=function(_paginationKey){this._paginationKey=_paginationKey};KiiQuery.prototype._setClause=function(_clause){this._clause=_clause};KiiQuery.prototype.getLimit=function(){return this._limit};KiiQuery.prototype.setLimit=function(value){if(value>0){return this._limit=value}else{throw new root.InvalidLimitException}};KiiQuery.queryWithClause=function(clause){var query;query=new root.KiiQuery;query._setClause(clause);return query};KiiQuery.prototype.sortByDesc=function(_sortField){this._sortField=_sortField;return this._sortDescending=true};KiiQuery.prototype.sortByAsc=function(_sortField){this._sortField=_sortField;return this._sortDescending=false};KiiQuery._emptyDictValue=function(){return{type:"all"}};KiiQuery.prototype._dictValue=function(){var bucketQuery,data;data={};data.bestEffortLimit=this._limit;if(this._paginationKey!=null){data.paginationKey=this._paginationKey}bucketQuery={descending:this._sortDescending};if(this._clause!=null){bucketQuery.clause=this._clause._getDictValue()}else{bucketQuery.clause=root.KiiQuery._emptyDictValue()}if(this._sortField!=null){bucketQuery.orderBy=this._sortField}data.bucketQuery=bucketQuery;return data};return KiiQuery}();root.KiiClause=function(){function KiiClause(){this._getDictValue=bind(this._getDictValue,this);this._setDictValue=bind(this._setDictValue,this);this._setWhereClauses=bind(this._setWhereClauses,this);this._setWhereType=bind(this._setWhereType,this)}KiiClause.constructor=function(){KiiClause._whereClauses=[];return KiiClause._dictExpression={}};KiiClause.prototype._setWhereType=function(_whereType){this._whereType=_whereType};KiiClause.prototype._setWhereClauses=function(_whereClauses){this._whereClauses=_whereClauses};KiiClause.prototype._setDictValue=function(_dictExpression){this._dictExpression=_dictExpression};KiiClause.prototype._getDictValue=function(){var clause,clauses,j,len,ref,retDict;retDict={};if(this._whereClauses!=null&&this._whereType!=null){clauses=[];if(this._whereClauses.length===1){clause=this._whereClauses[0];if(this._whereType==="not"){retDict={type:this._whereType,clause:clause._getDictValue()}}else{retDict=clause._getDictValue()}}else{ref=this._whereClauses;for(j=0,len=ref.length;j<len;j++){clause=ref[j];clauses.push(clause._getDictValue())}retDict={type:this._whereType,clauses:clauses}}}else if(this._whereClauses!=null){if(this._whereClauses.length>0){retDict=this._whereClauses[0]._getDictValue()}}else if(this._dictExpression!=null){retDict=this._dictExpression}if(retDict==null){retDict=root.KiiQuery.emptyDictValue()}return retDict};KiiClause.createWithWhere=function(whereType,whereClauses){var expression;expression=new root.KiiClause;expression._setWhereType(whereType);expression._setWhereClauses(whereClauses);return expression};KiiClause.create=function(operator,key,value){var _dict,expression;expression=new root.KiiClause;_dict={};if(operator==="="){_dict.type="eq";_dict.field=key;_dict.value=value}else if(operator==="<"){_dict.type="range";_dict.field=key;_dict.upperLimit=value;_dict.upperIncluded=false}else if(operator==="<="){_dict.type="range";_dict.field=key;_dict.upperLimit=value;_dict.upperIncluded=true}else if(operator===">"){_dict.type="range";_dict.field=key;_dict.lowerLimit=value;_dict.lowerIncluded=false}else if(operator===">="){_dict.type="range";_dict.field=key;_dict.lowerLimit=value;_dict.lowerIncluded=true}else if(operator==="in"){_dict.type="in";_dict.field=key;_dict.values=value}else if(operator==="prefix"){_dict.type="prefix";_dict.field=key;_dict.prefix=value}expression._setDictValue(_dict);return expression};KiiClause.and=function(){return KiiClause.createWithWhere("and",arguments)};KiiClause.or=function(){return KiiClause.createWithWhere("or",arguments)};KiiClause.equals=function(key,value){if(value._className!=null){value=value.objectURI}return root.KiiClause.create("=",key,value)};KiiClause.notEquals=function(key,value){if(value._className!=null){value=value.objectURI}return root.KiiClause.createWithWhere("not",[root.KiiClause.equals(key,value)])};KiiClause.greaterThan=function(key,value){return root.KiiClause.create(">",key,value)};KiiClause.greaterThanOrEqual=function(key,value){return root.KiiClause.create(">=",key,value)};KiiClause.lessThan=function(key,value){return root.KiiClause.create("<",key,value)};KiiClause.lessThanOrEqual=function(key,value){return root.KiiClause.create("<=",key,value)};KiiClause["in"]=function(key,values){return root.KiiClause.create("in",key,values);
};KiiClause.inClause=function(key,values){return root.KiiClause.create("in",key,values)};KiiClause.startsWith=function(key,value){return root.KiiClause.create("prefix",key,value)};KiiClause.geoDistance=function(key,center,radius,putDistanceInto){var _dict,expression,isValidGeoPoint,isValidString,pattern;isValidString=function(str){return typeof str==="string"&&str.length>0};isValidGeoPoint=function(point){if(point==null){return false}return point instanceof root.KiiGeoPoint};if(!isValidString(key)){throw root.InvalidArgumentException("Specified key is not a string or is an empty string.")}if(!isValidGeoPoint(center)){throw root.InvalidArgumentException("center is not a reference of KiiGeoPoint.")}pattern="^[a-zA-Z_][a-zA-Z0-9_]*$";if(putDistanceInto!=null&&!putDistanceInto.match(pattern)){throw root.InvalidArgumentException("putDistanceInto is invalid.")}if(radius<=0||radius>2e7||isNaN(radius)){throw root.InvalidArgumentException("radius is invalid.")}expression=new root.KiiClause;_dict={};_dict.type="geodistance";_dict.field=key;center=center._toDict();_dict.center=center;_dict.radius=radius;_dict.putDistanceInto=putDistanceInto;expression._setDictValue(_dict);return expression};KiiClause.geoBox=function(key,northEast,southWest){var _dict,expression,isValidGeoPoint,isValidKey,ne,sw;isValidKey=function(key){return typeof key==="string"&&key.length>0};isValidGeoPoint=function(point){if(point==null){return false}return point instanceof root.KiiGeoPoint};if(!isValidKey(key)){throw root.InvalidArgumentException("Specified key is not a string or is an empty string.")}if(!isValidGeoPoint(northEast)||!isValidGeoPoint(southWest)){throw root.InvalidArgumentException("northEast or southWest is not a reference of KiiGeoPoint.")}expression=new root.KiiClause;_dict={};_dict.type="geobox";_dict.field=key;ne=northEast._toDict();sw=southWest._toDict();_dict.box={ne:ne,sw:sw};expression._setDictValue(_dict);return expression};return KiiClause}();KiiRequest=function(){KiiRequest.prototype.getPath=function(){return this._path};KiiRequest.prototype.setPath=function(_path){this._path=_path};KiiRequest.prototype.getMethod=function(){return this._method};KiiRequest.prototype.setMethod=function(_method){this._method=_method};KiiRequest.prototype.getHeaders=function(){return this._headers};KiiRequest.prototype.setHeaders=function(_headers){this._headers=_headers};KiiRequest.prototype.getData=function(){return this._data};KiiRequest.prototype.setData=function(_data){this._data=_data};KiiRequest.prototype.getContentType=function(){return this._contentType};KiiRequest.prototype.setContentType=function(_contentType){this._contentType=_contentType};KiiRequest.prototype.isAnonymous=function(){return this._anonymous};KiiRequest.prototype.setAnonymous=function(_anonymous){this._anonymous=_anonymous};KiiRequest.prototype.getAccept=function(){return this._accept};KiiRequest.prototype.setAccept=function(_accept){this._accept=_accept};KiiRequest.prototype.addHeader=function(name,value){return this._headers[name]=value};KiiRequest.prototype.setAdminToken=function(token){return this._adminToken=token};function KiiRequest(path,withApp){this.execute=bind(this.execute,this);this.setAdminToken=bind(this.setAdminToken,this);this.addHeader=bind(this.addHeader,this);this.setAccept=bind(this.setAccept,this);this.getAccept=bind(this.getAccept,this);this.setAnonymous=bind(this.setAnonymous,this);this.isAnonymous=bind(this.isAnonymous,this);this.setContentType=bind(this.setContentType,this);this.getContentType=bind(this.getContentType,this);this.setData=bind(this.setData,this);this.getData=bind(this.getData,this);this.setHeaders=bind(this.setHeaders,this);this.getHeaders=bind(this.getHeaders,this);this.setMethod=bind(this.setMethod,this);this.getMethod=bind(this.getMethod,this);this.setPath=bind(this.setPath,this);this.getPath=bind(this.getPath,this);this._path=withApp?"/apps/"+root.Kii.getAppID()+path:path;this._method="GET";this._headers={accept:"*/*"};this._contentType="application/json";this._anonymous=false;this._success=function(_this){return function(){}}(this);this._failure=function(_this){return function(){}}(this);this._httpRequest=null}KiiRequest.prototype.execute=function(callbacks,ignoreBody){var h,key,name,ref,sendData,url,value;this._success=callbacks.success!=null?callbacks.success:this._success;this._failure=callbacks.failure!=null?callbacks.failure:this._failure;this._ignoreBody=ignoreBody;url=root.Kii.getBaseURL()+this._path;root.Kii.logger("POSTING: ");root.Kii.logger(JSON.stringify(this._data));if(KiiUtilities._isJSONType(this._contentType)){sendData=JSON.stringify(this._data)}else{sendData=this._data}root.Kii.logger("Making request["+this._method+"] to "+url+" with data: "+sendData);h=root.Kii.getAdditionalHeaders();if(h!=null){for(name in h){value=h[name];this._headers[name]=value}}this._headers["x-kii-appid"]=root.Kii.getAppID();this._headers["x-kii-appkey"]=root.Kii.getAppKey();this._headers["x-kii-sdk"]=root.KiiSDKClientInfo.getSDKClientInfo();if(this._accept!=null){this._headers["accept"]=this._accept}if(!this._anonymous&&root.KiiUser.getCurrentUser()!=null){this._headers["Authorization"]="Bearer "+root.KiiUser.getCurrentUser().getAccessToken()}if(this._adminToken!=null){this._headers["Authorization"]="Bearer "+this._adminToken}if(this._contentType!=null){this._headers["Content-Type"]=this._contentType}root.Kii.logger("Headers: ");root.Kii.logger(JSON.stringify(this._headers));callbacks={onComplete:function(_this){return function(){var e,errString,error,error1,error2,json,ref,responseHeaders,xhr;xhr=_this._httpRequest.xhr;if(xhr.readyState===4){if(200<=(ref=xhr.status)&&ref<400){root.Kii.logger("Completed Request["+xhr.status+"]");root.Kii.logger(xhr.responseText);responseHeaders=_this._parseResponseHeaders(xhr.getAllResponseHeaders());if(_this._ignoreBody){return _this._success(null,xhr.status)}else{try{json=JSON.parse(xhr.responseText)}catch(error1){e=error1;json=null}if(json!=null){if(json.errorCode!=null){errString=json.errorCode;if(json.message!=null){errString+=": "+json.message}return _this._failure(errString,xhr.status,json.errorCode)}else{return _this._success(json,xhr.status,responseHeaders)}}else{return _this._success(null,xhr.status,null)}}}else{root.Kii.logger("Error loading data...");errString=xhr.status+" : "+root.Kii.getBaseURL()+_this._path;try{json=JSON.parse(decodeURIComponent(xhr.responseText))}catch(error2){error=error2;json=null}if(json!=null){if(json.errorCode!=null){errString=json.errorCode;if(json.message!=null){errString+=": "+json.message}}}root.Kii.logger("Failure: "+errString);root.Kii.logger(xhr.responseText);return _this._failure(errString,xhr.status)}}}}(this),onError:function(_this){return function(){var errString,error,error1,json,xhr;xhr=_this._httpRequest.xhr;root.Kii.logger("Error loading data...");errString=xhr.status+" : "+root.Kii.getBaseURL()+_this._path;try{json=JSON.parse(decodeURIComponent(xhr.responseText))}catch(error1){error=error1;json=null}if(json!=null){if(json.errorCode!=null){errString=json.errorCode;if(json.message!=null){errString+=": "+json.message}}}root.Kii.logger("Failure: "+errString);root.Kii.logger(xhr.responseText);return _this._failure(errString,xhr.status)}}(this)};this._httpRequest=this._createHttpRequest(this._method,url,callbacks);if(this._httpRequest.xhr==null){this._failure("Cross-Origin Resource Sharing is not supported by the browser.",0)}ref=this._headers;for(key in ref){value=ref[key];this._httpRequest.xhr.setRequestHeader(key,value)}if(this._method!=="GET"&&this._method!=="DELETE"){return this._httpRequest.xhr.send(sendData)}else{return this._httpRequest.xhr.send()}};KiiRequest.prototype._createHttpRequest=function(method,url,callbacks){var request;request=null;if(root.Kii._getHttpRequestType()===null){if(typeof jQuery!=="undefined"){root.Kii.logger("Use jQuery");request=new KiiJQueryHttpRequest(method,url,callbacks)}else if(typeof XMLHttpRequest!=="undefined"){root.Kii.logger("Use XMLHttpRequest");request=new KiiXMLHttpRequest(method,url,callbacks)}else if(typeof Titanium!=="undefined"){root.Kii.logger("Use Titanium");request=new KiiTitaniumHttpRequest(method,url,callbacks)}}else{root.Kii.logger("Use http request backdoor");if(root.Kii._getHttpRequestType()===root._KiiHttpRequestType.jQuery){root.Kii.logger("Use jQuery");request=new KiiJQueryHttpRequest(method,url,callbacks)}else if(root.Kii._getHttpRequestType()===root._KiiHttpRequestType.XMLHttpRequest){root.Kii.logger("Use XMLHttpRequest");request=new KiiXMLHttpRequest(method,url,callbacks)}else if(root.Kii._getHttpRequestType()===root._KiiHttpRequestType.Titanium){root.Kii.logger("Use Titanium");request=new KiiTitaniumHttpRequest(method,url,callbacks)}}return request};KiiRequest.prototype._parseResponseHeaders=function(headerStr){var headerPair,headerPairs,headers,i,index,key,val;headers={};if(!headerStr){return headers}headerPairs=headerStr.split("\r\n");i=0;while(i<headerPairs.length){headerPair=headerPairs[i];index=headerPair.indexOf(": ");if(index>0){key=headerPair.substring(0,index).toLowerCase();val=headerPair.substring(index+2);headers[key]=val}i++}return headers};return KiiRequest}();root.KiiUser=function(){function KiiUser(){this._setAuthToken=bind(this._setAuthToken,this);this._getHttpURI=bind(this._getHttpURI,this);this._clone=bind(this._clone,this);this._getSubscriberPath=bind(this._getSubscriberPath,this);this.pushInstallation=bind(this.pushInstallation,this);this.pushSubscription=bind(this.pushSubscription,this);this._listTopicsUsingCallbacks=bind(this._listTopicsUsingCallbacks,this);this.listTopics=bind(this.listTopics,this);this.topicWithName=bind(this.topicWithName,this);this._groupWithJSON=bind(this._groupWithJSON,this);this._setAuthHeader=bind(this._setAuthHeader,this);this._getXhrWrapper=bind(this._getXhrWrapper,this);this._getRequest=bind(this._getRequest,this);this._updateWithJSON=bind(this._updateWithJSON,this);this._validateLocalPhoneNumber=bind(this._validateLocalPhoneNumber,this);this._validateIdentityData=bind(this._validateIdentityData,this);this._updateWithUserFields=bind(this._updateWithUserFields,this);this._updateWithIdentityData=bind(this._updateWithIdentityData,this);this._deleteUsingCallbacks=bind(this._deleteUsingCallbacks,this);this["delete"]=bind(this["delete"],this);this._refreshUsingCallbacks=bind(this._refreshUsingCallbacks,this);this.refresh=bind(this.refresh,this);this._saveUsingCallbacks=bind(this._saveUsingCallbacks,this);this.save=bind(this.save,this);this._changeEmailUsingCallbacks=bind(this._changeEmailUsingCallbacks,this);this.changeEmail=bind(this.changeEmail,this);this._changePhoneUsingCallbacks=bind(this._changePhoneUsingCallbacks,this);this.changePhone=bind(this.changePhone,this);this._ownerOfGroupsUsingCallbacks=bind(this._ownerOfGroupsUsingCallbacks,this);this.ownerOfGroups=bind(this.ownerOfGroups,this);this._memberOfGroupsUsingCallbacks=bind(this._memberOfGroupsUsingCallbacks,this);this.memberOfGroups=bind(this.memberOfGroups,this);this.resendPhoneNumberVerification=bind(this.resendPhoneNumberVerification,this);this.resendEmailVerification=bind(this.resendEmailVerification,this);this._resendVerificationUsingCallbacks=bind(this._resendVerificationUsingCallbacks,this);this.resendVerification=bind(this.resendVerification,this);this.verifyPhoneNumber=bind(this.verifyPhoneNumber,this);this._verifyCredentialsUsingCallbacks=bind(this._verifyCredentialsUsingCallbacks,this);this.verifyCredentials=bind(this.verifyCredentials,this);this._updatePasswordUsingCallbacks=bind(this._updatePasswordUsingCallbacks,this);this.updatePassword=bind(this.updatePassword,this);this._updateUsingCallbacks=bind(this._updateUsingCallbacks,this);this.update=bind(this.update,this);this._putIdentityUsingCallbacks=bind(this._putIdentityUsingCallbacks,this);this.putIdentity=bind(this.putIdentity,this);this._registerUsingCallbacks=bind(this._registerUsingCallbacks,this);this.register=bind(this.register,this);this._authenticateWithToken=bind(this._authenticateWithToken,this);this._authenticate=bind(this._authenticate,this);this.encryptedBucketWithName=bind(this.encryptedBucketWithName,this);this.bucketWithName=bind(this.bucketWithName,this);this.get=bind(this.get,this);this.set=bind(this.set,this);this.objectURI=bind(this.objectURI,this);this.getAccessTokenObject=bind(this.getAccessTokenObject,this);this._setExpiresAt=bind(this._setExpiresAt,this);this._setAccessToken=bind(this._setAccessToken,this);this.getAccessToken=bind(this.getAccessToken,this);this.getLinkedSocialAccounts=bind(this.getLinkedSocialAccounts,this);this._setPhoneVerified=bind(this._setPhoneVerified,this);this.getPhoneVerified=bind(this.getPhoneVerified,this);this._setEmailVerified=bind(this._setEmailVerified,this);this.getEmailVerified=bind(this.getEmailVerified,this);this._setModified=bind(this._setModified,this);this.getModified=bind(this.getModified,this);this._setCreated=bind(this._setCreated,this);this.getCreated=bind(this.getCreated,this);this.setLocale=bind(this.setLocale,this);this.getLocale=bind(this.getLocale,this);this.setCountry=bind(this.setCountry,this);this.getCountry=bind(this.getCountry,this);this._clearPassword=bind(this._clearPassword,this);this._setPassword=bind(this._setPassword,this);this._setLocalPhone=bind(this._setLocalPhone,this);this.getPendingPhoneNumber=bind(this.getPendingPhoneNumber,this);this._setPhoneNumber=bind(this._setPhoneNumber,this);this.getPhoneNumber=bind(this.getPhoneNumber,this);this.getPendingEmailAddress=bind(this.getPendingEmailAddress,this);this._setEmailAddress=bind(this._setEmailAddress,this);this.getEmailAddress=bind(this.getEmailAddress,this);this.isPseudoUser=bind(this.isPseudoUser,this);this.setDisplayName=bind(this.setDisplayName,this);this.getDisplayName=bind(this.getDisplayName,this);this._setDisabled=bind(this._setDisabled,this);this.disabled=bind(this.disabled,this);this._setUsername=bind(this._setUsername,this);this.getUsername=bind(this.getUsername,this);this.getID=bind(this.getID,this);this._setUUID=bind(this._setUUID,this);this.getUUID=bind(this.getUUID,this);this._customInfo={}}KiiUser.prototype.getUUID=function(){return this._uuid};KiiUser.prototype._setUUID=function(_uuid){this._uuid=_uuid};KiiUser.prototype.getID=function(){return this._uuid};KiiUser.prototype.getUsername=function(){return this._username};KiiUser.prototype._setUsername=function(value){var trimmedUsername;trimmedUsername=KiiUtilities._trim(value);root.Kii.logger("Setting username: "+trimmedUsername);if(KiiUtilities._validateUsername(trimmedUsername)){return this._username=trimmedUsername}else{throw new root.InvalidUsernameException}};KiiUser.prototype.disabled=function(){return this._disabled};KiiUser.prototype._setDisabled=function(_disabled){this._disabled=_disabled};KiiUser.prototype.getDisplayName=function(){return this._displayName};KiiUser.prototype.setDisplayName=function(value){if(!KiiUtilities._validateDisplayName(value)){throw new root.InvalidDisplayNameException}return this._displayName=value};KiiUser.prototype.isPseudoUser=function(){if(this._hasPassword!=null){return!this._hasPassword}else{return!this._username&&!this._emailAddress&&!this._phoneNumber}};KiiUser.prototype.getEmailAddress=function(){return this._emailAddress};KiiUser.prototype._setEmailAddress=function(value){var trimmedEmail;trimmedEmail=KiiUtilities._trim(value);root.Kii.logger("Setting email: "+trimmedEmail);if(KiiUtilities._validateEmail(trimmedEmail)){return this._emailAddress=trimmedEmail}else{throw new root.InvalidEmailException}};KiiUser.prototype.getPendingEmailAddress=function(){return this._emailAddressPending};KiiUser.prototype.getPhoneNumber=function(){return this._phoneNumber};KiiUser.prototype._setPhoneNumber=function(value){root.Kii.logger("Setting phone number: "+value);if(KiiUtilities._validatePhoneNumber(value)){return this._phoneNumber=value}else{throw new root.InvalidPhoneNumberException}};KiiUser.prototype.getPendingPhoneNumber=function(){return this._phoneNumberPending};KiiUser.prototype._setLocalPhone=function(phoneNumber,country){root.Kii.logger("Setting local phone number: "+phoneNumber+", country: "+country);if(!KiiUtilities._validateLocalPhone(phoneNumber)){throw new root.InvalidPhoneNumberException}if(!KiiUtilities._validateCountryCode(country)){throw new root.InvalidCountryException}this._phoneNumber=phoneNumber;return this._country=country};KiiUser.prototype._setPassword=function(value){if(KiiUtilities._validatePassword(value)){return this._password=value}else{throw new root.InvalidPasswordException}};KiiUser.prototype._clearPassword=function(){return this._password=null};KiiUser.prototype.getCountry=function(){return this._country};KiiUser.prototype.setCountry=function(value){if(KiiUtilities._validateCountryCode(value)){return this._country=value}else{throw new root.InvalidCountryException}};KiiUser.prototype.getLocale=function(){return this._locale};KiiUser.prototype.setLocale=function(value){return this._locale=value};KiiUser.prototype.getCreated=function(){return this._created};KiiUser.prototype._setCreated=function(_created){this._created=_created};KiiUser.prototype.getModified=function(){return this._modified};KiiUser.prototype._setModified=function(_modified){this._modified=_modified};KiiUser.prototype.getEmailVerified=function(){return this._emailVerified};KiiUser.prototype._setEmailVerified=function(_emailVerified){this._emailVerified=_emailVerified};KiiUser.prototype.getPhoneVerified=function(){return this._phoneVerified};KiiUser.prototype._setPhoneVerified=function(_phoneVerified){this._phoneVerified=_phoneVerified};KiiUser.prototype.getLinkedSocialAccounts=function(){root.Kii.logger("third party accounts: "+this._thirdPartyAccounts);return this._thirdPartyAccounts!=null?this._thirdPartyAccounts:this._thirdPartyAccounts={}};KiiUser.prototype.getAccessToken=function(){root.Kii.logger("Getting access token: "+this._accessToken);return this._accessToken};KiiUser.prototype._setAccessToken=function(_accessToken){this._accessToken=_accessToken;return root.Kii.logger("Setting access token: "+this._accessToken)};KiiUser.prototype._setExpiresAt=function(_expiresAt){this._expiresAt=_expiresAt;return root.Kii.logger("Setting expires at: "+this._expiresAt)};KiiUser.prototype.getAccessTokenObject=function(){var accessTokenObject;accessTokenObject=null;if(this._accessToken!=null){accessTokenObject={access_token:this._accessToken,expires_at:this._expiresAt}}return accessTokenObject};KiiUser.prototype.objectURI=function(){var uri;uri=null;if(this._uuid!=null){uri="kiicloud://users/"+this._uuid}return uri};KiiUser.prototype.set=function(key,value){if(!KiiUtilities._isNonEmptyString(key)||key.indexOf("_")===0){root.Kii.logger("[WARN] Reserved key is used for custom field. key="+key);return}root.Kii.logger(this);root.Kii.logger(this._customInfo);return this._customInfo[key]=value};KiiUser.prototype.get=function(key){return this._customInfo[key]};KiiUser.getCurrentUser=function(){return root.Kii.getCurrentUser()};KiiUser.userWithUsername=function(username,password){var user;user=new root.KiiUser;user._setUsername(username);user._setPassword(password);return user};KiiUser._userWithEmailAddress=function(emailAddress,password){var user;user=new root.KiiUser;user._setEmailAddress(emailAddress);user._setPassword(password);return user};KiiUser._userWithPhoneNumber=function(phoneNumber,password){var user;user=new root.KiiUser;user._setPhoneNumber(phoneNumber);user._setPassword(password);return user};KiiUser.userWithPhoneNumber=function(phoneNumber,password){return KiiUser._userWithPhoneNumber(phoneNumber,password)};KiiUser.userWithPhoneNumberAndUsername=function(phoneNumber,username,password){var user;user=new root.KiiUser;user._setPhoneNumber(phoneNumber);user._setUsername(username);user._setPassword(password);return user};KiiUser.userWithEmailAddress=function(emailAddress,password){return KiiUser._userWithEmailAddress(emailAddress,password)};KiiUser.userWithEmailAddressAndUsername=function(emailAddress,username,password){var user;user=new root.KiiUser;user._setEmailAddress(emailAddress);user._setUsername(username);user._setPassword(password);return user};KiiUser.userWithEmailAddressAndPhoneNumber=function(emailAddress,phoneNumber,password){var user;user=new root.KiiUser;user._setEmailAddress(emailAddress);user._setPhoneNumber(phoneNumber);user._setPassword(password);return user};KiiUser.userWithCredentials=function(emailAddress,phoneNumber,username,password){var user;user=new root.KiiUser;user._setEmailAddress(emailAddress);user._setPhoneNumber(phoneNumber);user._setUsername(username);user._setPassword(password);return user};KiiUser._validateURI=function(value){var match,pattern,retValue;value=KiiUtilities._trim(value);pattern=/^kiicloud:\/\/users\/(.*$)/i;if((typeof value).toLowerCase()==="string"){match=value.match(pattern);if(match!=null){retValue=match[1]}}return retValue};KiiUser.userWithID=function(userID){var user;if(userID==null||userID===""){throw new root.InvalidArgumentException("userID should not null or empty")}user=new root.KiiUser;user._setUUID(userID);return user};KiiUser.userWithURI=function(uri){var user,uuid;root.Kii.logger("About to extract from: "+uri);uuid=root.KiiUser._validateURI(uri);root.Kii.logger("Extracted uuid from uri: "+uuid);if(uuid!=null){user=new root.KiiUser;user._setUUID(uuid)}else{throw new root.InvalidURIException}return user};KiiUser.prototype.bucketWithName=function(bucketName){var bucket;bucket=new root.KiiBucket(bucketName,this);return bucket};KiiUser.prototype.encryptedBucketWithName=function(bucketName){var bucket;bucket=new root.KiiEncryptedBucket(bucketName,this);return bucket};KiiUser.prototype._authenticate=function(callbacks){var authCallbacks,currentTime,data,now,request,username;root.Kii.logger("Authenticating user:");root.Kii.logger(this);root.Kii.logger("Email verified: "+this._emailVerified);root.Kii.logger("Phone verified: "+this._phoneVerified);if(this._username!=null){username=this._username}else if(this._emailAddress!=null&&this._emailVerified===true){username=this._emailAddress}else if(this._phoneNumber!=null&&this._phoneVerified===true){username=this._phoneNumber}else if(this._emailAddress!=null){username=this._emailAddress}else if(this._phoneNumber!=null){username=this._phoneNumber}data={username:username,password:this._password};now=new Date;currentTime=now.getTime();if(root.Kii.getAccessTokenExpiration()>0){data.expiresAt=KiiUtilities._safeCalculateExpiresAtAsNumber(root.Kii.getAccessTokenExpiration(),currentTime)}request=this._getRequest({path:"/oauth2/token",withApp:false});request.setAnonymous(true);request.setMethod("POST");request.setData(data);authCallbacks={success:function(_this){return function(data){_this._setUUID(data.id);_this._clearPassword();_this._setAccessToken(data.access_token);if(data.expires_in!=null){now=new Date;currentTime=now.getTime();_this._expiresAt=KiiUtilities._safeCalculateExpiresAtAsDate(data.expires_in,currentTime)}root.Kii.setCurrentUser(_this);if(callbacks!=null){return callbacks.success(root.Kii.getCurrentUser())}}}(this),failure:function(_this){return function(error,statusCode){_this._clearPassword();if(callbacks!=null){return callbacks.failure(_this,error)}}}(this)};return request.execute(authCallbacks,false)};KiiUser.prototype._authenticateWithToken=function(token,callbacks,expiresAt){var authCallbacks,request;root.Kii.logger("Authenticating user "+this);root.Kii.logger(callbacks);request=this._getRequest({path:"/users/me",withApp:true});request.setAnonymous(true);request.addHeader("Authorization","Bearer "+token);authCallbacks={success:function(_this){return function(data){_this._updateWithJSON(data);_this._setAccessToken(token);if(typeof expiresAt==="undefined"){_this._setExpiresAt(new Date(KiiUtilities.MAX_DATE_IN_MILLIS))}else{_this._setExpiresAt(expiresAt)}root.Kii.setCurrentUser(_this);if(callbacks!=null){return callbacks.success(root.Kii.getCurrentUser())}}}(this),failure:function(_this){return function(error,statusCode){if(callbacks!=null){return callbacks.failure(_this,error)}}}(this)};return request.execute(authCallbacks,false)};KiiUser.authenticate=function(userIdentifier,password,callbacks){return new Promise(function(resolve,reject){var authenticateCallbacks;authenticateCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments[0])},failure:function(){var error;if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}error=KiiUtilities._Error(arguments[1]);error.target=arguments[0];return reject(error)}};return KiiUser._authenticateUsingCallbacks(userIdentifier,password,authenticateCallbacks)})};KiiUser._authenticateUsingCallbacks=function(userIdentifier,password,callbacks){var error,error1,user;try{root.Kii.logger("UserIdentifier: "+userIdentifier);if(!KiiUtilities._validatePassword(password)){throw new root.InvalidPasswordException}if(KiiUtilities._validateEmail(userIdentifier)){user=root.KiiUser._userWithEmailAddress(userIdentifier,password)}else if(KiiUtilities._validatePhoneNumber(userIdentifier)){user=root.KiiUser._userWithPhoneNumber(userIdentifier,password)}else if(KiiUtilities._validateUsername(userIdentifier)){user=root.KiiUser.userWithUsername(userIdentifier,password)}else{throw new root.InvalidUserIdentifierException}return user._authenticate(callbacks)}catch(error1){error=error1;if(user!=null){user._clearPassword()}if(callbacks!=null){return callbacks.failure(null,error.message)}}};KiiUser.authenticateWithToken=function(token,callbacks,expiresAt){return new Promise(function(resolve,reject){var authenticateWithTokenCallbacks;authenticateWithTokenCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments[0])},failure:function(){var error;if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}error=KiiUtilities._Error(arguments[1]);error.target=arguments[0];return reject(error)}};return KiiUser._authenticateWithTokenUsingCallbacks(token,authenticateWithTokenCallbacks,expiresAt)})};KiiUser._authenticateWithTokenUsingCallbacks=function(token,callbacks,expiresAt){var expiresAtType,user;expiresAtType=KiiUtilities._type(expiresAt);if(expiresAtType!=="undefined"&&expiresAtType!=="date"){return callbacks.failure(null,root.InvalidArgumentException("Specified expiresAt must be a Date"))}user=new root.KiiUser;return user._authenticateWithToken(token,callbacks,expiresAt)};KiiUser.prototype.register=function(callbacks){return new Promise(function(_this){return function(resolve,reject){var registerCallbacks;registerCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments[0])},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[1],_this))}};return _this._registerUsingCallbacks(registerCallbacks)}}(this))};KiiUser.prototype._registerUsingCallbacks=function(callbacks){var data,key,ref,registrationCallbacks,request,value;root.Kii.logger("Registering user "+this);data={password:this._password};if(this._username!=null){data.loginName=this._username}if(this._displayName!=null){data.displayName=this._displayName}if(this._emailAddress!=null){data.emailAddress=this._emailAddress}if(this._phoneNumber!=null){data.phoneNumber=this._phoneNumber}if(!this._validateLocalPhoneNumber(this._phoneNumber,this._country)){callbacks.failure(this,"needs to provide country for the local phone number");return}if(this._country!=null){data.country=this._country}if(this._locale!=null){data.locale=this._locale}root.Kii.logger("CINFO");root.Kii.logger(JSON.stringify(this._customInfo));ref=this._customInfo;for(key in ref){value=ref[key];root.Kii.logger("Key/val: "+key+"/"+value);data[key]=value}request=this._getRequest({path:"/users",withApp:true});request.setMethod("POST");request.setData(data);request.setAnonymous(true);request.setContentType("application/vnd.kii.RegistrationRequest+json");registrationCallbacks={success:function(_this){return function(data){root.Kii.logger("Succreg");_this._updateWithJSON(data);return _this._authenticate(callbacks)}}(this),failure:function(_this){return function(error,statusCode){root.Kii.logger("Failreg");_this._clearPassword();if(callbacks!=null){return callbacks.failure(_this,error)}}}(this)};return request.execute(registrationCallbacks,false)};KiiUser.registerAsPseudoUser=function(callbacks,userFields){return new Promise(function(resolve,reject){var registerAsPseudoUserCallbacks;registerAsPseudoUserCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments[0])},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[1]))}};return KiiUser._registerAsPseudoUserUsingCallbacks(registerAsPseudoUserCallbacks,userFields)})};KiiUser._registerAsPseudoUserUsingCallbacks=function(callbacks,userFields){var jsonBody,requestCallbacks,url,wrapper,xhr;url=root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+"/users";wrapper=KiiXHRWrapperFactory.createXHRWrapper("POST",url);xhr=wrapper.xhr;xhr.setRequestHeader("x-kii-appid",root.Kii.getAppID());xhr.setRequestHeader("x-kii-appkey",root.Kii.getAppKey());xhr.setRequestHeader("x-kii-sdk",root.KiiSDKClientInfo.getSDKClientInfo());xhr.setRequestHeader("Content-Type","application/vnd.kii.RegistrationAndAuthorizationRequest+json");requestCallbacks={success:function(){var accessToken,errString,error1,json,user;try{if(xhr.status<300&&xhr.status>=200){json=JSON.parse(xhr.responseText);accessToken=json["_accessToken"];user=new root.KiiUser;user._updateWithJSON(json);user._setAccessToken(accessToken);user._setExpiresAt(new Date(KiiUtilities.MAX_DATE_IN_MILLIS));root.Kii.setCurrentUser(user);return callbacks.success(user)}else{errString=xhr.status+" : "+url;return callbacks.failure(null,errString)}}catch(error1){return callbacks.failure(null,"failed to parse response")}},failure:function(){var errString,error1,json;errString="failed to register pseudo user. statusCode: "+xhr.status;try{json=JSON.parse(xhr.responseText);if(json.errorCode!=null){errString+=" error code: "+json.errorCode}if(json.message!=null){return errString+=" error message: "+json.message}}catch(error1){}finally{callbacks.failure(null,errString)}}};if(userFields==null){userFields={}}jsonBody=JSON.stringify(userFields);return wrapper.sendData(jsonBody,requestCallbacks)};KiiUser.prototype.putIdentity=function(identityData,password,callbacks,userFields,removeFields){return new Promise(function(_this){return function(resolve,reject){var putIdentityCallbacks;putIdentityCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments[0])},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[1],_this))}};return _this._putIdentityUsingCallbacks(identityData,password,putIdentityCallbacks,userFields,removeFields)}}(this))};KiiUser.prototype._putIdentityUsingCallbacks=function(identityData,password,callbacks,userFields,removeFields){var country,data,error1,errorString,hasIdentityData;root.Kii.logger("Put identity user: "+this._uuid+", data: "+JSON.stringify(identityData));data={};if(!this.isPseudoUser()){if(callbacks!=null){callbacks.failure(this,"This user has the identity already")}return}if(identityData==null){if(callbacks!=null){callbacks.failure(this,"identityData is null")}return}try{this._validateIdentityData(identityData)}catch(error1){errorString=error1;if(callbacks!=null){callbacks.failure(this,errorString)}return}hasIdentityData=false;if(identityData.emailAddress!=null){hasIdentityData=true}if(identityData.phoneNumber!=null){hasIdentityData=true}if(identityData.username!=null){hasIdentityData=true}if(!hasIdentityData){if(callbacks!=null){callbacks.failure(this,"needs to provide at least one of login name, email address or phone number");
}return}if(password!=null){if(!KiiUtilities._validatePassword(password)){if(callbacks!=null){callbacks.failure(this,"invalid password")}return}}else{if(callbacks!=null){callbacks.failure(this,"password is null")}return}country=userFields!=null?userFields.country:null;if(identityData.phoneNumber!=null&&!this._validateLocalPhoneNumber(identityData.phoneNumber,country)){callbacks.failure(this,"needs to provide country for the local phone number");return}return this.refresh({failure:function(_this){return function(user,error){root.Kii.logger("Failreg");if(callbacks!=null){return callbacks.failure(_this,error)}}}(this),success:function(_this){return function(user){var j,jsonBody,key,len,removeField,requestCallbacks,url,value,wrapper,xhr;if(!user.isPseudoUser()){if(callbacks!=null){callbacks.failure(user,"This user has the identity already")}return}data=_this._clone(user._customInfo);if(identityData.emailAddress!=null){data.emailAddress=identityData.emailAddress}if(identityData.phoneNumber!=null){data.phoneNumber=identityData.phoneNumber}if(identityData.username!=null){data.loginName=identityData.username}data.password=password;if(userFields!=null){for(key in userFields){value=userFields[key];data[key]=value}}if(removeFields!=null){for(j=0,len=removeFields.length;j<len;j++){removeField=removeFields[j];delete data[removeField]}}url=root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+("/users/"+_this._uuid);wrapper=_this._getXhrWrapper("POST",url);xhr=wrapper.xhr;_this._setAuthHeader(xhr);xhr.setRequestHeader("Content-Type","application/vnd.kii.UserUpdateRequest+json");requestCallbacks={success:function(){var errString,error2,json;try{json=JSON.parse(xhr.responseText);if(xhr.status<300&&xhr.status>=200){user._setModified(json.modifiedAt);user._updateWithIdentityData(identityData);user._updateWithUserFields(userFields,removeFields);_this._hasPassword=true;return callbacks.success(user)}else{errString=xhr.status+" : "+url;return callbacks.failure(_this,errString)}}catch(error2){return callbacks.failure(_this,"failed to parse response")}},failure:function(){var errString,error2,json;errString="failed to put identity data. statusCode: "+xhr.status;try{json=JSON.parse(xhr.responseText);if(json.errorCode!=null){errString+=" error code: "+json.errorCode}if(json.message!=null){return errString+=" error message: "+json.message}}catch(error2){}finally{callbacks.failure(_this,errString)}}};jsonBody=JSON.stringify(data);return wrapper.sendData(jsonBody,requestCallbacks)}}(this)})};KiiUser.prototype.update=function(identityData,callbacks,userFields,removeFields){return new Promise(function(_this){return function(resolve,reject){var updateCallbacks;updateCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments[0])},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[1],_this))}};return _this._updateUsingCallbacks(identityData,updateCallbacks,userFields,removeFields)}}(this))};KiiUser.prototype._updateUsingCallbacks=function(identityData,callbacks,userFields,removeFields){var country,data,error1,errorString,hasIdentityData,hasRemoveFields,hasUserFields,j,key,len,removeField,value;root.Kii.logger("update user: "+this._uuid);data={};hasIdentityData=false;hasUserFields=false;hasRemoveFields=false;if(identityData!=null){try{this._validateIdentityData(identityData)}catch(error1){errorString=error1;if(callbacks!=null){callbacks.failure(this,errorString)}return}if(identityData.emailAddress!=null){hasIdentityData=true}if(identityData.phoneNumber!=null){hasIdentityData=true}if(identityData.username!=null){hasIdentityData=true}}if(userFields!=null){for(key in userFields){value=userFields[key];hasUserFields=true;break}}if(removeFields!=null){for(j=0,len=removeFields.length;j<len;j++){removeField=removeFields[j];hasRemoveFields=true;break}}if(!hasIdentityData&&!hasUserFields&&!hasRemoveFields){callbacks.failure(this,"all arguments are null or empty");return}country=userFields!=null?userFields.country:null;if(identityData!=null&&identityData.phoneNumber!=null&&!this._validateLocalPhoneNumber(identityData.phoneNumber,country)){callbacks.failure(this,"needs to provide country for the local phone number");return}return this.refresh({failure:function(_this){return function(user,error){root.Kii.logger("Failreg");if(callbacks!=null){return callbacks.failure(_this,error)}}}(this),success:function(_this){return function(user){var jsonBody,l,len1,requestCallbacks,url,wrapper,xhr;if(user.isPseudoUser()&&hasIdentityData){if(callbacks!=null){callbacks.failure(user,"Pseudo user must use putIdentity()")}return}data=_this._clone(user._customInfo);if(identityData!=null){if(identityData.emailAddress!=null){data.emailAddress=identityData.emailAddress}if(identityData.phoneNumber!=null){data.phoneNumber=identityData.phoneNumber}if(identityData.username!=null){data.loginName=identityData.username}}if(userFields!=null){for(key in userFields){value=userFields[key];data[key]=value}}if(removeFields!=null){for(l=0,len1=removeFields.length;l<len1;l++){removeField=removeFields[l];delete data[removeField]}}url=root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+("/users/"+_this._uuid);wrapper=_this._getXhrWrapper("POST",url,false);xhr=wrapper.xhr;_this._setAuthHeader(xhr);xhr.setRequestHeader("Content-Type","application/vnd.kii.UserUpdateRequest+json");requestCallbacks={success:function(){var errString,error2,json;try{json=JSON.parse(xhr.responseText);if(xhr.status<300&&xhr.status>=200){user._setModified(data.modifiedAt);user._updateWithIdentityData(identityData);user._updateWithUserFields(userFields,removeFields);return callbacks.success(user)}else{errString=xhr.status+" : "+url;return callbacks.failure(_this,errString)}}catch(error2){return callbacks.failure(_this,"failed to parse response")}},failure:function(){var errString,error2,json;errString="failed to update user. statusCode: "+xhr.status;try{json=JSON.parse(xhr.responseText);if(json.errorCode!=null){errString+=" error code: "+json.errorCode}if(json.message!=null){return errString+=" error message: "+json.message}}catch(error2){}finally{callbacks.failure(_this,errString)}}};jsonBody=JSON.stringify(data);return wrapper.sendData(jsonBody,requestCallbacks)}}(this)})};KiiUser.prototype.updatePassword=function(fromPassword,toPassword,callbacks){return new Promise(function(_this){return function(resolve,reject){var updatePasswordCallbacks;updatePasswordCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments[0])},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[1],_this))}};return _this._updatePasswordUsingCallbacks(fromPassword,toPassword,updatePasswordCallbacks)}}(this))};KiiUser.prototype._updatePasswordUsingCallbacks=function(fromPassword,toPassword,callbacks){var data,path,request,updateCallbacks;root.Kii.logger("Updating password from "+fromPassword+" to "+toPassword);if(KiiUtilities._validatePassword(toPassword)){data={oldPassword:fromPassword,newPassword:toPassword};path="/users/"+this._uuid+"/password";request=this._getRequest({path:path,withApp:true});request.setMethod("PUT");request.setData(data);request.setContentType("application/vnd.kii.ChangePasswordRequest+json");updateCallbacks={success:function(_this){return function(data,statusCode){_this._clearPassword;if(statusCode<300&&statusCode>=200){if(callbacks!=null){return callbacks.success(_this)}}else if(callbacks!=null){return callbacks.failure(_this,"Unable to change password")}}}(this),failure:function(_this){return function(error,statusCode){_this._clearPassword;if(callbacks!=null){return callbacks.failure(_this,error)}}}(this)};return request.execute(updateCallbacks,true)}else if(callbacks!=null){return callbacks.failure(this,(new root.InvalidPasswordException).message)}};KiiUser.resetPassword=function(userIdentifier,callbacks){return new Promise(function(resolve,reject){var resetPasswordCallbacks;resetPasswordCallbacks={success:function(){if(callbacks!=null){callbacks.success()}return resolve()},failure:function(){if(callbacks!=null){callbacks.failure(arguments[0])}return reject(KiiUtilities._Error(arguments[0]))}};return KiiUser._resetPasswordUsingCallbacks(userIdentifier,resetPasswordCallbacks)})};KiiUser._resetPasswordUsingCallbacks=function(userIdentifier,callbacks){var accountType,path,request,resetCallbacks;root.Kii.logger("Resetting password with identifier: "+userIdentifier);if(KiiUtilities._validateEmail(userIdentifier)){accountType="EMAIL"}else if(callbacks!=null){callbacks.failure("Invalid user identifier. Must be a valid email address");return}if(accountType!=null){path="/users/"+accountType+":"+userIdentifier+"/password/request-reset";request=new KiiRequest(path,true);request.setMethod("POST");request.setAnonymous(true);resetCallbacks={success:function(data,statusCode){if(statusCode<300&&statusCode>=200&&callbacks!=null){return callbacks.success()}else if(callbacks!=null){return callbacks.failure("Unable to reset password")}},failure:function(error,statusCode){if(callbacks!=null){return callbacks.failure(error)}}};return request.execute(resetCallbacks,true)}};KiiUser.resetPasswordWithNotificationMethod=function(userIdentifier,notificationMethod,callbacks){return new Promise(function(resolve,reject){var resetPasswordWithNotificationMethodCallbacks;resetPasswordWithNotificationMethodCallbacks={success:function(){if(callbacks!=null){callbacks.success()}return resolve()},failure:function(){if(callbacks!=null){callbacks.failure(arguments[0])}return reject(KiiUtilities._Error(arguments[0]))}};return KiiUser._resetPasswordWithNotificationMethodUsingCallbacks(userIdentifier,notificationMethod,resetPasswordWithNotificationMethodCallbacks)})};KiiUser._resetPasswordWithNotificationMethodUsingCallbacks=function(userIdentifier,notificationMethod,callbacks){var body,qualifiedID,reqCallbacks,requestUri,wrapper,xhr;if(typeof userIdentifier!=="string"){if(callbacks!=null){callbacks.failure("given userIdentifier is not string")}return}if(userIdentifier===""){if(callbacks!=null){callbacks.failure("given userIdentifier is empty")}return}if(notificationMethod!=="EMAIL"&&notificationMethod!=="SMS"&&notificationMethod!=="SMS_PIN"){if(callbacks!=null){callbacks.failure("notificationMethod should be 'EMAIL' or 'SMS' or 'SMS_PIN'")}return}if(KiiUtilities._validateEmail(userIdentifier)){qualifiedID="EMAIL:"+userIdentifier}else if(KiiUtilities._isGlobalPhoneNumber(userIdentifier)){qualifiedID="PHONE:"+userIdentifier}else{qualifiedID=userIdentifier}qualifiedID=encodeURIComponent(qualifiedID);body={notificationMethod:notificationMethod};if(notificationMethod==="SMS_PIN"){body.notificationMethod="SMS";body.smsResetMethod="PIN"}requestUri=root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+"/users/"+qualifiedID+"/password/request-reset";wrapper=KiiXHRWrapperFactory.createXHRWrapper("POST",requestUri);xhr=wrapper.xhr;xhr.setRequestHeader("x-kii-appid",root.Kii.getAppID());xhr.setRequestHeader("x-kii-appkey",root.Kii.getAppKey());xhr.setRequestHeader("x-kii-sdk",root.KiiSDKClientInfo.getSDKClientInfo());xhr.setRequestHeader("Content-Type","application/vnd.kii.ResetPasswordRequest+json");reqCallbacks={success:function(){return callbacks!=null?callbacks.success():void 0},failure:function(){var errString,error1,json;errString="failed to reset password. statusCode: "+xhr.status;try{json=JSON.parse(xhr.responseText);if(json.errorCode!=null){errString+=" error code: "+json.errorCode}if(json.message!=null){return errString+=" error message: "+json.message}}catch(error1){}finally{if(callbacks!=null){callbacks.failure(errString)}}}};return wrapper.sendData(JSON.stringify(body),reqCallbacks)};KiiUser.completeResetPassword=function(userIdentifier,pinCode,newPassword,callbacks){return new Promise(function(resolve,reject){var completeResetPasswordCallbacks;completeResetPasswordCallbacks={success:function(){if(callbacks!=null){callbacks.success()}return resolve()},failure:function(){if(callbacks!=null){callbacks.failure(arguments[0])}return reject(KiiUtilities._Error(arguments[0]))}};return KiiUser._completeResetPasswordUsingCallbacks(userIdentifier,pinCode,newPassword,completeResetPasswordCallbacks)})};KiiUser._completeResetPasswordUsingCallbacks=function(userIdentifier,pinCode,newPassword,callbacks){var body,qualifiedID,reqCallbacks,requestUri,wrapper,xhr;if(!KiiUtilities._isNonEmptyString(userIdentifier)){if(callbacks!=null){callbacks.failure("given userIdentifier is null or empty")}return}if(!KiiUtilities._isNonEmptyString(pinCode)){if(callbacks!=null){callbacks.failure("given pinCode is null or empty")}return}if(KiiUtilities._validateEmail(userIdentifier)){qualifiedID="EMAIL:"+userIdentifier}else if(KiiUtilities._isGlobalPhoneNumber(userIdentifier)){qualifiedID="PHONE:"+userIdentifier}else{qualifiedID=userIdentifier}qualifiedID=encodeURIComponent(qualifiedID);body={pinCode:pinCode};if(KiiUtilities._isNonEmptyString(newPassword)){body["newPassword"]=newPassword}requestUri=root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+"/users/"+qualifiedID+"/password/complete-reset";wrapper=KiiXHRWrapperFactory.createXHRWrapper("POST",requestUri);xhr=wrapper.xhr;xhr.setRequestHeader("x-kii-appid",root.Kii.getAppID());xhr.setRequestHeader("x-kii-appkey",root.Kii.getAppKey());xhr.setRequestHeader("x-kii-sdk",root.KiiSDKClientInfo.getSDKClientInfo());xhr.setRequestHeader("Content-Type","application/vnd.kii.CompletePasswordResetRequest+json");reqCallbacks={success:function(){return callbacks!=null?callbacks.success():void 0},failure:function(){var errString,error1,json;errString="failed to reset password. statusCode: "+xhr.status;try{json=JSON.parse(xhr.responseText);if(json.errorCode!=null){errString+=" error code: "+json.errorCode}if(json.message!=null){return errString+=" error message: "+json.message}}catch(error1){}finally{if(callbacks!=null){callbacks.failure(errString)}}}};return wrapper.sendData(JSON.stringify(body),reqCallbacks)};KiiUser.prototype.verifyCredentials=function(type,code,callbacks){return new Promise(function(_this){return function(resolve,reject){var verifyCredentialsCallbacks;verifyCredentialsCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments[0])},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[1],_this))}};return _this._verifyCredentialsUsingCallbacks(type,code,verifyCredentialsCallbacks)}}(this))};KiiUser.prototype._verifyCredentialsUsingCallbacks=function(type,code,callbacks){var path,request,verifyCallbacks;root.Kii.logger("Verifying "+type+" with code: "+code);path="/users/me/"+type+"/verify";request=this._getRequest({path:path,withApp:true});request.setMethod("POST");request.setData({verificationCode:code});request.setContentType("application/vnd.kii.AddressVerificationRequest+json");verifyCallbacks={success:function(_this){return function(data,statusCode){if(statusCode<300&&statusCode>=200){if(type==="email-address"){_this._setEmailVerified(true)}else if(type==="phone-number"){_this._setPhoneVerified(true)}if(callbacks!=null){return callbacks.success(_this)}}else if(callbacks!=null){return callbacks.failure(_this,"Unable to verify "+type)}}}(this),failure:function(_this){return function(error,statusCode){if(callbacks!=null){return callbacks.failure(_this,error)}}}(this)};return request.execute(verifyCallbacks,true)};KiiUser.prototype.verifyPhoneNumber=function(verificationCode,callbacks){return this.verifyCredentials("phone-number",verificationCode,callbacks)};KiiUser.prototype.resendVerification=function(type,callbacks){return new Promise(function(_this){return function(resolve,reject){var resendVerificationCallbacks;resendVerificationCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments[0])},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[1],_this))}};return _this._resendVerificationUsingCallbacks(type,resendVerificationCallbacks)}}(this))};KiiUser.prototype._resendVerificationUsingCallbacks=function(type,callbacks){var id,path,request,resendCallbacks;root.Kii.logger("Resending verification "+type);id=this.getID();path="/users/"+id+"/"+type+"/resend-verification";request=this._getRequest({path:path,withApp:true});request.setMethod("POST");resendCallbacks={success:function(_this){return function(data,statusCode){if(statusCode<300&&statusCode>=200&&callbacks!=null){return callbacks.success(_this)}else if(callbacks!=null){return callbacks.failure(_this,"Unable to resend "+type+" verification")}}}(this),failure:function(_this){return function(error,statusCode){if(callbacks!=null){return callbacks.failure(_this,error)}}}(this)};return request.execute(resendCallbacks,true)};KiiUser.prototype.resendEmailVerification=function(callbacks){return this.resendVerification("email-address",callbacks)};KiiUser.prototype.resendPhoneNumberVerification=function(callbacks){return this.resendVerification("phone-number",callbacks)};KiiUser.prototype.memberOfGroups=function(callbacks){return new Promise(function(_this){return function(resolve,reject){var memberOfGroupsCallbacks;memberOfGroupsCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments)},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[1],_this))}};return _this._memberOfGroupsUsingCallbacks(memberOfGroupsCallbacks)}}(this))};KiiUser.prototype._memberOfGroupsUsingCallbacks=function(callbacks){var memberCallbacks,path,request;root.Kii.logger("Getting groups for member "+this._uuid);path="/groups/?is_member="+this._uuid;request=this._getRequest({path:path,withApp:true});request.setAccept("application/vnd.kii.GroupsRetrievalResponse+json");memberCallbacks={success:function(_this){return function(data,statusCode){var group,groupList,j,len,ref;if(statusCode<300&&statusCode>=200){groupList=[];ref=data.groups;for(j=0,len=ref.length;j<len;j++){group=ref[j];groupList.push(_this._groupWithJSON(group))}if(callbacks!=null){return callbacks.success(_this,groupList)}}else if(callbacks!=null){return callbacks.failure(_this,"Unable to retrieve groups")}}}(this),failure:function(_this){return function(error,statusCode){if(callbacks!=null){return callbacks.failure(_this,error)}}}(this)};return request.execute(memberCallbacks,false)};KiiUser.prototype.ownerOfGroups=function(callbacks){return new Promise(function(_this){return function(resolve,reject){var ownerOfGroupsCallbacks;ownerOfGroupsCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments)},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[1],_this))}};return _this._ownerOfGroupsUsingCallbacks(ownerOfGroupsCallbacks)}}(this))};KiiUser.prototype._ownerOfGroupsUsingCallbacks=function(callbacks){var memberCallbacks,path,request;root.Kii.logger("Getting groups owned by the user "+this._uuid);path="/groups/?owner="+this._uuid;request=this._getRequest({path:path,withApp:true});request.setAccept("application/vnd.kii.GroupsRetrievalResponse+json");memberCallbacks={success:function(_this){return function(data,statusCode){var group,groupList,j,len,ref;if(statusCode<300&&statusCode>=200){groupList=[];ref=data.groups;for(j=0,len=ref.length;j<len;j++){group=ref[j];groupList.push(_this._groupWithJSON(group))}if(callbacks!=null){return callbacks.success(_this,groupList)}}else if(callbacks!=null){return callbacks.failure(_this,"Unable to retrieve groups")}}}(this),failure:function(_this){return function(error,statusCode){if(callbacks!=null){return callbacks.failure(_this,error)}}}(this)};return request.execute(memberCallbacks,false)};KiiUser.prototype.changePhone=function(newPhoneNumber,callbacks){return new Promise(function(_this){return function(resolve,reject){var changePhoneCallbacks;changePhoneCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments[0])},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[1],_this))}};return _this._changePhoneUsingCallbacks(newPhoneNumber,changePhoneCallbacks)}}(this))};KiiUser.prototype._changePhoneUsingCallbacks=function(newPhoneNumber,callbacks){var path,request,updateCallbacks;root.Kii.logger("Updating phone number to "+newPhoneNumber);path="/users/"+this._uuid+"/phone-number";request=this._getRequest({path:path,withApp:true});request.setMethod("PUT");request.setContentType("application/vnd.kii.PhoneNumberModificationRequest+json");request.setData({phoneNumber:newPhoneNumber});updateCallbacks={success:function(_this){return function(data,statusCode){if(statusCode<300&&statusCode>=200&&callbacks!=null){return callbacks.success(_this)}else if(callbacks!=null){return callbacks.failure(_this,"Unable to update phone number")}}}(this),failure:function(_this){return function(error,statusCode){if(callbacks!=null){return callbacks.failure(_this,error)}}}(this)};return request.execute(updateCallbacks,true)};KiiUser.prototype.changeEmail=function(newEmail,callbacks){return new Promise(function(_this){return function(resolve,reject){var changeEmailCallbacks;changeEmailCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments[0])},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[1],_this))}};return _this._changeEmailUsingCallbacks(newEmail,changeEmailCallbacks)}}(this))};KiiUser.prototype._changeEmailUsingCallbacks=function(newEmail,callbacks){var path,request,updateCallbacks;root.Kii.logger("Updating email address to: "+newEmail);if(KiiUtilities._validateEmail(newEmail)){path="/users/"+this._uuid+"/email-address";request=this._getRequest({path:path,withApp:true});request.setMethod("PUT");request.setContentType("application/vnd.kii.EmailAddressModificationRequest+json");request.setData({emailAddress:newEmail});updateCallbacks={success:function(_this){return function(data,statusCode){if(statusCode<300&&statusCode>=200&&callbacks!=null){return callbacks.success(_this)}else if(callbacks!=null){return callbacks.failure(_this,"Unable to update email address")}}}(this),failure:function(_this){return function(error,statusCode){if(callbacks!=null){return callbacks.failure(_this,error)}}}(this)};return request.execute(updateCallbacks,true)}else{return callbacks.failure(this,"Invalid email address format")}};KiiUser.prototype.save=function(callbacks){return new Promise(function(_this){return function(resolve,reject){var saveCallbacks;saveCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments[0])},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[1],_this))}};return _this._saveUsingCallbacks(saveCallbacks)}}(this))};KiiUser.prototype._saveUsingCallbacks=function(callbacks){var data,path,request,updateCallbacks;root.Kii.logger("Saving user: "+this._uuid);path="/users/"+this._uuid;root.Kii.logger("CUSTOMINFO: ");root.Kii.logger(this._customInfo);request=this._getRequest({path:path,withApp:true});request.setMethod("POST");request.setContentType("application/vnd.kii.UserUpdateRequest+json");data=this._customInfo;if(this._country!=null){data.country=this._country}if(this._locale!=null){data.locale=this._locale}if(this._displayName!=null){data.displayName=this._displayName}request.setData(data);updateCallbacks={success:function(_this){return function(data,statusCode){if(statusCode<300&&statusCode>=200){_this._setModified(data.modifiedAt);if(callbacks!=null){return callbacks.success(_this)}}else if(callbacks!=null){return callbacks.failure(_this,"Unable to parse response")}}}(this),failure:function(_this){return function(error,statusCode){if(callbacks!=null){return callbacks.failure(_this,error)}}}(this)};return request.execute(updateCallbacks,false)};KiiUser.prototype.refresh=function(callbacks){return new Promise(function(_this){return function(resolve,reject){var refreshCallbacks;refreshCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments[0])},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[1],_this))}};return _this._refreshUsingCallbacks(refreshCallbacks)}}(this))};KiiUser.prototype._refreshUsingCallbacks=function(callbacks){var refreshCallbacks,request;root.Kii.logger("Refreshing user: "+this._uuid);request=this._getRequest({path:"/users/"+this._uuid,withApp:true});refreshCallbacks={success:function(_this){return function(data,statusCode){if(statusCode<300&&statusCode>=200){_this._phoneNumberPending=null;_this._emailAddressPending=null;_this._updateWithJSON(data);if(callbacks!=null){return callbacks.success(_this)}}else if(callbacks!=null){return callbacks.failure(_this,"Unable to parse response")}}}(this),failure:function(_this){return function(error,statusCode){if(callbacks!=null){return callbacks.failure(_this,error)}}}(this)};return request.execute(refreshCallbacks,false)};KiiUser.prototype["delete"]=function(callbacks){return new Promise(function(_this){return function(resolve,reject){var deleteCallbacks;deleteCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments[0])},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[1],_this))}};return _this._deleteUsingCallbacks(deleteCallbacks)}}(this))};KiiUser.prototype._deleteUsingCallbacks=function(callbacks){var refreshCallbacks,request;root.Kii.logger("Deleting user...");request=this._getRequest({path:"/users/"+this._uuid,withApp:true});request.setMethod("DELETE");refreshCallbacks={success:function(_this){return function(data,statusCode){if(statusCode<300&&statusCode>=200&&callbacks!=null){return callbacks.success(_this)}else if(callbacks!=null){return callbacks.failure(_this,"Unable to parse response")}}}(this),failure:function(_this){return function(error,statusCode){if(callbacks!=null){return callbacks.failure(_this,error)}}}(this)};return request.execute(refreshCallbacks,true)};KiiUser.logOut=function(){return root.Kii.logOut()};KiiUser.loggedIn=function(){return root.Kii.loggedIn()};KiiUser.prototype._updateWithIdentityData=function(identityData){if(identityData!=null){if(identityData["username"]!=null){this._username=identityData["username"]}if(identityData["emailAddress"]!=null){this._emailAddress=identityData["emailAddress"]}if(identityData["phoneNumber"]!=null){return this._phoneNumber=identityData["phoneNumber"]}}};KiiUser.prototype._updateWithUserFields=function(userFields,removeFields){var j,key,len,removeField,results1,value;if(userFields!=null){for(key in userFields){value=userFields[key];if(key==="displayName"){this._displayName=value}else if(key==="country"){this._country=value}else if(key==="locale"){this._locale=value}else if(key===""){root.Kii.logger("Setting empty to custom info");this._customInfo[key]=value}else if(key.substring(0,1)!=="_"){root.Kii.logger("Setting to custom info");this._customInfo[key]=value}}}if(removeFields!=null){results1=[];for(j=0,len=removeFields.length;j<len;j++){removeField=removeFields[j];results1.push(delete this._customInfo[removeField])}return results1}};KiiUser.prototype._validateIdentityData=function(identityData){if(identityData!=null){if(identityData.emailAddress!=null){if(!KiiUtilities._validateEmail(identityData.emailAddress)){throw"invalid email"}}if(identityData.phoneNumber!=null){if(!KiiUtilities._validatePhoneNumber(identityData.phoneNumber)){throw"invalid phone number"}}if(identityData.username!=null){if(!KiiUtilities._validateUsername(identityData.username)){throw"invalid username"}}}};KiiUser.prototype._validateLocalPhoneNumber=function(phone,country){if(phone!=null&&!KiiUtilities._isGlobalPhoneNumber(phone)){if(country!=null){return KiiUtilities._validateCountryCode(country)}else{return false}}return true};KiiUser.prototype._updateWithJSON=function(json){var key,results1,temp,value;root.Kii.logger("Updating with:");root.Kii.logger(json);this._thirdPartyAccounts={};results1=[];for(key in json){value=json[key];root.Kii.logger("key/val => "+key+"/"+value);root.Kii.logger("Substr "+key.substring(0,1));if(key==="userID"||key==="id"){results1.push(this._uuid=value)}else if(key==="created"||key==="createdAt"||key==="_created"){results1.push(this._created=value)}else if(key==="modified"||key==="modifiedAt"||key==="_modified"){results1.push(this._modified=value)}else if(key==="loginName"){results1.push(this._username=value)}else if(key==="displayName"){results1.push(this._displayName=value)}else if(key==="country"){root.Kii.logger("Is setting country");results1.push(this._country=value)}else if(key==="locale"){results1.push(this._locale=value)}else if(key==="emailAddress"){results1.push(this._emailAddress=value)}else if(key==="_emailAddressPending"){results1.push(this._emailAddressPending=value)}else if(key==="phoneNumber"){results1.push(this._phoneNumber=value)}else if(key==="_phoneNumberPending"){results1.push(this._phoneNumberPending=value)}else if(key==="emailAddressVerified"){root.Kii.logger("Email verified: "+value);results1.push(this._emailVerified=value)}else if(key==="phoneNumberVerified"){root.Kii.logger("Phone verified: "+value);results1.push(this._phoneVerified=value)}else if(key==="_hasPassword"){root.Kii.logger("_hasPassword: "+value);results1.push(this._hasPassword=value)}else if(key==="_thirdPartyAccounts"){if(value.hotmail!=null){temp=value.hotmail;temp.type="live";value.live=temp;delete value.hotmail}root.Kii.logger("_thirdPartyAccounts: "+value);results1.push(this._thirdPartyAccounts=value)}else if(key==="_disabled"){root.Kii.logger("disabled: "+value);results1.push(this._disabled=value)}else if(key===""){root.Kii.logger("Setting empty to custom info");results1.push(this._customInfo[key]=value)}else if(key.substring(0,1!=="_")){root.Kii.logger("Setting to custom info");results1.push(this._customInfo[key]=value)}else{results1.push(root.Kii.logger("Doing nothing"))}}return results1};KiiUser.prototype._getRequest=function(spec){var path,request,withApp;path=spec.path;withApp=spec.withApp;request=new KiiRequest(path,withApp);return request};KiiUser.findUserByEmail=function(email,callbacks){var error,errorString;if(root.KiiUser.getCurrentUser()==null||root.KiiUser.getCurrentUser().getAccessToken()==null){errorString=root.IllegalStateException("User is not logged in");error=KiiUtilities._Error(errorString);if(callbacks!=null){if(typeof callbacks.failure==="function"){callbacks.failure(errorString)}}return Promise.reject(error)}return KiiUser._findUserByEmail(email,callbacks)};KiiUser._findUserByEmail=function(email,callbacks,context){var error,errorString,url;if(email==null||email===""){errorString=root.InvalidArgumentException("email should not null or empty");error=KiiUtilities._Error(errorString);if(context!=null){if(callbacks!=null){if(typeof callbacks.failure==="function"){callbacks.failure(context,errorString)}}error.target=context}else{if(callbacks!=null){if(typeof callbacks.failure==="function"){callbacks.failure(errorString)}}}return Promise.reject(error)}url=root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+("/users/EMAIL:"+email);return KiiUser._findUserRequestImpl(url,callbacks,context)};KiiUser.findUserByPhone=function(phone,callbacks){var error,errorString;if(root.KiiUser.getCurrentUser()==null||root.KiiUser.getCurrentUser().getAccessToken()==null){
errorString=root.IllegalStateException("User is not logged in");error=KiiUtilities._Error(errorString);if(callbacks!=null){if(typeof callbacks.failure==="function"){callbacks.failure(errorString)}}return Promise.reject(error)}return KiiUser._findUserByPhone(phone,callbacks)};KiiUser._findUserByPhone=function(phone,callbacks,context){var error,errorString,url;if(phone==null||phone===""){errorString=root.InvalidArgumentException("phone should not null or empty");error=KiiUtilities._Error(errorString);if(context!=null){if(callbacks!=null){if(typeof callbacks.failure==="function"){callbacks.failure(context,errorString)}}error.target=context}else{if(callbacks!=null){if(typeof callbacks.failure==="function"){callbacks.failure(errorString)}}}return Promise.reject(error)}url=root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+("/users/PHONE:"+phone);return KiiUser._findUserRequestImpl(url,callbacks,context)};KiiUser.findUserByUsername=function(username,callbacks){var error,errorString;if(root.KiiUser.getCurrentUser()==null||root.KiiUser.getCurrentUser().getAccessToken()==null){errorString=root.IllegalStateException("User is not logged in");error=KiiUtilities._Error(errorString);if(callbacks!=null){if(typeof callbacks.failure==="function"){callbacks.failure(errorString)}}return Promise.reject(error)}return KiiUser._findUserByUsername(username,callbacks)};KiiUser._findUserByUsername=function(username,callbacks,context){var error,errorString,url;if(username==null||username===""){errorString=root.InvalidArgumentException("username should not null or empty");error=KiiUtilities._Error(errorString);if(context!=null){if(callbacks!=null){if(typeof callbacks.failure==="function"){callbacks.failure(context,errorString)}}error.target=context}else{if(callbacks!=null){if(typeof callbacks.failure==="function"){callbacks.failure(errorString)}}}return Promise.reject(error)}url=root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+("/users/LOGIN_NAME:"+username);return KiiUser._findUserRequestImpl(url,callbacks,context)};KiiUser._findUserRequestImpl=function(url,callbacks,context){return new Promise(function(resolve,reject){var findUserRequestImplCallbacks;findUserRequestImplCallbacks={success:function(){var ref;if(callbacks!=null){if((ref=callbacks.success)!=null){ref.apply(callbacks,arguments)}}if(context!=null){return resolve(arguments)}else{return resolve(arguments[0])}},failure:function(){var ref;if(callbacks!=null){if((ref=callbacks.failure)!=null){ref.apply(callbacks,arguments)}}if(context!=null){return reject(KiiUtilities._Error(arguments[1],arguments[0]))}else{return reject(KiiUtilities._Error(arguments[0]))}}};return KiiUser._findUserRequestImplUsingCallbacks(url,findUserRequestImplCallbacks,context)})};KiiUser._findUserRequestImplUsingCallbacks=function(url,callbacks,context){var requestCallbacks,wrapper,xhr;wrapper=KiiXHRWrapperFactory.createXHRWrapper("GET",url);xhr=wrapper.xhr;xhr.setRequestHeader("x-kii-appid",root.Kii.getAppID());xhr.setRequestHeader("x-kii-appkey",root.Kii.getAppKey());xhr.setRequestHeader("x-kii-sdk",root.KiiSDKClientInfo.getSDKClientInfo());if(context!=null){xhr.setRequestHeader("Authorization","Bearer "+context._getToken())}else{xhr.setRequestHeader("Authorization","Bearer "+root.KiiUser.getCurrentUser().getAccessToken())}requestCallbacks={success:function(){var error1,json,user;if(callbacks!=null){try{json=JSON.parse(xhr.responseText);if(context!=null){user=new root.KiiUserWithToken(context._getToken());user._updateWithJSON(json);return callbacks.success(context,user)}else{user=new root.KiiUser;user._updateWithJSON(json);return callbacks.success(user)}}catch(error1){if(context!=null){return callbacks.failure(context,"Unable to parse response")}else{return callbacks.failure("Unable to parse response")}}}},failure:function(){var errString,json;if(callbacks!=null){errString="Failed to find user. statusCode: "+xhr.status;try{json=JSON.parse(xhr.responseText);if(json.errorCode!=null){errString+=" error code: "+json.errorCode}if(json.message!=null){return errString+=" error message: "+json.message}}finally{if(context!=null){callbacks.failure(context,errString)}else{callbacks.failure(errString)}}}}};return wrapper.send(requestCallbacks)};KiiUser.prototype._getXhrWrapper=function(method,url){var wrapper,xhr;wrapper=KiiXHRWrapperFactory.createXHRWrapper(method,url);xhr=wrapper.xhr;xhr.setRequestHeader("x-kii-appid",root.Kii.getAppID());xhr.setRequestHeader("x-kii-appkey",root.Kii.getAppKey());xhr.setRequestHeader("x-kii-sdk",root.KiiSDKClientInfo.getSDKClientInfo());return wrapper};KiiUser.prototype._setAuthHeader=function(xhr){var user;user=root.KiiUser.getCurrentUser();if(user!=null){return xhr.setRequestHeader("Authorization","Bearer "+user.getAccessToken())}};KiiUser.prototype._groupWithJSON=function(json){return root.KiiGroup._groupWithJSON(json)};KiiUser.prototype.topicWithName=function(topicName){var id,puri;if(typeof topicName!=="string"||topicName===""){throw new root.InvalidArgumentException("topicName should not null or empty")}id=this.getID();if(!id){throw"can not instantiate topic from instance which doesn't have ID"}puri=this._getHttpURI();return new root.KiiTopic(puri,topicName)};KiiUser.prototype.listTopics=function(callbacks,paginationKey){return new Promise(function(_this){return function(resolve,reject){var listTopicsCallbacks;listTopicsCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments)},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(arguments[0])}};return _this._listTopicsUsingCallbacks(listTopicsCallbacks,paginationKey)}}(this))};KiiUser.prototype._listTopicsUsingCallbacks=function(callbacks,paginationKey){var listCallbacks,uri,wrapper;uri=this._getHttpURI()+"/topics";if(typeof paginationKey==="string"&&paginationKey!==""){uri=uri+"?paginationKey="+encodeURIComponent(paginationKey)}wrapper=KiiXHRWrapperFactory.createXHRWrapper("GET",uri);wrapper.setKiiHeaders();this._setAuthToken(wrapper);listCallbacks={success:function(_this){return function(){var j,json,len,ref,topic,topics;json=JSON.parse(wrapper.xhr.responseText);topics=[];ref=json.topics;for(j=0,len=ref.length;j<len;j++){topic=ref[j];topics.push(_this.topicWithName(topic.topicID))}return callbacks!=null?callbacks.success(topics,json.paginationKey===void 0?null:json.paginationKey):void 0}}(this),failure:function(_this){return function(){var errObj,errString;errString=wrapper.getErrorString("list topics");errObj=KiiUtilities._Error(errString,_this);return callbacks!=null?callbacks.failure(errObj):void 0}}(this)};return wrapper.send(listCallbacks)};KiiUser.prototype.pushSubscription=function(){return new root.KiiPushSubscription(this)};KiiUser.prototype.pushInstallation=function(){return new root.KiiPushInstallation(this)};KiiUser.prototype._getSubscriberPath=function(){return"users/"+this.getID()};KiiUser.prototype._clone=function(obj){var key,newInstance;if(obj==null||typeof obj!=="object"){return obj}newInstance=new obj.constructor;for(key in obj){newInstance[key]=this._clone(obj[key])}return newInstance};KiiUser.prototype._getHttpURI=function(){return root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+"/users/"+this.getID()};KiiUser.prototype._setAuthToken=function(wrapper){return wrapper.setCurrentUserToken()};return KiiUser}();KiiUtilities=function(){function KiiUtilities(){}KiiUtilities.MAX_DATE_IN_MILLIS=1e8*24*60*60*1e3;KiiUtilities.MIN_DATE_IN_MILLIS=-1e8*24*60*60*1e3;KiiUtilities._validateEmail=function(value){var pattern;value=KiiUtilities._trim(value);pattern=/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,6}$/i;if((typeof value).toLowerCase()!=="string"){root.Kii.logger("Not string");return false}else if(value.match(pattern)){return true}else{return false}};KiiUtilities._validatePhoneNumber=function(value){var pattern;value=KiiUtilities._trim(value);pattern=/^[\\+]?[0-9]{10,}$/i;if((typeof value).toLowerCase()!=="string"){root.Kii.logger("Not string");return false}else if(value.match(pattern)){return true}else{return false}};KiiUtilities._isGlobalPhoneNumber=function(value){var pattern;value=KiiUtilities._trim(value);pattern=/^[\\+]{1}[0-9]{2}/;if((typeof value).toLowerCase()!=="string"){root.Kii.logger("Not string");return false}else if(value.match(pattern)){return true}else{return false}};KiiUtilities._validateLocalPhone=function(value){var pattern;value=KiiUtilities._trim(value);pattern=/^\d+$/;if((typeof value).toLowerCase()!=="string"){root.Kii.logger("Not string");return false}else if(value.match(pattern)){return true}else{root.Kii.logger("Invalid format");return false}};KiiUtilities._assertLocalPhoneIsValid=function(value){if(!KiiUtilities._validateLocalPhone(value)){throw new root.InvalidLocalPhoneNumberException}};KiiUtilities._validateCountryCode=function(value){var pattern;value=KiiUtilities._trim(value);pattern=/^[a-z]{2}$/i;if((typeof value).toLowerCase()!=="string"){root.Kii.logger("Not string");return false}else if(value.match(pattern)){root.Kii.logger("Is true");return true}else{return false}};KiiUtilities._assertCountryCodeIsValid=function(value){if(!KiiUtilities._validateCountryCode(value)){throw new root.InvalidCountryException}};KiiUtilities._validatePassword=function(value){var pattern;root.Kii.logger("Validating password: "+value);pattern=/^[\x20-\x7E]{4,50}$/;if((typeof value).toLowerCase()!=="string"){root.Kii.logger("not string");return false}else if(value.match(pattern)){root.Kii.logger("matched");return true}else{root.Kii.logger("other exception");return false}};KiiUtilities._assertPasswordIsValid=function(value){if(!KiiUtilities._validatePassword(value)){throw new root.InvalidPasswordException}};KiiUtilities._validateUsername=function(value){var pattern;pattern=/^[a-zA-Z0-9-_\\.]{3,64}$/i;if((typeof value).toLowerCase()!=="string"){return false}else if(value.match(pattern)){return true}else{return false}};KiiUtilities._validateGroupID=function(value){var pattern;pattern=/^[a-z0-9-_.]{1,30}$/;if((typeof value).toLowerCase()!=="string"){return false}else if(value.match(pattern)){return true}else{return false}};KiiUtilities._validateDisplayName=function(value){var ref;return KiiUtilities._type(value)==="string"&&(1<=(ref=value.length)&&ref<=50)};KiiUtilities._trim=function(value){var pattern;pattern=/^(\s|\u00A0)+|(\s|\u00A0)+$/g;return(value||"").replace(pattern,"")};KiiUtilities._safeAddTicks=function(left,right){if(isNaN(parseInt(left,10))||isNaN(parseInt(right,10))){throw new root.InvalidArgumentException("Parameters should be a number")}if(Math.abs(left+right)>KiiUtilities.MAX_DATE_IN_MILLIS){throw new root.ArithmeticException("Addition of "+left+" and "+right+" result in long overflow")}return left+right};KiiUtilities._safeMultiplyTicks=function(left,right){if(isNaN(parseInt(left,10))||isNaN(parseInt(right,10))){throw new root.InvalidArgumentException("Parameters should be a number")}if(Math.abs(left*right)>KiiUtilities.MAX_DATE_IN_MILLIS){throw new root.ArithmeticException("Multiplication of "+left+" and "+right+" result in long overflow")}return left*right};KiiUtilities._safeCalculateExpiresAtAsNumber=function(expirationInSeconds,baseUnixTimeInMills){var e,error1,expirationInMillis,expiresAt;expiresAt=0;try{expirationInMillis=KiiUtilities._safeMultiplyTicks(expirationInSeconds,1e3);expiresAt=KiiUtilities._safeAddTicks(baseUnixTimeInMills,expirationInMillis)}catch(error1){e=error1;if(e instanceof root.ArithmeticException){expiresAt=KiiUtilities.MAX_DATE_IN_MILLIS}else{throw e}}return expiresAt};KiiUtilities._safeCalculateExpiresAtAsDate=function(expirationInSeconds,baseUnixTimeInMills){var e,error1,expirationInMillis,expiresAt;expiresAt=0;try{expirationInMillis=KiiUtilities._safeMultiplyTicks(expirationInSeconds,1e3);expiresAt=KiiUtilities._safeAddTicks(baseUnixTimeInMills,expirationInMillis)}catch(error1){e=error1;if(e instanceof root.ArithmeticException){expiresAt=KiiUtilities.MAX_DATE_IN_MILLIS}else{throw e}}return new Date(expiresAt)};KiiUtilities._isJSONType=function(contentType){var pattern;pattern=/\+?json(;.*)?$/i;return contentType.match(pattern)};KiiUtilities._type=function(obj){var classToType;if(obj===void 0||obj===null){return String(obj)}classToType={"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object"};return classToType[Object.prototype.toString.call(obj)]};KiiUtilities._disableCacheURL=function(url){if(url.indexOf("?")!==-1){url+="&disable_cache="}else{url+="?disable_cache="}url+=(new Date).getTime();return url};KiiUtilities._validateServerCodeEntryName=function(value){var pattern;pattern=/^[a-zA-Z][_a-zA-Z0-9]*$/i;return KiiUtilities._type(value)==="string"&&value.match(pattern)};KiiUtilities._validateServerCodeEntryArgument=function(value){return KiiUtilities._type(value)==="null"||KiiUtilities._type(value)==="object"&&Object.keys(value).length>0};KiiUtilities._validateServerCodeEnryVersion=function(value){return KiiUtilities._type(value)==="string"&&value!==""};KiiUtilities._isNonEmptyString=function(s){if(typeof s!=="string"){return false}return s.length>0};KiiUtilities._Error=function(message,target){var e;e=Error(message);e.target=target;return e};return KiiUtilities}();root.KiiSocialConnect=function(){var _instance;function KiiSocialConnect(){}_instance=null;KiiSocialConnect.setupNetwork=function(networkName,apiKey,apiSecret,extras){};KiiSocialConnect.logIn=function(networkName,options,callbacks){if(_instance==null){_instance=new _KiiSocialConnect}return new Promise(function(resolve,reject){var error,error1,errorString,logInCallbacks;logInCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments)},failure:function(){var error;if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}error=KiiUtilities._Error(arguments[2]);error.network=networkName;return reject(error)}};try{return KiiSocialConnect._logInUsingCallbacks(networkName,options,logInCallbacks)}catch(error1){errorString=error1;if(callbacks!=null){if(typeof callbacks.failure==="function"){callbacks.failure(null,networkName,errorString)}}error=KiiUtilities._Error(errorString);error.network=networkName;return reject(error)}})};KiiSocialConnect._logInUsingCallbacks=function(networkName,options,callbacks){var called;called=false;if(_instance!=null){root.Kii.logger("And manager: ");root.Kii.logger(_instance._getManager(networkName));if(_instance._getManager(networkName)){_instance._getManager(networkName)._logIn(options,callbacks);called=true}}root.Kii.logger("Callbacks");root.Kii.logger(callbacks);if(!called&&callbacks!=null){return callbacks.failure(root.KiiUser.getCurrentUser(),networkName,"Unable to get network. Please ensure the network name is one of the supported KiiSocialNetworkName values")}};KiiSocialConnect.linkCurrentUserWithNetwork=function(networkName,options,callbacks){if(_instance==null){_instance=new _KiiSocialConnect}return new Promise(function(resolve,reject){var currentUser,error,error1,errorString,linkCurrentUserWithNetworkCallbacks;linkCurrentUserWithNetworkCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments)},failure:function(){var error;if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}error=KiiUtilities._Error(arguments[2]);error.target=arguments[0];error.network=networkName;return reject(error)}};try{return KiiSocialConnect._linkCurrentUserWithNetworkUsingCallbacks(networkName,options,linkCurrentUserWithNetworkCallbacks)}catch(error1){errorString=error1;currentUser=root.KiiUser.getCurrentUser();if(callbacks!=null){if(typeof callbacks.failure==="function"){callbacks.failure(currentUser,networkName,errorString)}}error=KiiUtilities._Error(errorString);error.target=currentUser;error.network=networkName;return reject(error)}})};KiiSocialConnect._linkCurrentUserWithNetworkUsingCallbacks=function(networkName,options,callbacks){var called;root.Kii.logger("Trying with instance");root.Kii.logger(_instance);called=false;if(_instance!=null){root.Kii.logger("And manager: ");root.Kii.logger(_instance._getManager(networkName));if(_instance._getManager(networkName)){_instance._getManager(networkName)._linkWithCurrentUser(options,callbacks);called=true}}root.Kii.logger("Callbacks");root.Kii.logger(callbacks);if(!called&&callbacks!=null){return callbacks.failure(root.KiiUser.getCurrentUser(),networkName,"Unable to get network. Please ensure the network name is one of the supported KiiSocialNetworkName values")}};KiiSocialConnect.unLinkCurrentUserFromNetwork=function(networkName,callbacks){if(_instance==null){_instance=new _KiiSocialConnect}return new Promise(function(resolve,reject){var unLinkCurrentUserWithNetworkCallbacks;unLinkCurrentUserWithNetworkCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments)},failure:function(){var error;if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}error=KiiUtilities._Error(arguments[2]);error.target=arguments[0];error.network=networkName;return reject(error)}};return KiiSocialConnect._unLinkCurrentUserWithNetworkUsingCallbacks(networkName,unLinkCurrentUserWithNetworkCallbacks)})};KiiSocialConnect._unLinkCurrentUserWithNetworkUsingCallbacks=function(networkName,callbacks){root.Kii.logger("Trying with instance");root.Kii.logger(_instance);if(_instance!=null){root.Kii.logger("And manager: ");root.Kii.logger(_instance._getManager(networkName));if(_instance._getManager(networkName)){return _instance._getManager(networkName)._unlinkFromCurrentUser(callbacks)}}else if(callbacks!=null){return callbacks.failure(root.KiiUser.getCurrentUser(),networkName,"Unable to get network. Please ensure the network name is one of the supported KiiSocialNetworkName values")}};KiiSocialConnect.getAccessTokenForNetwork=function(networkName){return _instance!=null?_instance._getManager(networkName)._getToken():void 0};KiiSocialConnect.getAccessTokenExpirationForNetwork=function(networkName){return _instance!=null?_instance._getManager(networkName)._getTokenExpiration():void 0};KiiSocialConnect.getAccessTokenObjectForNetwork=function(networkName){return _instance!=null?_instance._getManager(networkName)._getTokenObject():void 0};KiiSocialConnect.logOutAll=function(){var fb,google,qq,renren,tw;if(_instance!=null){fb=_instance._getManager(root.KiiSocialNetworkName.FACEBOOK);if(fb!=null){fb._logOut()}tw=_instance._getManager(root.KiiSocialNetworkName.TWITTER);if(tw!=null){tw._logOut()}qq=_instance._getManager(root.KiiSocialNetworkName.QQ);if(qq!=null){qq._logOut()}google=_instance._getManager(root.KiiSocialNetworkName.GOOGLEPLUS);if(google!=null){google._logOut()}renren=_instance._getManager(root.KiiSocialNetworkName.RENREN);if(renren!=null){return renren._logOut()}}};return KiiSocialConnect}();_KiiSocialConnect=function(){function _KiiSocialConnect(){this._getManager=bind(this._getManager,this)}_KiiSocialConnect.prototype._getManager=function(networkName){if(networkName===root.KiiSocialNetworkName.FACEBOOK){if(this._facebookManager!=null){return this._facebookManager}else{return this._facebookManager=new root.KiiSCNFacebook}}else if(networkName===root.KiiSocialNetworkName.TWITTER){if(this._twitterManager!=null){return this._twitterManager}else{return this._twitterManager=new root.KiiSCNTwitter}}else if(networkName===root.KiiSocialNetworkName.QQ){if(this._qqManager!=null){return this._qqManager}else{return this._qqManager=new root.KiiSCNQQ}}else if(networkName===root.KiiSocialNetworkName.GOOGLEPLUS){if(this._googleManager!=null){return this._googleManager}else{return this._googleManager=new root.KiiSCNGoogle}}else if(networkName===root.KiiSocialNetworkName.RENREN){if(this._renrenManager!=null){return this._renrenManager}else{return this._renrenManager=new root.KiiSCNRenRen}}};return _KiiSocialConnect}();root.KiiSocialConnectNetwork=function(){KiiSocialConnectNetwork.prototype._className="KiiSocialConnectNetwork";KiiSocialConnectNetwork.prototype._setNetwork=function(_network){this._network=_network};KiiSocialConnectNetwork.prototype._getNetwork=function(){return this._network};KiiSocialConnectNetwork.prototype._setToken=function(_token){this._token=_token};KiiSocialConnectNetwork.prototype._getToken=function(){return this._token};KiiSocialConnectNetwork.prototype._setTokenExpiration=function(_tokenExpiration){this._tokenExpiration=_tokenExpiration};KiiSocialConnectNetwork.prototype._getTokenExpiration=function(){return this._tokenExpiration};KiiSocialConnectNetwork.prototype._setTokenObject=function(_tokenObject){this._tokenObject=_tokenObject};KiiSocialConnectNetwork.prototype._getTokenObject=function(){return this._tokenObject};function KiiSocialConnectNetwork(_network){this._network=_network;this._unlink=bind(this._unlink,this);this._link=bind(this._link,this);this._register=bind(this._register,this);this._getAccessToken=bind(this._getAccessToken,this);this._createTokenObject=bind(this._createTokenObject,this);this._unlinkFromCurrentUser=bind(this._unlinkFromCurrentUser,this);this._linkWithCurrentUser=bind(this._linkWithCurrentUser,this);this._logOut=bind(this._logOut,this);this._logIn=bind(this._logIn,this);this._isAuthenticated=bind(this._isAuthenticated,this);this._getTokenObject=bind(this._getTokenObject,this);this._setTokenObject=bind(this._setTokenObject,this);this._getTokenExpiration=bind(this._getTokenExpiration,this);this._setTokenExpiration=bind(this._setTokenExpiration,this);this._getToken=bind(this._getToken,this);this._setToken=bind(this._setToken,this);this._getNetwork=bind(this._getNetwork,this);this._setNetwork=bind(this._setNetwork,this);this._tokenExpiration=null;this._token=null}KiiSocialConnectNetwork.prototype._isAuthenticated=function(){return this._tokenObject!=null};KiiSocialConnectNetwork.prototype._logIn=function(options,callbacks){};KiiSocialConnectNetwork.prototype._logOut=function(){this._token=null;this._tokenExpiration=null;return this._tokenObject=null};KiiSocialConnectNetwork.prototype._linkWithCurrentUser=function(options,callbacks){};KiiSocialConnectNetwork.prototype._unlinkFromCurrentUser=function(callbacks){};KiiSocialConnectNetwork.prototype._createTokenObject=function(options,data){};KiiSocialConnectNetwork.prototype._getAccessToken=function(options){};KiiSocialConnectNetwork.prototype._register=function(providerName,contentType,requestData,options,callbacks){var currentTime,now,registrationCallbacks,request,token;if(root.Kii.getAccessTokenExpiration()>0){now=new Date;currentTime=now.getTime();requestData.expiresAt=KiiUtilities._safeCalculateExpiresAtAsNumber(root.Kii.getAccessTokenExpiration(),currentTime)}request=new KiiRequest("/integration/"+providerName,true);request.setMethod("POST");request.setData(requestData);request.setAnonymous(true);request.setContentType(contentType);token=this._getAccessToken(options);registrationCallbacks={success:function(_this){return function(data){var refreshCallback,tokenObject,user,value;_this._setToken(token);tokenObject=_this._createTokenObject(options,data);_this._setTokenObject(tokenObject);user=new root.KiiUser;user._updateWithJSON(data);user._setAccessToken(data["access_token"]);if(data.expires_in!=null){now=new Date;currentTime=now.getTime();value=KiiUtilities._safeCalculateExpiresAtAsDate(data.expires_in,currentTime);user._setExpiresAt(value)}root.Kii.setCurrentUser(user);refreshCallback={success:function(refreshedUser){if(callbacks!=null){return callbacks.success(refreshedUser,_this._network)}},failure:function(theUser,error){if(callbacks!=null){return callbacks.failure(theUser,_this._network,error)}}};return user.refresh(refreshCallback)}}(this),failure:function(_this){return function(error,statusCode){if(callbacks!=null){return callbacks.failure(null,_this._network,error)}}}(this)};return request.execute(registrationCallbacks,false)};KiiSocialConnectNetwork.prototype._link=function(providerName,contentType,requestData,options,callbacks){var linkCallbacks,request,token;request=new KiiRequest("/users/me/"+providerName+"/link",true);request.setMethod("POST");request.setData(requestData);request.setContentType(contentType);token=this._getAccessToken(options);linkCallbacks={success:function(_this){return function(data){var refreshCallback,tokenObject;_this._setToken(token);tokenObject=_this._createTokenObject(options,data);_this._setTokenObject(tokenObject);refreshCallback={success:function(refreshedUser){if(callbacks!=null){return callbacks.success(refreshedUser,_this._network)}},failure:function(theUser,error){if(callbacks!=null){return callbacks.failure(theUser,_this._network,error)}}};return root.KiiUser.getCurrentUser().refresh(refreshCallback)}}(this),failure:function(_this){return function(error,statusCode){if(callbacks!=null){return callbacks.failure(root.KiiUser.getCurrentUser(),_this._network,error)}}}(this)};return request.execute(linkCallbacks,true)};KiiSocialConnectNetwork.prototype._unlink=function(providerName,callbacks){var request,unlinkCallbacks;request=new KiiRequest("/users/me/"+providerName+"/unlink",true);request.setMethod("POST");unlinkCallbacks={success:function(_this){return function(data){_this._setToken(null);_this._setTokenExpiration(null);_this._setTokenObject(null);if(callbacks!=null){return callbacks.success(root.KiiUser.getCurrentUser(),_this._network)}}}(this),failure:function(_this){return function(error,statusCode){if(callbacks!=null){return callbacks.failure(root.KiiUser.getCurrentUser(),_this._network,error)}}}(this)};return request.execute(unlinkCallbacks,true)};return KiiSocialConnectNetwork}();root.KiiSCNFacebook=function(superClass){extend(KiiSCNFacebook,superClass);function KiiSCNFacebook(){this._unlinkFromCurrentUser=bind(this._unlinkFromCurrentUser,this);this._linkWithCurrentUser=bind(this._linkWithCurrentUser,this);this._logOut=bind(this._logOut,this);this._logIn=bind(this._logIn,this);this._getAccessToken=bind(this._getAccessToken,this);this._createTokenObject=bind(this._createTokenObject,this);this._setup=bind(this._setup,this);KiiSCNFacebook.__super__.constructor.call(this,root.KiiSocialNetworkName.FACEBOOK)}KiiSCNFacebook.prototype._setup=function(_key,_secret,_extras){this._key=_key;this._secret=_secret;this._extras=_extras;return KiiSCNFacebook.__super__._setup.call(this,this._key,this._secret,this._extras)};KiiSCNFacebook.prototype._createTokenObject=function(options,data){var tokenObject;tokenObject={access_token:options.access_token};if(data!=null&&data.new_user_created!=null){tokenObject["kii_new_user"]=data.new_user_created}return tokenObject};KiiSCNFacebook.prototype._getAccessToken=function(options){return options.access_token};KiiSCNFacebook.prototype._logIn=function(options,callbacks){var requestData;root.Kii.logger("should auth fb");root.Kii.logger("Checking options");if(options==null||!options.access_token){throw root.InvalidArgumentException("options.access_token is required")}if(root.KiiUser.getCurrentUser()!=null){root.KiiUser.logOut()}requestData={accessToken:options.access_token};return this._register("facebook","application/vnd.kii.AuthTokenFacebookRequest+json",requestData,options,callbacks)};KiiSCNFacebook.prototype._logOut=function(){KiiSCNFacebook.__super__._logOut.apply(this,arguments);return root.Kii.logger("Log out fb")};KiiSCNFacebook.prototype._linkWithCurrentUser=function(options,callbacks){var requestData;if(root.KiiUser.getCurrentUser()!=null){if(options==null||!options.access_token){throw root.InvalidArgumentException("options.access_token is required")}requestData={accessToken:options.access_token};return this._link("facebook","application/vnd.kii.LinkFacebookRequest+json",requestData,options,callbacks)}else if(callbacks!=null){return callbacks.failure(null,this._network,"A KiiUser must be logged in before linking to Facebook")}};KiiSCNFacebook.prototype._unlinkFromCurrentUser=function(callbacks){if(root.KiiUser.getCurrentUser()!=null){return this._unlink("facebook",callbacks)}else if(callbacks!=null){return callbacks.failure("A KiiUser must be logged in before unlinking from Facebook")}};return KiiSCNFacebook}(root.KiiSocialConnectNetwork);root.InvalidDisplayNameException=function(){return this.message="Unable to set displayName. Must be between 1-50 characters."};root.InvalidPasswordException=function(){return this.message="Unable to set password. Must be between 4-50 characters composed with ascii (exclude control character)"};root.InvalidUsernameException=function(){return this.message="Unable to set username. Must be between 3 and 64 characters, which can include alphanumeric characters as well as underscores '_' and periods '.'"};root.InvalidUserIdentifierException=function(){return this.message="User identifier should be one of user name, phone number or email"};root.InvalidEmailException=function(){return this.message="Unable to set email address. Must be a valid email"};root.InvalidPhoneNumberException=function(){return this.message="Unable to set phone number. Must begin with a '+' and be at least 10 digits"};root.InvalidLocalPhoneNumberException=function(){return this.message="Unable to set phone number. Must be a sequence of numbers"};root.InvalidCountryException=function(){return this.message="Unable to set country code. Must be 2 alphabetic characters. Ex: US, JP, CN"};root.InvalidURIException=function(){return this.message="Unable to set URI. Must be of the form kiicloud://some/path/to/object/or/entity"};root.InvalidACLAction=function(){return this.message="Unable to set ACL action. Must be one of the permitted values in KiiACLAction"};root.InvalidACLSubject=function(){return this.message="Unable to set ACL subject. Must be of type KiiUser or KiiGroup"};root.InvalidACLGrant=function(){return this.message="Unable to set ACL grant. Must be a boolean type"};root.InvalidLimitException=function(){return this.message="Unable to set query limit. Must be an integer > 0"};root.InvalidArgumentException=function(message){return this.message="InvalidArgument: "+message};root.IllegalStateException=function(message){return this.message="IllegalState: "+message};root.ArithmeticException=function(message){return this.message="ArithmeticException: "+message};root.UnsupportedOperationException=function(message){return this.message="UnsupportedOperationException: "+message};root.KiiAppAdminContext=function(){function KiiAppAdminContext(spec){this.listTopics=bind(this.listTopics,this);this.topicWithName=bind(this.topicWithName,this);this.loadThingWithThingID=bind(this.loadThingWithThingID,this);this.loadThingWithVendorThingID=bind(this.loadThingWithVendorThingID,this);this.registerOwnerWithVendorThingID=bind(this.registerOwnerWithVendorThingID,this);this.registerOwnerWithThingID=bind(this.registerOwnerWithThingID,this);this.thingWithID=bind(this.thingWithID,this);this.registerThing=bind(this.registerThing,this);this.registerGroupWithOwnerAndID=bind(this.registerGroupWithOwnerAndID,this);this._getToken=bind(this._getToken,this);this._getId=bind(this._getId,this);this._objectWithURI=bind(this._objectWithURI,this);this._token=spec.token;this._id=spec.id}KiiAppAdminContext.prototype.bucketWithName=function(bucketName){var adminBucket;adminBucket=new root.KiiBucketWithToken(bucketName,null,this._token);return adminBucket};KiiAppAdminContext.prototype.encryptedBucketWithName=function(bucketName){var bucket;bucket=new root.KiiEncryptedBucketWithToken(bucketName,null,this._token);return bucket};KiiAppAdminContext.prototype.groupWithName=function(groupName){var group;group=root.KiiGroupWithToken._groupWithName(groupName,this._token);return group};KiiAppAdminContext.prototype.userWithID=function(userid){var user;user=root.KiiUserWithToken._userWithID(userid,this._token);return user};KiiAppAdminContext.prototype.objectWithURI=function(objectURI){var object;object=this._objectWithURI(objectURI);return object};KiiAppAdminContext.prototype._userWithLoginName=function(loginName,callbacks){
var refreshCallbacks,request,user;user=new root.KiiUserWithToken(this._token);request=user._getRequest({path:"/users/LOGIN_NAME:"+loginName,withApp:true});request.setAdminToken(this._token);refreshCallbacks={success:function(_this){return function(data,statusCode){if(statusCode<300&&statusCode>=200){user._updateWithJSON(data);if(callbacks!=null){return callbacks.success(user)}}else if(callbacks!=null){return callbacks.failure("Unable to parse response")}}}(this),failure:function(_this){return function(error,statusCode){if(callbacks!=null){return callbacks.failure(error)}}}(this)};return request.execute(refreshCallbacks,false)};KiiAppAdminContext.prototype._objectWithURI=function(objectUri){var bucket,bucketIndex,bucketName,compLength,components,newURI,obj,subject,valid;if(!objectUri){throw new root.InvalidURIException}valid=objectUri.indexOf("kiicloud://")===0;newURI=objectUri.substr("kiicloud://".length);components=newURI.split("/");compLength=components.length;if(compLength>=4&&valid){bucketIndex=compLength===4?1:3;bucketName=components[bucketIndex];subject=null;if(components[0]==="groups"&&compLength===6){subject=new root.KiiGroupWithToken._groupWithID(components[1],this._token)}else if(components[0]==="users"&&compLength===6){subject=root.KiiUserWithToken._userWithID(components[1],this._token)}else if(components[0]==="things"&&compLength===6){subject=root.KiiThingWithToken.thingWithID(components[1],this._token)}else if(compLength!==4){throw new root.InvalidURIException}bucket=new root.KiiBucketWithToken(bucketName,subject,this._token);obj=bucket.createObject();obj._setUUID(components[compLength-1])}else{throw new root.InvalidURIException}return obj};KiiAppAdminContext.prototype._getId=function(){return this._id};KiiAppAdminContext.prototype._getToken=function(){return this._token};KiiAppAdminContext.prototype.groupWithID=function(groupID){var group;if(groupID==null||groupID===""){throw new root.InvalidArgumentException("groupID should not null or empty")}group=root.KiiGroupWithToken._groupWithID(groupID,this._token);return group};KiiAppAdminContext.prototype.registerGroupWithOwnerAndID=function(groupID,groupName,owner,members,callbacks){return new Promise(function(_this){return function(resolve,reject){var registerGroupWithIDCallbacks;registerGroupWithIDCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments[0])},failure:function(){var error;if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}error=KiiUtilities._Error(arguments[1],arguments[0]);error.addMembersArray=arguments[2];error.removeMembersArray=arguments[3];return reject(error)}};return root.KiiGroup._registerGroupWithIDUsingCallbacks(_this._token,groupID,groupName,owner,members,registerGroupWithIDCallbacks)}}(this))};KiiAppAdminContext.prototype.groupWithURI=function(groupUri){var components,group,newURI;if(groupUri==null){throw new root.InvalidURIException}if(groupUri.indexOf("kiicloud://")!==0){throw new root.InvalidURIException}newURI=groupUri.substr("kiicloud://".length);components=newURI.split("/");if(components.length!==2||components[0]!=="groups"){throw new root.InvalidURIException}group=root.KiiGroupWithToken._groupWithID(components[1],this._token);return group};KiiAppAdminContext.prototype.findUserByEmail=function(email,callbacks){return root.KiiUser._findUserByEmail(email,callbacks,this)};KiiAppAdminContext.prototype.findUserByPhone=function(phone,callbacks){return root.KiiUser._findUserByPhone(phone,callbacks,this)};KiiAppAdminContext.prototype.findUserByUsername=function(username,callbacks){return root.KiiUser._findUserByUsername(username,callbacks,this)};KiiAppAdminContext.prototype.registerThing=function(fields,callbacks){return root.KiiThingWithToken.register(fields,callbacks,this._token)};KiiAppAdminContext.prototype.thingWithID=function(thingID){return root.KiiThingWithToken.thingWithID(thingID,this._token)};KiiAppAdminContext.prototype.registerOwnerWithThingID=function(thingID,owner,callbacks){return root.KiiThingWithToken.registerOwnerWithThingID(thingID,owner,callbacks,this._token)};KiiAppAdminContext.prototype.registerOwnerWithVendorThingID=function(vendorThingID,owner,callbacks){return root.KiiThingWithToken.registerOwnerWithVendorThingID(vendorThingID,owner,callbacks,this._token)};KiiAppAdminContext.prototype.thingWithID=function(thingID){return root.KiiThingWithToken.thingWithID(thingID,this._token)};KiiAppAdminContext.prototype.loadThingWithVendorThingID=function(vendorThingID,callbacks){return root.KiiThingWithToken.loadWithVendorThingID(vendorThingID,callbacks,this._token)};KiiAppAdminContext.prototype.loadThingWithThingID=function(thingID,callbacks){return root.KiiThingWithToken.loadWithThingID(thingID,callbacks,this._token)};KiiAppAdminContext.prototype.topicWithName=function(topicName){if(typeof topicName!=="string"||topicName===""){throw new root.InvalidArgumentException("topicName should not null or empty")}return new root.KiiTopicWithToken(root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID(),topicName,this._token)};KiiAppAdminContext.prototype.listTopics=function(callbacks,paginationKey){return root.Kii._listTopics(callbacks,paginationKey,this)};return KiiAppAdminContext}();root.KiiACLWithToken=function(superClass){extend(KiiACLWithToken,superClass);function KiiACLWithToken(parent,authToken){this._userWithID=bind(this._userWithID,this);this._groupWithID=bind(this._groupWithID,this);this._getRequest=bind(this._getRequest,this);KiiACLWithToken.__super__.constructor.call(this);this._setParent(parent);this._authToken=authToken}KiiACLWithToken.prototype._getRequest=function(spec){var request;request=KiiACLWithToken.__super__._getRequest.call(this,spec);request.setAdminToken(this._authToken);return request};KiiACLWithToken.prototype._groupWithID=function(id){var group;group=root.KiiGroupWithToken._groupWithID(id,this._authToken);return group};KiiACLWithToken.prototype._userWithID=function(id){var user;user=root.KiiUserWithToken._userWithID(id,this._authToken);return user};return KiiACLWithToken}(root.KiiACL);root.KiiGroupWithToken=function(superClass){extend(KiiGroupWithToken,superClass);function KiiGroupWithToken(authToken){this.topicWithName=bind(this.topicWithName,this);this._setAuthToken=bind(this._setAuthToken,this);this._setOwnerFromContext=bind(this._setOwnerFromContext,this);this._userWithID=bind(this._userWithID,this);this.bucketWithName=bind(this.bucketWithName,this);this._getRequest=bind(this._getRequest,this);KiiGroupWithToken.__super__.constructor.call(this);this._authToken=authToken}KiiGroupWithToken.prototype._getRequest=function(spec){var request;request=KiiGroupWithToken.__super__._getRequest.call(this,spec);request.setAdminToken(this._authToken);return request};KiiGroupWithToken._groupWithName=function(groupName,authToken){return root.KiiGroupWithToken._groupWithNameAndMembers(groupName,null,authToken)};KiiGroupWithToken._groupWithNameAndMembers=function(groupName,members,authToken){var group;group=new root.KiiGroupWithToken(authToken);group._setName(groupName);group._setAddMembers(members);return group};KiiGroupWithToken._groupWithID=function(id,authToken){var group;group=new root.KiiGroupWithToken(authToken);group._setUUID(id);return group};KiiGroupWithToken.prototype.bucketWithName=function(name){var bucket;bucket=new root.KiiBucketWithToken(name,this,this._authToken);return bucket};KiiGroupWithToken.prototype.encryptedBucketWithName=function(name){var bucket;bucket=new root.KiiEncryptedBucketWithToken(name,this,this._authToken);return bucket};KiiGroupWithToken.prototype._userWithID=function(id){var user;user=root.KiiUserWithToken._userWithID(id,this._authToken);return user};KiiGroupWithToken.prototype._setOwnerFromContext=function(data){};KiiGroupWithToken._groupWithJSON=function(json,authToken){var group;group=new root.KiiGroupWithToken(authToken);if(json.groupID!=null){group._setUUID(json.groupID)}if(json.name!=null){group._setName(json.name)}if(json.owner!=null){group._setOwner(root.KiiUserWithToken._userWithID(json.owner,authToken))}return group};KiiGroupWithToken.prototype._setAuthToken=function(wrapper){return wrapper.setAuthToken(this._authToken)};KiiGroupWithToken.prototype.topicWithName=function(topicName){var id,puri;if(typeof topicName!=="string"||topicName===""){throw new root.InvalidArgumentException("topicName should not null or empty")}id=this.getID();if(!id){throw"can not instantiate topic from instance which doesn't have ID"}puri=this._getHttpURI();return new root.KiiTopicWithToken(puri,topicName,this._authToken)};return KiiGroupWithToken}(root.KiiGroup);root.KiiObjectWithToken=function(superClass){extend(KiiObjectWithToken,superClass);function KiiObjectWithToken(token){this._userWithID=bind(this._userWithID,this);this.objectACL=bind(this.objectACL,this);this._getToken=bind(this._getToken,this);this._getRequest=bind(this._getRequest,this);KiiObjectWithToken.__super__.constructor.call(this);this._authToken=token}KiiObjectWithToken.prototype._getRequest=function(spec){var request;root.Kii.logger("admin req: "+this._authToken);request=KiiObjectWithToken.__super__._getRequest.call(this,spec);request.setAdminToken(this._authToken);return request};KiiObjectWithToken.prototype._getToken=function(){if(this._authToken){return this._authToken}else{return null}};KiiObjectWithToken.objectWithBucket=function(bucket,type,authToken){var obj;root.Kii.logger("Creating object w type: "+type);obj=new root.KiiObjectWithToken(authToken);obj._setBucket(bucket);obj._setObjectType(type);root.Kii.logger(obj);return obj};KiiObjectWithToken.objectWithID=function(bucket,id,authToken){var obj;root.Kii.logger("Creating object w id: "+id);obj=new root.KiiObjectWithToken(authToken);obj._setBucket(bucket);obj._setUUID(id);root.Kii.logger(obj);return obj};KiiObjectWithToken.prototype.objectACL=function(){var acl;acl=new root.KiiACLWithToken(this,this._authToken);return acl};KiiObjectWithToken.prototype._userWithID=function(id){var user;user=root.KiiUserWithToken._userWithID(id,this._authToken);return user};return KiiObjectWithToken}(root.KiiObject);root.KiiUserWithToken=function(superClass){extend(KiiUserWithToken,superClass);function KiiUserWithToken(authToken){this.pushInstallation=bind(this.pushInstallation,this);this.topicWithName=bind(this.topicWithName,this);this.pushSubscription=bind(this.pushSubscription,this);this._groupWithJSON=bind(this._groupWithJSON,this);this.bucketWithName=bind(this.bucketWithName,this);this._setAuthHeader=bind(this._setAuthHeader,this);this._setAuthToken=bind(this._setAuthToken,this);this._getRequest=bind(this._getRequest,this);KiiUserWithToken.__super__.constructor.call(this);this._authToken=authToken}KiiUserWithToken._userWithID=function(id,authToken){var user;user=new root.KiiUserWithToken(authToken);user._setUUID(id);return user};KiiUserWithToken.prototype._getRequest=function(spec){var request;request=KiiUserWithToken.__super__._getRequest.call(this,spec);request.setAdminToken(this._authToken);return request};KiiUserWithToken.prototype._setAuthToken=function(wrapper){return wrapper.setAuthToken(this._authToken)};KiiUserWithToken.prototype._setAuthHeader=function(xhr){return xhr.setRequestHeader("Authorization","Bearer "+this._authToken)};KiiUserWithToken.prototype.bucketWithName=function(bucketName){var bucket;bucket=new root.KiiBucketWithToken(bucketName,this,this._authToken);return bucket};KiiUserWithToken.prototype.encryptedBucketWithName=function(bucketName){var bucket;bucket=new root.KiiEncryptedBucketWithToken(bucketName,this,this._authToken);return bucket};KiiUserWithToken.prototype._groupWithJSON=function(json){var group;group=new root.KiiGroupWithToken._groupWithJSON(json,this._authToken);return group};KiiUserWithToken.prototype.pushSubscription=function(){return new root.KiiPushSubscriptionWithToken(this,this._authToken)};KiiUserWithToken.prototype.topicWithName=function(topicName){var id;if(typeof topicName!=="string"||topicName===""){throw new root.InvalidArgumentException("topicName should not null or empty")}id=this.getID();if(!id){throw"can not instantiate topic from instance which doesn't have ID"}return new root.KiiTopicWithToken(this._getHttpURI(),topicName,this._authToken)};KiiUserWithToken.prototype.pushInstallation=function(){throw new root.UnsupportedOperationException("Push installation is not supported by admin context")};return KiiUserWithToken}(root.KiiUser);root.KiiAnonymousUser=function(){function KiiAnonymousUser(){this.getID=bind(this.getID,this)}KiiAnonymousUser.prototype.getID=function(){return"ANONYMOUS_USER"};return KiiAnonymousUser}();root.KiiAnyAuthenticatedUser=function(){function KiiAnyAuthenticatedUser(){this.getID=bind(this.getID,this)}KiiAnyAuthenticatedUser.prototype.getID=function(){return"ANY_AUTHENTICATED_USER"};return KiiAnyAuthenticatedUser}();root.KiiSDKClientInfo=function(){function KiiSDKClientInfo(){}KiiSDKClientInfo.getSDKClientInfo=function(){if(KiiSDKClientInfo._clientInfo==null){KiiSDKClientInfo._clientInfo="sn=jss;sv="+root.Kii.getSDKVersion()}return KiiSDKClientInfo._clientInfo};return KiiSDKClientInfo}();root.KiiSCNTwitter=function(superClass){extend(KiiSCNTwitter,superClass);function KiiSCNTwitter(){this._unlinkFromCurrentUser=bind(this._unlinkFromCurrentUser,this);this._linkWithCurrentUser=bind(this._linkWithCurrentUser,this);this._logOut=bind(this._logOut,this);this._logIn=bind(this._logIn,this);this._getAccessToken=bind(this._getAccessToken,this);this._createTokenObject=bind(this._createTokenObject,this);this._setup=bind(this._setup,this);KiiSCNTwitter.__super__.constructor.call(this,root.KiiSocialNetworkName.TWITTER)}KiiSCNTwitter.prototype._setup=function(_key,_secret,_extras){this._key=_key;this._secret=_secret;this._extras=_extras;return KiiSCNTwitter.__super__._setup.call(this,this._key,this._secret,this._extras)};KiiSCNTwitter.prototype._createTokenObject=function(options,data){var tokenObject;tokenObject={oauth_token:options.oauth_token,oauth_token_secret:options.oauth_token_secret};if(data!=null&&data.new_user_created!=null){tokenObject["kii_new_user"]=data.new_user_created}return tokenObject};KiiSCNTwitter.prototype._getAccessToken=function(options){return options.oauth_token};KiiSCNTwitter.prototype._logIn=function(options,callbacks){var requestData;root.Kii.logger("Checking options");root.Kii.logger(options);if(options==null||!options.oauth_token&&!options.oauth_token_secret){throw root.InvalidArgumentException("Both options.oauth_token and options.oauth_token_secret are required")}else if(!options.oauth_token){throw root.InvalidArgumentException("options.oauth_token is required")}else if(!options.oauth_token_secret){throw root.InvalidArgumentException("options.oauth_token_secret is required")}if(root.KiiUser.getCurrentUser()!=null){root.KiiUser.logOut()}requestData={accessToken:options.oauth_token,accessTokenSecret:options.oauth_token_secret};return this._register("twitter","application/vnd.kii.AuthTokenTwitterRequest+json",requestData,options,callbacks)};KiiSCNTwitter.prototype._logOut=function(){KiiSCNTwitter.__super__._logOut.apply(this,arguments);return root.Kii.logger("Log out twitter")};KiiSCNTwitter.prototype._linkWithCurrentUser=function(options,callbacks){var requestData;if(root.KiiUser.getCurrentUser()==null){callbacks.failure(null,this._network,"No user logged in");return}if(options==null||!options.oauth_token&&!options.oauth_token_secret){throw root.InvalidArgumentException("Both options.oauth_token and options.oauth_token_secret are required")}else if(!options.oauth_token){throw root.InvalidArgumentException("options.oauth_token is required")}else if(!options.oauth_token_secret){throw root.InvalidArgumentException("options.oauth_token_secret is required")}requestData={accessToken:options.oauth_token,accessTokenSecret:options.oauth_token_secret};return this._link("twitter","application/vnd.kii.LinkTwitterRequest+json",requestData,options,callbacks)};KiiSCNTwitter.prototype._unlinkFromCurrentUser=function(callbacks){if(root.KiiUser.getCurrentUser()==null){callbacks.failure(null,this._network,"No user logged in");return}return this._unlink("twitter",callbacks)};return KiiSCNTwitter}(root.KiiSocialConnectNetwork);root.KiiGeoPoint=function(){function KiiGeoPoint(_latitude,_longitude){var inRange;this._latitude=_latitude;this._longitude=_longitude;this._toDict=bind(this._toDict,this);this.getLongitude=bind(this.getLongitude,this);this.getLatitude=bind(this.getLatitude,this);inRange=function(min,max,num){return num>min&&num<max&&!isNaN(num)};if(!inRange(-90,90,this._latitude)||!inRange(-180,180,this._longitude)){throw root.InvalidArgumentException("Specified latitide or longitude is invalid")}}KiiGeoPoint.prototype.getLatitude=function(){return this._latitude};KiiGeoPoint.prototype.getLongitude=function(){return this._longitude};KiiGeoPoint.geoPoint=function(latitude,longitude){return new root.KiiGeoPoint(latitude,longitude)};KiiGeoPoint.prototype._toDict=function(){var dict;dict={_type:"point",lat:this._latitude,lon:this._longitude};return dict};return KiiGeoPoint}();KiiJQueryHttpRequest=function(){function KiiJQueryHttpRequest(method,url,callbacks){this.xhr=$.ajaxSettings.xhr();url=KiiUtilities._disableCacheURL(url);this.xhr.open(method,url,true);this.xhr.onreadystatechange=callbacks.onComplete}return KiiJQueryHttpRequest}();KiiXMLHttpRequest=function(){function KiiXMLHttpRequest(method,url,callbacks){url=KiiUtilities._disableCacheURL(url);this.xhr=new XMLHttpRequest;if("withCredentials"in this.xhr){this.xhr.open(method,url,true);this.xhr.onreadystatechange=callbacks.onComplete}else{this.xhr=null}}return KiiXMLHttpRequest}();KiiTitaniumHttpRequest=function(){function KiiTitaniumHttpRequest(method,url,callbacks){this.xhr=Ti.Network.createHTTPClient();url=KiiUtilities._disableCacheURL(url);this.xhr.open(method,url,true);this.xhr.onload=callbacks.onComplete;this.xhr.onerror=callbacks.onError}return KiiTitaniumHttpRequest}();KiiXHRWrapperFactory=function(){function KiiXHRWrapperFactory(){}KiiXHRWrapperFactory.createXHRWrapper=function(method,url){var wrapper;wrapper=null;if(root.Kii._getHttpRequestType()===null){if(typeof jQuery!=="undefined"){root.Kii.logger("Use jQuery");wrapper=new KiiJQXHRWrapper(method,url)}else if(typeof XMLHttpRequest!=="undefined"){root.Kii.logger("Use XMLHttpRequest");wrapper=new KiiXHRWrapper(method,url)}else if(typeof Titanium!=="undefined"){root.Kii.logger("Use Titanium");wrapper=new KiiTiXHRWrapper(method,url)}}else{root.Kii.logger("Use http request backdoor");if(root.Kii._getHttpRequestType()===root._KiiHttpRequestType.jQuery){root.Kii.logger("Use jQuery");wrapper=new KiiJQXHRWrapper(method,url)}else if(root.Kii._getHttpRequestType()===root._KiiHttpRequestType.XMLHttpRequest){root.Kii.logger("Use XMLHttpRequest");wrapper=new KiiXHRWrapper(method,url)}else if(root.Kii._getHttpRequestType()===root._KiiHttpRequestType.Titanium){root.Kii.logger("Use Titanium");wrapper=new KiiTiXHRWrapper(method,url)}}return wrapper};return KiiXHRWrapperFactory}();KiiXHRWrapper=function(){KiiXHRWrapper.prototype.getAppID=function(){return root.Kii.getAppID()};KiiXHRWrapper.prototype.getAppKey=function(){return root.Kii.getAppKey()};KiiXHRWrapper.prototype.getLogger=function(){return root.Kii.logger()};function KiiXHRWrapper(method,url){this.setAuthToken=bind(this.setAuthToken,this);this.setAdminOrUserToken=bind(this.setAdminOrUserToken,this);this.setCurrentUserToken=bind(this.setCurrentUserToken,this);this.setContentType=bind(this.setContentType,this);this.setKiiHeaders=bind(this.setKiiHeaders,this);this.getErrorCode=bind(this.getErrorCode,this);this.getErrorString=bind(this.getErrorString,this);this.sendData=bind(this.sendData,this);this.send=bind(this.send,this);this._setUpCallbacks=bind(this._setUpCallbacks,this);var hs,k,v;url=KiiUtilities._disableCacheURL(url);this.xhr=new XMLHttpRequest;this.method=method;if("withCredentials"in this.xhr){this.xhr.open(method,url,true);hs=root.Kii.getAdditionalHeaders();if(hs!=null){for(k in hs){v=hs[k];this.xhr.setRequestHeader(k,v)}}}else{this.xhr=null}}KiiXHRWrapper.prototype._setUpCallbacks=function(callback){if(callback&&callback.progress){if(this.method==="PUT"){return this.xhr.upload.addEventListener("progress",callback.progress,false)}else{return this.xhr.addEventListener("progress",callback.progress,false)}}};KiiXHRWrapper.prototype.send=function(sendCallbacks){var requestCallback;this._setUpCallbacks(sendCallbacks);requestCallback={onComplete:function(_this){return function(){var ref;if(_this.xhr.readyState===4){if(200<=(ref=_this.xhr.status)&&ref<400){_this.getLogger("Completed Request["+_this.xhr.status+"]");if(sendCallbacks!=null){return sendCallbacks.success()}}else{_this.getLogger("Error loading data...");_this.getLogger("callback : "+sendCallbacks);if(sendCallbacks!=null){return sendCallbacks.failure()}}}}}(this)};this.xhr.onreadystatechange=requestCallback.onComplete;return this.xhr.send()};KiiXHRWrapper.prototype.sendData=function(data,sendCallbacks){var requestCallback;this._setUpCallbacks(sendCallbacks);requestCallback={onComplete:function(_this){return function(){var ref;if(_this.xhr.readyState===4){if(200<=(ref=_this.xhr.status)&&ref<400){_this.getLogger("Completed Request["+_this.xhr.status+"]");if(sendCallbacks!=null){return sendCallbacks.success()}}else{_this.getLogger("Error loading data...");if(sendCallbacks!=null){return sendCallbacks.failure()}}}}}(this)};this.xhr.onreadystatechange=requestCallback.onComplete;return this.xhr.send(data)};KiiXHRWrapper.prototype.getErrorString=function(actionString){var errString,error1,json;errString=actionString+" failed. statusCode: "+this.xhr.status;try{json=JSON.parse(decodeURIComponent(this.xhr.responseText));if(json.errorCode!=null){errString+=" error code: "+json.errorCode}if(json.message!=null){errString+=" message: "+json.message}return errString}catch(error1){return errString}};KiiXHRWrapper.prototype.getErrorCode=function(){var error1,json;try{json=JSON.parse(decodeURIComponent(this.xhr.responseText));return json.errorCode}catch(error1){return null}};KiiXHRWrapper.prototype.setKiiHeaders=function(){this.xhr.setRequestHeader("x-kii-appid",this.getAppID());this.xhr.setRequestHeader("x-kii-appkey",this.getAppKey());return this.xhr.setRequestHeader("x-kii-sdk",root.KiiSDKClientInfo.getSDKClientInfo())};KiiXHRWrapper.prototype.setContentType=function(contentType){return this.xhr.setRequestHeader("Content-Type",contentType)};KiiXHRWrapper.prototype.setCurrentUserToken=function(){var ref,token;token=(ref=this.getCurrentUser())!=null?ref.getAccessToken():void 0;if(token!=null){this.xhr.setRequestHeader("authorization","bearer "+token);return true}return false};KiiXHRWrapper.prototype.setAdminOrUserToken=function(adminContext){var ref,token;if(adminContext!=null){token=adminContext._getToken()}else{token=(ref=this.getCurrentUser())!=null?ref.getAccessToken():void 0}if(token!=null){this.xhr.setRequestHeader("authorization","bearer "+token);return true}return false};KiiXHRWrapper.prototype.setAuthToken=function(authToken){if(authToken!=null){return this.xhr.setRequestHeader("authorization","bearer "+authToken)}};KiiXHRWrapper.prototype.getCurrentUser=function(){return root.KiiUser.getCurrentUser()};return KiiXHRWrapper}();KiiTiXHRWrapper=function(superClass){extend(KiiTiXHRWrapper,superClass);function KiiTiXHRWrapper(method,url){this.sendData=bind(this.sendData,this);this.send=bind(this.send,this);var hs,k,v;url=KiiUtilities._disableCacheURL(url);this.xhr=Ti.Network.createHTTPClient();this.method=method;this.xhr.open(method,url,true);hs=root.Kii.getAdditionalHeaders();if(hs!=null){for(k in hs){v=hs[k];this.xhr.setRequestHeader(k,v)}}}KiiTiXHRWrapper.prototype.send=function(sendCallbacks){var requestCallback;this._setUpCallbacks(sendCallbacks);requestCallback={onComplete:function(_this){return function(){var ref;if(_this.xhr.readyState===4){if(200<=(ref=_this.xhr.status)&&ref<400){root.Kii.logger("Completed Request["+_this.xhr.status+"]");if(sendCallbacks!=null){return sendCallbacks.success()}}else{root.Kii.logger("Error loading data...");root.Kii.logger("callback : "+sendCallbacks);if(sendCallbacks!=null){return sendCallbacks.failure()}}}}}(this),onError:function(_this){return function(){root.Kii.logger("Error loading data...");root.Kii.logger("callback : "+sendCallbacks);if(sendCallbacks!=null){return sendCallbacks.failure()}}}(this)};this.xhr.onload=requestCallback.onComplete;this.xhr.onerror=requestCallback.onError;return this.xhr.send()};KiiTiXHRWrapper.prototype.sendData=function(data,sendCallbacks){var requestCallback;this._setUpCallbacks(sendCallbacks);requestCallback={onComplete:function(_this){return function(){var ref;if(_this.xhr.readyState===4){if(200<=(ref=_this.xhr.status)&&ref<400){root.Kii.logger("Completed Request["+_this.xhr.status+"]");if(sendCallbacks!=null){return sendCallbacks.success()}}else{root.Kii.logger("Error loading data...");if(sendCallbacks!=null){return sendCallbacks.failure()}}}}}(this),onError:function(_this){return function(){root.Kii.logger("Error loading data...");root.Kii.logger("callback : "+sendCallbacks);if(sendCallbacks!=null){return sendCallbacks.failure()}}}(this)};this.xhr.onload=requestCallback.onComplete;this.xhr.onerror=requestCallback.onError;return this.xhr.send(data)};return KiiTiXHRWrapper}(KiiXHRWrapper);KiiJQXHRWrapper=function(superClass){extend(KiiJQXHRWrapper,superClass);function KiiJQXHRWrapper(method,url){var hs,k,v;url=KiiUtilities._disableCacheURL(url);this.xhr=$.ajaxSettings.xhr();this.xhr.open(method,url,true);this.method=method;hs=root.Kii.getAdditionalHeaders();if(hs!=null){for(k in hs){v=hs[k];this.xhr.setRequestHeader(k,v)}}}return KiiJQXHRWrapper}(KiiXHRWrapper);root.KiiSCNQQ=function(superClass){extend(KiiSCNQQ,superClass);function KiiSCNQQ(){this._unlinkFromCurrentUser=bind(this._unlinkFromCurrentUser,this);this._linkWithCurrentUser=bind(this._linkWithCurrentUser,this);this._logOut=bind(this._logOut,this);this._logIn=bind(this._logIn,this);this._getAccessToken=bind(this._getAccessToken,this);this._createTokenObject=bind(this._createTokenObject,this);this._setup=bind(this._setup,this);KiiSCNQQ.__super__.constructor.call(this,root.KiiSocialNetworkName.QQ)}KiiSCNQQ.prototype._setup=function(_key,_secret,_extras){this._key=_key;this._secret=_secret;this._extras=_extras;return KiiSCNQQ.__super__._setup.call(this,this._key,this._secret,this._extras)};KiiSCNQQ.prototype._createTokenObject=function(options,data){var tokenObject;tokenObject={access_token:options.access_token,openID:options.openID};if(data!=null&&data.new_user_created!=null){tokenObject["kii_new_user"]=data.new_user_created}return tokenObject};KiiSCNQQ.prototype._getAccessToken=function(options){return options.access_token};KiiSCNQQ.prototype._logIn=function(options,callbacks){var requestData;root.Kii.logger("Checking options");root.Kii.logger(options);if(options==null||!options.access_token&&!options.openID){throw root.InvalidArgumentException("Both options.access_token and options.openID are required")}else if(!options.access_token){throw root.InvalidArgumentException("options.access_token is required")}else if(!options.openID){throw root.InvalidArgumentException("options.openID is required")}if(root.KiiUser.getCurrentUser()!=null){root.KiiUser.logOut()}requestData={accessToken:options.access_token,openID:options.openID};return this._register("qq","application/vnd.kii.AuthTokenQQRequest+json",requestData,options,callbacks)};KiiSCNQQ.prototype._logOut=function(){KiiSCNQQ.__super__._logOut.apply(this,arguments);return root.Kii.logger("Log out qq")};KiiSCNQQ.prototype._linkWithCurrentUser=function(options,callbacks){var requestData;if(root.KiiUser.getCurrentUser()==null){callbacks.failure(null,this._network,"No user logged in");return}if(options==null||!options.access_token&&!options.openID){throw root.InvalidArgumentException("Both options.access_token and options.openID are required")}else if(!options.access_token){throw root.InvalidArgumentException("options.access_token is required")}else if(!options.openID){throw root.InvalidArgumentException("options.openID is required")}requestData={accessToken:options.access_token,openID:options.openID};return this._link("qq","application/vnd.kii.LinkQQRequest+json",requestData,options,callbacks)};KiiSCNQQ.prototype._unlinkFromCurrentUser=function(callbacks){if(root.KiiUser.getCurrentUser()==null){callbacks.failure(null,this._network,"No user logged in");return}return this._unlink("qq",callbacks)};return KiiSCNQQ}(root.KiiSocialConnectNetwork);root.KiiServerCodeEntry=function(){function KiiServerCodeEntry(entryName1,version1){this.entryName=entryName1;this.version=version1}KiiServerCodeEntry.prototype.execute=function(argument,callbacks){return new Promise(function(_this){return function(resolve,reject){var executeCallbacks;executeCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments)},failure:function(){var error;if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}error=KiiUtilities._Error(arguments[3],_this);error.argument=arguments[1];return reject(error)}};return _this._executeUsingCallbacks(argument,executeCallbacks)}}(this))};KiiServerCodeEntry.prototype._executeUsingCallbacks=function(argument,callbacks){var jsonBody,ref,requestData,serverCodeExecutionCallBacks,url,versionName,wrapper,xhr;if(!KiiUtilities._validateServerCodeEntryArgument(argument)){return callbacks.failure(this,argument,null,root.InvalidArgumentException("arugment is invalid"))}requestData=argument!=null?argument:{};versionName=(ref=this.version)!=null?ref:"current";jsonBody=JSON.stringify(requestData);url=root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+("/server-code/versions/"+versionName+"/"+this.entryName);wrapper=KiiXHRWrapperFactory.createXHRWrapper("POST",url);xhr=wrapper.xhr;xhr.setRequestHeader("x-kii-appid",root.Kii.getAppID());xhr.setRequestHeader("x-kii-appkey",root.Kii.getAppKey());xhr.setRequestHeader("x-kii-sdk",root.KiiSDKClientInfo.getSDKClientInfo());xhr.setRequestHeader("Content-Type","application/json");if(root.KiiUser.getCurrentUser()!=null){xhr.setRequestHeader("Authorization","Bearer "+root.KiiUser.getCurrentUser().getAccessToken())}serverCodeExecutionCallBacks={success:function(_this){return function(){var error1,errorString,execResult,returnObject,stepCount;stepCount=xhr.getResponseHeader("x-step-count");try{returnObject=JSON.parse(xhr.responseText);execResult=new root.KiiServerCodeExecResult(returnObject,stepCount);if(callbacks!=null){return callbacks.success(_this,argument,execResult)}}catch(error1){if(callbacks!=null){errorString="fail to parse response. statusCode: "+xhr.status+" executedSteps: "+stepCount+" error code: failed_to_parse_response response: "+xhr.responseText;return callbacks.failure(_this,argument,null,errorString)}}}}(this),failure:function(_this){return function(){var error1,errorMessage,errorString,json,stepCount;stepCount=xhr.getResponseHeader("x-step-count");errorMessage={statusCode:xhr.status,executedSteps:stepCount};errorString="fail to execute server code. statusCode: "+xhr.status+" executedSteps: "+stepCount;try{json=JSON.parse(xhr.responseText);if(json.errorCode!=null){errorString+=" error code: "+json.errorCode}if(json.message!=null){errorString+=" message: "+json.message}if(json.details!=null&&json.details.message!=null){return errorString+=" detailMessage: "+json.details.message}}catch(error1){return errorString+=" error code: failed_to_parse_response message: "+xhr.responseText}finally{if(callbacks!=null){callbacks.failure(_this,argument,null,errorString)}}}}(this)};return wrapper.sendData(jsonBody,serverCodeExecutionCallBacks)};KiiServerCodeEntry.prototype.getEntryName=function(){return this.entryName};return KiiServerCodeEntry}();root.KiiServerCodeExecResult=function(){function KiiServerCodeExecResult(returnObject1,exeSteps){this.returnObject=returnObject1;this.exeSteps=exeSteps}KiiServerCodeExecResult.prototype.getExecutedSteps=function(){
return this.exeSteps};KiiServerCodeExecResult.prototype.getReturnedValue=function(){return this.returnObject};return KiiServerCodeExecResult}();root.KiiThing=function(){function KiiThing(fields1){this.fields=fields1;this._getSubscriberPath=bind(this._getSubscriberPath,this);this._setAuthToken=bind(this._setAuthToken,this);this._getHttpURI=bind(this._getHttpURI,this);this.pushSubscription=bind(this.pushSubscription,this);this._listTopicsUsingCallbacks=bind(this._listTopicsUsingCallbacks,this);this.listTopics=bind(this.listTopics,this);this.topicWithName=bind(this.topicWithName,this);this.encryptedBucketWithName=bind(this.encryptedBucketWithName,this);this.bucketWithName=bind(this.bucketWithName,this);this._changeStatus=bind(this._changeStatus,this);this.enable=bind(this.enable,this);this.disable=bind(this.disable,this);this.unregisterOwner=bind(this.unregisterOwner,this);this._getOwnerURL=bind(this._getOwnerURL,this);this.registerOwner=bind(this.registerOwner,this);this.isOwner=bind(this.isOwner,this);this.deleteThing=bind(this.deleteThing,this);this.update=bind(this.update,this);this._refresh=bind(this._refresh,this);this.refresh=bind(this.refresh,this);this.getOnlineStatusModifiedAt=bind(this.getOnlineStatusModifiedAt,this);this.isOnline=bind(this.isOnline,this);this.getDisabled=bind(this.getDisabled,this);this.getCreated=bind(this.getCreated,this);this.getAccessToken=bind(this.getAccessToken,this);this.getVendorThingID=bind(this.getVendorThingID,this);this.getThingID=bind(this.getThingID,this);this._renewThingFields=bind(this._renewThingFields,this);if(this.fields!=null){this._renewThingFields(this.fields)}}KiiThing.prototype._renewThingFields=function(respJson){this._online=null;this._onlineStatusModifiedAt=null;this.fields=respJson;this._thingID=respJson._thingID;this._vendorThingID=respJson._vendorThingID;this._accessToken=respJson._accessToken;this._created=new Date(respJson._created);this._disabled=respJson._disabled;if(respJson._online!=null){this._online=respJson._online}if(respJson._onlineStatusModifiedAt!=null){this._onlineStatusModifiedAt=new Date(respJson._onlineStatusModifiedAt)}delete this.fields._thingID;delete this.fields._vendorThingID;delete this.fields._accessToken;delete this.fields._created;return delete this.fields._disabled};KiiThing.prototype.getThingID=function(){return this._thingID};KiiThing.prototype.getVendorThingID=function(){return this._vendorThingID};KiiThing.prototype.getAccessToken=function(){return this._accessToken};KiiThing.prototype.getCreated=function(){return this._created};KiiThing.prototype.getDisabled=function(){return this._disabled};KiiThing.prototype.isOnline=function(){return this._online};KiiThing.prototype.getOnlineStatusModifiedAt=function(){return this._onlineStatusModifiedAt};KiiThing.register=function(fields,callbacks){return new Promise(function(resolve,reject){var sendCallbacks,wrapper;wrapper=KiiXHRWrapperFactory.createXHRWrapper("POST",root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+"/things");wrapper.setKiiHeaders();wrapper.setContentType("application/vnd.kii.ThingRegistrationAndAuthorizationRequest+json");sendCallbacks={success:function(){var respJson,thing;respJson=JSON.parse(decodeURIComponent(wrapper.xhr.responseText));thing=new root.KiiThing(respJson);if(callbacks!=null){callbacks.success(thing)}return resolve(thing)},failure:function(){var errObj,errString;errString=wrapper.getErrorString("register thing");errObj=KiiUtilities._Error(errString);if(callbacks!=null){callbacks.failure(errObj)}return reject(errObj)}};return wrapper.sendData(JSON.stringify(fields),sendCallbacks)})};KiiThing.prototype.refresh=function(callbacks){return new Promise(function(_this){return function(resolve,reject){var _refreshCallbacks;_refreshCallbacks={success:function(respJson){_this._renewThingFields(respJson);if(callbacks!=null){callbacks.success(_this)}return resolve(_this)},failure:function(errString){var errObj;errObj=KiiUtilities._Error(errString,_this);if(callbacks!=null){callbacks.failure(errObj)}return reject(errObj)}};return _this._refresh(_refreshCallbacks)}}(this))};KiiThing.prototype._refresh=function(callbacks){var qualifiedID,sendCallbacks,wrapper;if(this._thingID!=null){qualifiedID=this._thingID}else{qualifiedID="VENDOR_THING_ID:"+this._vendorThingID}wrapper=KiiXHRWrapperFactory.createXHRWrapper("GET",root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+"/things/"+qualifiedID);wrapper.setKiiHeaders();this._setAuthToken(wrapper);sendCallbacks={success:function(_this){return function(){var respJson;respJson=JSON.parse(decodeURIComponent(wrapper.xhr.responseText));return callbacks.success(respJson)}}(this),failure:function(_this){return function(){var errString;errString=wrapper.getErrorString("refresh thing");return callbacks.failure(errString)}}(this)};return wrapper.send(sendCallbacks)};KiiThing.prototype.update=function(callbacks){return new Promise(function(_this){return function(resolve,reject){var _refreshCallbacks;_refreshCallbacks={success:function(respJson){var k,ref,sendCallbacks,v,wrapper;ref=_this.fields;for(k in ref){v=ref[k];respJson[k]=v}_this.fields=respJson;wrapper=KiiXHRWrapperFactory.createXHRWrapper("PATCH",root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+"/things/"+_this._thingID);wrapper.setKiiHeaders();wrapper.setContentType("application/vnd.kii.ThingUpdateRequest+json");_this._setAuthToken(wrapper);sendCallbacks={success:function(){if(callbacks!=null){callbacks.success(_this)}return resolve(_this)},failure:function(){var errObj,errString;errString=wrapper.getErrorString("update thing");errObj=KiiUtilities._Error(errString,_this);if(callbacks!=null){callbacks.failure(errObj)}return reject(errObj)}};wrapper.sendData(JSON.stringify(_this.fields),sendCallbacks);return typeof _this._testOnUpdateRequest==="function"?_this._testOnUpdateRequest():void 0},failure:function(errString){var errObj;errObj=KiiUtilities._Error(errString,_this);if(callbacks!=null){callbacks.failure(errObj)}return reject(errObj)}};return _this._refresh(_refreshCallbacks)}}(this))};KiiThing.prototype.deleteThing=function(callbacks){return new Promise(function(_this){return function(resolve,reject){var sendCallbacks,wrapper;wrapper=KiiXHRWrapperFactory.createXHRWrapper("DELETE",root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+"/things/"+_this._thingID);wrapper.setKiiHeaders();_this._setAuthToken(wrapper);sendCallbacks={success:function(){if(callbacks!=null){callbacks.success(_this)}return resolve(_this)},failure:function(){var errObj,errString;errString=wrapper.getErrorString("delete thing");errObj=KiiUtilities._Error(errString,_this);if(callbacks!=null){callbacks.failure(errObj)}return reject(errObj)}};return wrapper.send(sendCallbacks)}}(this))};KiiThing.prototype.isOwner=function(owner,callbacks){return new Promise(function(_this){return function(resolve,reject){var errObj,error1,message,ownerUrl,sendCallbacks,wrapper;try{ownerUrl=_this._getOwnerURL(_this._thingID,owner)}catch(error1){message=error1;errObj=KiiUtilities._Error(message,_this);if(callbacks!=null){callbacks.failure(errObj)}reject(errObj);return}wrapper=KiiXHRWrapperFactory.createXHRWrapper("HEAD",ownerUrl);wrapper.setKiiHeaders();_this._setAuthToken(wrapper);sendCallbacks={success:function(){if(callbacks!=null){callbacks.success(_this,owner,true)}return resolve([_this,owner,true])},failure:function(){var errString;if(wrapper.xhr.status===404){if(callbacks!=null){callbacks.success(_this,owner,false)}resolve([_this,owner,false]);return}errString=wrapper.getErrorString("register owner");errObj=KiiUtilities._Error(errString,_this);if(callbacks!=null){callbacks.failure(errObj)}return reject(errObj)}};return wrapper.send(sendCallbacks)}}(this))};KiiThing.prototype.registerOwner=function(owner,callbacks){return new Promise(function(_this){return function(resolve,reject){var errObj,error1,message,ownerUrl,sendCallbacks,wrapper;try{ownerUrl=_this._getOwnerURL(_this._thingID,owner)}catch(error1){message=error1;errObj=KiiUtilities._Error(message,_this);if(callbacks!=null){callbacks.failure(errObj)}reject(errObj);return}wrapper=KiiXHRWrapperFactory.createXHRWrapper("PUT",ownerUrl);wrapper.setKiiHeaders();_this._setAuthToken(wrapper);sendCallbacks={success:function(){if(callbacks!=null){callbacks.success(_this,owner)}return resolve([_this,owner])},failure:function(){var errString;errString=wrapper.getErrorString("register owner");errObj=KiiUtilities._Error(errString,_this);if(callbacks!=null){callbacks.failure(errObj)}return reject(errObj)}};return wrapper.send(sendCallbacks)}}(this))};KiiThing.registerOwnerWithThingID=function(thingID,owner,callbacks){return root.KiiThing._registerOwnerWithIdentifier(thingID,owner,callbacks)};KiiThing.registerOwnerWithVendorThingID=function(vendorThingID,owner,callbacks){if(!KiiUtilities._isNonEmptyString(vendorThingID)){return root.KiiThing._registerOwnerWithIdentifier(null,owner,callbacks)}return root.KiiThing._registerOwnerWithIdentifier("VENDOR_THING_ID:"+vendorThingID,owner,callbacks)};KiiThing._registerOwnerWithIdentifier=function(identifier,owner,callbacks){return new Promise(function(resolve,reject){var errObj,error1,message,ownerUrl,sendCallbacks,wrapper;if(!KiiUtilities._isNonEmptyString(identifier)){errObj=KiiUtilities._Error("identifier is null or empty");if(callbacks!=null){callbacks.failure(errObj)}reject(errObj);return}if(owner==null){errObj=KiiUtilities._Error("owner is null");if(callbacks!=null){callbacks.failure(errObj)}reject(errObj);return}try{ownerUrl=root.KiiThing.prototype._getOwnerURL(identifier,owner)}catch(error1){message=error1;errObj=KiiUtilities._Error(message);if(callbacks!=null){callbacks.failure(errObj)}reject(errObj);return}wrapper=KiiXHRWrapperFactory.createXHRWrapper("PUT",ownerUrl);wrapper.setKiiHeaders();root.KiiThing.prototype._setAuthToken(wrapper);sendCallbacks={success:function(){if(callbacks!=null){callbacks.success(owner)}return resolve([owner])},failure:function(){var errString;errString=wrapper.getErrorString("register owner");errObj=KiiUtilities._Error(errString);if(callbacks!=null){callbacks.failure(errObj)}return reject(errObj)}};return wrapper.send(sendCallbacks)})};KiiThing.prototype._getOwnerURL=function(identifier,owner){var oid,type;if(owner instanceof root.KiiUser){oid=owner.getID();type="user"}else if(owner instanceof root.KiiGroup){oid=owner.getID();type="group"}else{throw"owner should be instance of user or group"}if(oid==null){throw"owner instance does not have id"}return root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+"/things/"+identifier+"/ownership/"+type+":"+oid};KiiThing.prototype.unregisterOwner=function(owner,callbacks){return new Promise(function(_this){return function(resolve,reject){var errObj,error1,message,ownerUrl,sendCallbacks,wrapper;try{ownerUrl=_this._getOwnerURL(_this._thingID,owner)}catch(error1){message=error1;errObj=KiiUtilities._Error(message,_this);if(callbacks!=null){callbacks.failure(errObj)}reject(errObj);return}wrapper=KiiXHRWrapperFactory.createXHRWrapper("DELETE",ownerUrl);wrapper.setKiiHeaders();_this._setAuthToken(wrapper);sendCallbacks={success:function(){if(callbacks!=null){callbacks.success(_this,owner)}return resolve([_this,owner])},failure:function(){var errString;errString=wrapper.getErrorString("unregister owner");errObj=KiiUtilities._Error(errString,_this);if(callbacks!=null){callbacks.failure(errObj)}return reject(errObj)}};return wrapper.send(sendCallbacks)}}(this))};KiiThing.prototype.disable=function(callbacks){return this._changeStatus(true,callbacks)};KiiThing.prototype.enable=function(callbacks){return this._changeStatus(false,callbacks)};KiiThing.prototype._changeStatus=function(disable,callbacks){return new Promise(function(_this){return function(resolve,reject){var data,sendCallbacks,wrapper;wrapper=KiiXHRWrapperFactory.createXHRWrapper("PUT",root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+"/things/"+_this._thingID+"/status");wrapper.setKiiHeaders();_this._setAuthToken(wrapper);wrapper.setContentType("application/vnd.kii.ThingStatusUpdateRequest+json");sendCallbacks={success:function(){_this._disabled=disable;if(callbacks!=null){callbacks.success(_this)}return resolve(_this)},failure:function(){var errObj,errString;errString=wrapper.getErrorString("disable thing "+disable);errObj=KiiUtilities._Error(errString,_this);if(callbacks!=null){callbacks.failure(errObj)}return reject(errObj)}};data={disabled:disable};return wrapper.sendData(JSON.stringify(data),sendCallbacks)}}(this))};KiiThing.loadWithVendorThingID=function(vendorThingID,callbacks){var qualifiedID;qualifiedID="VENDOR_THING_ID:"+vendorThingID;return root.KiiThing._load(qualifiedID,callbacks)};KiiThing.loadWithThingID=function(thingID,callbacks){return root.KiiThing._load(thingID,callbacks)};KiiThing._load=function(qualifiedID,callbacks){return new Promise(function(resolve,reject){var sendCallbacks,wrapper;wrapper=KiiXHRWrapperFactory.createXHRWrapper("GET",root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+"/things/"+qualifiedID);wrapper.setKiiHeaders();root.KiiThing.prototype._setAuthToken(wrapper);sendCallbacks={success:function(){var respJson,thing;respJson=JSON.parse(decodeURIComponent(wrapper.xhr.responseText));thing=new root.KiiThing(respJson);if(callbacks!=null){callbacks.success(thing)}return resolve(thing)},failure:function(){var errObj,errString;errString=wrapper.getErrorString("load thing");errObj=KiiUtilities._Error(errString);if(callbacks!=null){callbacks.failure(errObj)}return reject(errObj)}};return wrapper.send(sendCallbacks)})};KiiThing.prototype.bucketWithName=function(bucketName){return new root.KiiBucket._bucketWithName(bucketName,this)};KiiThing.prototype.encryptedBucketWithName=function(bucketName){return new root.KiiEncryptedBucket(bucketName,this)};KiiThing.prototype.topicWithName=function(topicName){if(typeof topicName!=="string"||topicName===""){throw new root.InvalidArgumentException("topicName should not null or empty")}return new root.KiiTopic(this._getHttpURI(),topicName)};KiiThing.prototype.listTopics=function(callbacks,paginationKey){return new Promise(function(_this){return function(resolve,reject){var listTopicsCallbacks;listTopicsCallbacks={success:function(){if(callbacks!=null){callbacks.success.apply(callbacks,arguments)}return resolve(arguments)},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(arguments[0])}};return _this._listTopicsUsingCallbacks(listTopicsCallbacks,paginationKey)}}(this))};KiiThing.prototype._listTopicsUsingCallbacks=function(callbacks,paginationKey){var listCallbacks,uri,wrapper;uri=this._getHttpURI()+"/topics";if(typeof paginationKey==="string"&&paginationKey!==""){uri=uri+"?paginationKey="+encodeURIComponent(paginationKey)}wrapper=KiiXHRWrapperFactory.createXHRWrapper("GET",uri);wrapper.setKiiHeaders();this._setAuthToken(wrapper);listCallbacks={success:function(_this){return function(){var j,json,len,ref,topic,topics;json=JSON.parse(wrapper.xhr.responseText);topics=[];ref=json.topics;for(j=0,len=ref.length;j<len;j++){topic=ref[j];topics.push(_this.topicWithName(topic.topicID))}return callbacks!=null?callbacks.success(topics,json.paginationKey===void 0?null:json.paginationKey):void 0}}(this),failure:function(_this){return function(){var errObj,errString;errString=wrapper.getErrorString("list topics");errObj=KiiUtilities._Error(errString,_this);return callbacks!=null?callbacks.failure(errObj):void 0}}(this)};return wrapper.send(listCallbacks)};KiiThing.prototype.pushSubscription=function(){return new root.KiiPushSubscription(this)};KiiThing.prototype._getHttpURI=function(){return root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+"/things/"+this.getThingID()};KiiThing.thingWithID=function(thingID){var thing;if(thingID==null||thingID===""){throw new root.InvalidArgumentException("thingID should not null or empty")}thing=new root.KiiThing;thing._thingID=thingID;return thing};KiiThing.prototype._setAuthToken=function(wrapper){return wrapper.setCurrentUserToken()};KiiThing.prototype._getSubscriberPath=function(){return"things/"+this.getThingID()};return KiiThing}();root.KiiTopic=function(){function KiiTopic(parentUri,topicName){this._getHttpUri=bind(this._getHttpUri,this);this._setAuthToken=bind(this._setAuthToken,this);this.acl=bind(this.acl,this);this.deleteTopic=bind(this.deleteTopic,this);this.sendMessage=bind(this.sendMessage,this);this.save=bind(this.save,this);this.exists=bind(this.exists,this);this.getName=bind(this.getName,this);this._uri=parentUri+"/topics/"+topicName;this._name=topicName}KiiTopic.prototype.getName=function(){return this._name};KiiTopic.prototype.exists=function(callbacks){return new Promise(function(_this){return function(resolve,reject){var existsCallbacks,wrapper;wrapper=KiiXHRWrapperFactory.createXHRWrapper("HEAD",_this._uri);wrapper.setKiiHeaders();_this._setAuthToken(wrapper);existsCallbacks={success:function(){if(callbacks!=null){callbacks.success(true)}return resolve(true)},failure:function(){var errObj,errString;if(wrapper.xhr.status===404){if(callbacks!=null){callbacks.success(false)}resolve(false);return}errString=wrapper.getErrorString("check topic");errObj=KiiUtilities._Error(errString,_this);if(callbacks!=null){callbacks.failure(errObj)}return reject(errObj)}};return wrapper.send(existsCallbacks)}}(this))};KiiTopic.prototype.save=function(callbacks){return new Promise(function(_this){return function(resolve,reject){var sendCallbacks,wrapper;wrapper=KiiXHRWrapperFactory.createXHRWrapper("PUT",_this._uri);wrapper.setKiiHeaders();_this._setAuthToken(wrapper);sendCallbacks={success:function(){if(callbacks!=null){callbacks.success(_this)}return resolve(_this)},failure:function(){var errObj,errString;errString=wrapper.getErrorString("save topic");errObj=KiiUtilities._Error(errString,_this);if(callbacks!=null){callbacks.failure(errObj)}return reject(errObj)}};return wrapper.send(sendCallbacks)}}(this))};KiiTopic.prototype.sendMessage=function(message,callbacks){return new Promise(function(_this){return function(resolve,reject){var sendCallbacks,wrapper;wrapper=KiiXHRWrapperFactory.createXHRWrapper("POST",_this._uri+"/push/messages");wrapper.setKiiHeaders();_this._setAuthToken(wrapper);wrapper.setContentType("application/vnd.kii.SendPushMessageRequest+json");sendCallbacks={success:function(){if(callbacks!=null){callbacks.success(_this,message)}return resolve([_this,message])},failure:function(){var errObj,errString;errString=wrapper.getErrorString("send messages");errObj=KiiUtilities._Error(errString,_this);if(callbacks!=null){callbacks.failure(errObj)}return reject(errObj)}};return wrapper.sendData(JSON.stringify(message),sendCallbacks)}}(this))};KiiTopic.prototype.deleteTopic=function(callbacks){return new Promise(function(_this){return function(resolve,reject){var sendCallbacks,wrapper;wrapper=KiiXHRWrapperFactory.createXHRWrapper("DELETE",_this._uri);wrapper.setKiiHeaders();_this._setAuthToken(wrapper);sendCallbacks={success:function(){if(callbacks!=null){callbacks.success(_this)}return resolve(_this)},failure:function(){var errObj,errString;errString=wrapper.getErrorString("delete topic");errObj=KiiUtilities._Error(errString,_this);if(callbacks!=null){callbacks.failure(errObj)}return reject(errObj)}};return wrapper.send(sendCallbacks)}}(this))};KiiTopic.prototype.acl=function(){return root.KiiACL.aclWithParent(this)};KiiTopic.prototype._setAuthToken=function(wrapper){return wrapper.setCurrentUserToken()};KiiTopic.prototype._getHttpUri=function(){return this._uri};return KiiTopic}();root.KiiPushMessageBuilder=function(){function KiiPushMessageBuilder(data1){this.data=data1;this.mqttData=bind(this.mqttData,this);this.jpushData=bind(this.jpushData,this);this.apnsCategory=bind(this.apnsCategory,this);this.apnsContentAvailable=bind(this.apnsContentAvailable,this);this.apnsBadge=bind(this.apnsBadge,this);this.apnsSound=bind(this.apnsSound,this);this.apnsAlert=bind(this.apnsAlert,this);this.apnsData=bind(this.apnsData,this);this.gcmRestrictedPackageName=bind(this.gcmRestrictedPackageName,this);this.gcmTimeToLive=bind(this.gcmTimeToLive,this);this.gcmDelayWhileIdle=bind(this.gcmDelayWhileIdle,this);this.gcmCollapseKey=bind(this.gcmCollapseKey,this);this.gcmData=bind(this.gcmData,this);this.enableMqtt=bind(this.enableMqtt,this);this.enableJpush=bind(this.enableJpush,this);this.enableApns=bind(this.enableApns,this);this.enableGcm=bind(this.enableGcm,this);this.setSendToProduction=bind(this.setSendToProduction,this);this.setSendToDevelopment=bind(this.setSendToDevelopment,this);this.build=bind(this.build,this);this.gcm={};this.apns={};this.jpush={};this.mqtt={};this.gcm.enabled=true;this.apns.enabled=true;this.jpush.enabled=true;this.mqtt.enabled=true}KiiPushMessageBuilder.prototype.build=function(){var ret;ret={};ret.data=this.data;ret.gcm=this.gcm;ret.apns=this.apns;ret.jpush=this.jpush;ret.mqtt=this.mqtt;if(this.sendToDevelopment!=null){ret.sendToDevelopment=this.sendToDevelopment}if(this.sendToProduction!=null){ret.sendToProduction=this.sendToProduction}return ret};KiiPushMessageBuilder.prototype.setSendToDevelopment=function(flag){this.sendToDevelopment=flag;return this};KiiPushMessageBuilder.prototype.setSendToProduction=function(flag){this.sendToProduction=flag;return this};KiiPushMessageBuilder.prototype.enableGcm=function(enable){this.gcm.enabled=enable;return this};KiiPushMessageBuilder.prototype.enableApns=function(enable){this.apns.enabled=enable;return this};KiiPushMessageBuilder.prototype.enableJpush=function(enable){this.jpush.enabled=enable;return this};KiiPushMessageBuilder.prototype.enableMqtt=function(enable){this.mqtt.enabled=enable;return this};KiiPushMessageBuilder.prototype.gcmData=function(data){this.gcm.data=data;return this};KiiPushMessageBuilder.prototype.gcmCollapseKey=function(collapseKey){this.gcm.collapseKey=collapseKey;return this};KiiPushMessageBuilder.prototype.gcmDelayWhileIdle=function(delayWhileIdle){this.gcm.delayWhileIdle=delayWhileIdle;return this};KiiPushMessageBuilder.prototype.gcmTimeToLive=function(timeToLive){this.gcm.timeToLive=timeToLive;return this};KiiPushMessageBuilder.prototype.gcmRestrictedPackageName=function(restrictedPackageName){this.gcm.restrictedPackageName=restrictedPackageName;return this};KiiPushMessageBuilder.prototype.apnsData=function(data){this.apns.data=data;return this};KiiPushMessageBuilder.prototype.apnsAlert=function(alert){this.apns.alert=alert;return this};KiiPushMessageBuilder.prototype.apnsSound=function(sound){this.apns.sound=sound;return this};KiiPushMessageBuilder.prototype.apnsBadge=function(badge){this.apns.badge=badge;return this};KiiPushMessageBuilder.prototype.apnsContentAvailable=function(contentAvailable){if(contentAvailable!==0){this.apns.contentAvailable=true}return this};KiiPushMessageBuilder.prototype.apnsCategory=function(category){this.apns.category=category;return this};KiiPushMessageBuilder.prototype.jpushData=function(data){this.jpush.data=data;return this};KiiPushMessageBuilder.prototype.mqttData=function(data){this.mqtt.data=data;return this};return KiiPushMessageBuilder}();root.KiiPushSubscription=function(){KiiPushSubscription.prototype.getSubscriber=function(){return this._subscriber};function KiiPushSubscription(_subscriber){this._subscriber=_subscriber;this._setAuthToken=bind(this._setAuthToken,this);this._getRequestHTTPURI=bind(this._getRequestHTTPURI,this);this._validateTarget=bind(this._validateTarget,this);this.isSubscribed=bind(this.isSubscribed,this);this.unsubscribe=bind(this.unsubscribe,this);this.subscribe=bind(this.subscribe,this)}KiiPushSubscription.prototype.subscribe=function(target,callbacks){return new Promise(function(_this){return function(resolve,reject){var requestUri,sendCallbacks,wrapper;if(!_this._validateTarget(target)){if(callbacks!=null){callbacks.failure(root.InvalidArgumentException("target is invalid"))}reject(KiiUtilities._Error(root.InvalidArgumentException("target is invalid"),_this));return}requestUri=_this._getRequestHTTPURI(target);wrapper=KiiXHRWrapperFactory.createXHRWrapper("PUT",requestUri);wrapper.setKiiHeaders();_this._setAuthToken(wrapper);sendCallbacks={success:function(){if(callbacks!=null){callbacks.success(_this,target)}return resolve([_this,target])},failure:function(){var errObj,errString;errString=wrapper.getErrorString("subscribe");errObj=KiiUtilities._Error(errString,_this);if(callbacks!=null){callbacks.failure(errObj)}return reject(errObj)}};return wrapper.send(sendCallbacks)}}(this))};KiiPushSubscription.prototype.unsubscribe=function(target,callbacks){return new Promise(function(_this){return function(resolve,reject){var requestUri,sendCallbacks,wrapper;if(!_this._validateTarget(target)){if(callbacks!=null){callbacks.failure(root.InvalidArgumentException("target is invalid"))}reject(KiiUtilities._Error(root.InvalidArgumentException("target is invalid"),_this));return}requestUri=_this._getRequestHTTPURI(target);wrapper=KiiXHRWrapperFactory.createXHRWrapper("DELETE",requestUri);wrapper.setKiiHeaders();_this._setAuthToken(wrapper);sendCallbacks={success:function(){if(callbacks!=null){callbacks.success(_this,target)}return resolve([_this,target])},failure:function(){var errObj,errString;errString=wrapper.getErrorString("unsubscribe");errObj=KiiUtilities._Error(errString,_this);if(callbacks!=null){callbacks.failure(errObj)}return reject(errObj)}};return wrapper.send(sendCallbacks)}}(this))};KiiPushSubscription.prototype.isSubscribed=function(target,callbacks){return new Promise(function(_this){return function(resolve,reject){var requestUri,sendCallbacks,wrapper;if(!_this._validateTarget(target)){if(callbacks!=null){callbacks.failure(root.InvalidArgumentException("target is invalid"))}reject(KiiUtilities._Error(root.InvalidArgumentException("target is invalid"),_this));return}requestUri=_this._getRequestHTTPURI(target);wrapper=KiiXHRWrapperFactory.createXHRWrapper("GET",requestUri);wrapper.setKiiHeaders();_this._setAuthToken(wrapper);sendCallbacks={success:function(){if(callbacks!=null){callbacks.success(_this,target,true)}return resolve([_this,target,true])},failure:function(){var errObj,errString,errorCode;errorCode=wrapper.getErrorCode();if(errorCode==="FILTER_NOT_FOUND"||errorCode==="PUSH_SUBSCRIPTION_NOT_FOUND"){if(callbacks!=null){callbacks.success(_this,target,false)}return resolve([_this,target,false])}else{errString=wrapper.getErrorString("Check is subscribed");errObj=KiiUtilities._Error(errString,_this);if(callbacks!=null){callbacks.failure(errObj)}return reject(errObj)}}};return wrapper.send(sendCallbacks)}}(this))};KiiPushSubscription.prototype._validateTarget=function(target){return target!=null&&(target instanceof root.KiiBucket||target instanceof root.KiiTopic)};KiiPushSubscription.prototype._getRequestHTTPURI=function(target){var requestUri;if(target instanceof root.KiiBucket){return requestUri=target._getHttpUri()+"/filters/all/push/subscriptions/"+this._subscriber._getSubscriberPath()}else if(target instanceof root.KiiTopic){return requestUri=target._getHttpUri()+"/push/subscriptions/"+this._subscriber._getSubscriberPath()}};KiiPushSubscription.prototype._setAuthToken=function(wrapper){return wrapper.setCurrentUserToken()};return KiiPushSubscription}();root.KiiThingWithToken=function(superClass){extend(KiiThingWithToken,superClass);function KiiThingWithToken(fields,thingID,vendorThingID,_adminToken){this._adminToken=_adminToken;this.topicWithName=bind(this.topicWithName,this);this.bucketWithName=bind(this.bucketWithName,this);this.pushSubscription=bind(this.pushSubscription,this);this._setAuthToken=bind(this._setAuthToken,this);KiiThingWithToken.__super__.constructor.call(this,fields);if(thingID!=null){this._thingID=thingID}if(vendorThingID!=null){this._vendorThingID=vendorThingID}}KiiThingWithToken.register=function(fields,callbacks,accessToken){return new Promise(function(resolve,reject){var sendCallbacks,wrapper;wrapper=KiiXHRWrapperFactory.createXHRWrapper("POST",root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+"/things");wrapper.setKiiHeaders();wrapper.setContentType("application/vnd.kii.ThingRegistrationAndAuthorizationRequest+json");wrapper.setAuthToken(accessToken);sendCallbacks={success:function(){var respJson,thing;respJson=JSON.parse(decodeURIComponent(wrapper.xhr.responseText));thing=new root.KiiThingWithToken(respJson,null,null,accessToken);if(callbacks!=null){callbacks.success(thing)}return resolve(thing)},failure:function(){var errObj,errString;errString=wrapper.getErrorString("register thing");errObj=KiiUtilities._Error(errString);if(callbacks!=null){callbacks.failure(errObj)}return reject(errObj)}};return wrapper.sendData(JSON.stringify(fields),sendCallbacks)})};KiiThingWithToken.registerOwnerWithThingID=function(thingID,owner,callbacks,accessToken){return root.KiiThingWithToken._registerOwnerWithIdentifier(thingID,owner,callbacks,accessToken)};KiiThingWithToken.registerOwnerWithVendorThingID=function(vendorThingID,owner,callbacks,accessToken){return root.KiiThingWithToken._registerOwnerWithIdentifier("VENDOR_THING_ID:"+vendorThingID,owner,callbacks,accessToken)};KiiThingWithToken._registerOwnerWithIdentifier=function(identifier,owner,callbacks,accessToken){return new Promise(function(resolve,reject){var oid,sendCallbacks,type,wrapper;if(owner instanceof root.KiiUser){oid=owner.getID();type="user"}else if(owner instanceof root.KiiGroup){oid=owner.getID();type="group"}else{throw"owner should be instance of user or group"}if(oid==null){throw"owner instance does not have id"}wrapper=KiiXHRWrapperFactory.createXHRWrapper("PUT",root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+"/things/"+identifier+"/ownership/"+type+":"+oid);wrapper.setKiiHeaders();wrapper.setAuthToken(accessToken);sendCallbacks={success:function(){if(callbacks!=null){callbacks.success(owner)}return resolve([owner])},failure:function(){var errObj,errString;errString=wrapper.getErrorString("register owner");errObj=KiiUtilities._Error(errString);if(callbacks!=null){callbacks.failure(errObj)}return reject(errObj)}};return wrapper.send(sendCallbacks)})};KiiThingWithToken.loadWithVendorThingID=function(vendorThingID,callbacks,adminToken){var thingAdmin;thingAdmin=new root.KiiThingWithToken(null,null,vendorThingID,adminToken);return thingAdmin.refresh(callbacks)};KiiThingWithToken.loadWithThingID=function(thingID,callbacks,adminToken){var thingAdmin;thingAdmin=new root.KiiThingWithToken(null,thingID,null,adminToken);return thingAdmin.refresh(callbacks)};KiiThingWithToken.prototype._setAuthToken=function(wrapper){return wrapper.setAuthToken(this._adminToken)};KiiThingWithToken.prototype.pushSubscription=function(){return new root.KiiPushSubscriptionWithToken(this,this._adminToken)};KiiThingWithToken.prototype.bucketWithName=function(bucketName){return new root.KiiBucketWithToken(bucketName,this,this._adminToken)};KiiThingWithToken.prototype.encryptedBucketWithName=function(bucketName){return new root.KiiEncryptedBucketWithToken(bucketName,this,this._adminToken)};KiiThingWithToken.prototype.topicWithName=function(topicName){if(typeof topicName!=="string"||topicName===""){throw new root.InvalidArgumentException("topicName should not null or empty")}return new root.KiiTopicWithToken(this._getHttpURI(),topicName,this._adminToken)};KiiThingWithToken.thingWithID=function(thingID,adminToken){var thingAdmin;thingAdmin=new root.KiiThingWithToken(null,thingID,null,adminToken);return thingAdmin};return KiiThingWithToken}(root.KiiThing);root.KiiTopicWithToken=function(superClass){extend(KiiTopicWithToken,superClass);function KiiTopicWithToken(parentUri,topicName,_authToken){this._authToken=_authToken;this.acl=bind(this.acl,this);this._setAuthToken=bind(this._setAuthToken,this);KiiTopicWithToken.__super__.constructor.call(this,parentUri,topicName)}KiiTopicWithToken.prototype._setAuthToken=function(wrapper){return wrapper.setAuthToken(this._authToken)};KiiTopicWithToken.prototype.acl=function(){return new root.KiiACLWithToken(this,this._authToken)};return KiiTopicWithToken}(root.KiiTopic);root.KiiPushSubscriptionWithToken=function(superClass){
extend(KiiPushSubscriptionWithToken,superClass);function KiiPushSubscriptionWithToken(subscriber,_authToken){this._authToken=_authToken;this._setAuthToken=bind(this._setAuthToken,this);KiiPushSubscriptionWithToken.__super__.constructor.call(this,subscriber)}KiiPushSubscriptionWithToken.prototype._setAuthToken=function(wrapper){return wrapper.setAuthToken(this._authToken)};return KiiPushSubscriptionWithToken}(root.KiiPushSubscription);root.KiiAnalyticsSite={US:"https://api.kii.com/api",JP:"https://api-jp.kii.com/api",CN:"https://api-cn2.kii.com/api",SG:"https://api-sg.kii.com/api",CN3:"https://api-cn3.kii.com/api"};root.KiiAnalytics=function(){var _instance;function KiiAnalytics(){}_instance=null;KiiAnalytics.getBaseURL=function(){return _instance._baseURL};KiiAnalytics.getAppID=function(){return _instance._appID};KiiAnalytics.getAppKey=function(){return _instance._appKey};KiiAnalytics.getAppKey=function(){return _instance._appKey};KiiAnalytics.getDeviceId=function(){return _instance._deviceId};KiiAnalytics.isLogging=function(){return _instance._logging};KiiAnalytics.setLogging=function(logging){root.KiiAnalytics.logger("Setting logging: "+logging);return _instance._logging=logging};KiiAnalytics.initializeWithSite=function(appID,appKey,site,deviceId){return root.KiiAnalytics._initializeWithSite(appID,appKey,site,deviceId)};KiiAnalytics.initialize=function(appID,appKey,deviceId){return root.KiiAnalytics._initializeWithSite(appID,appKey,root.KiiAnalyticsSite.US,deviceId)};KiiAnalytics._initializeWithSite=function(appID,appKey,site,deviceId){_instance=new _KiiAnalytics(appID,appKey,site,deviceId);if((deviceId!=null?deviceId.length:void 0)>0&&_instance._deviceId!==deviceId){_instance._deviceId=deviceId}return root.KiiAnalytics.logger("Initialized "+appID+", "+appKey+", "+site)};KiiAnalytics.error=function(message){return console.log("KiiAnalytics SDK Error => "+message)};KiiAnalytics.logger=function(message){if(_instance._logging){return console.log("KiiAnalytics => "+message)}};KiiAnalytics.trackEvent=function(eventName){return root.KiiAnalytics.trackEventWithExtras(eventName,null)};KiiAnalytics.trackEventWithExtras=function(eventName,extras){return root.KiiAnalytics.trackEventWithExtrasAndCallbacks(eventName,extras,null)};KiiAnalytics.trackEventWithExtrasAndCallbacks=function(eventName,extras,callbacks){return new Promise(function(resolve,reject){var trackEventCallbacks;trackEventCallbacks={success:function(){if(callbacks!=null){callbacks.success()}return resolve()},failure:function(){if(callbacks!=null){callbacks.failure.apply(callbacks,arguments)}return reject(KiiUtilities._Error(arguments[0]))}};return KiiAnalytics._trackEventWithExtrasAndCallbacks(eventName,extras,trackEventCallbacks)})};KiiAnalytics._trackEventWithExtrasAndCallbacks=function(eventName,extras,callbacks){var isValidArrayContents,isValidKey,isValidValue,key,keyPattern,now,payload,trackingCallbacks,uri,value,wrapper;now=Math.round((new Date).getTime());keyPattern="^[a-zA-Z][a-zA-Z0-9_]{0,63}$";root.KiiAnalytics.logger("deviceId = "+_instance._deviceId);payload={_triggeredAt:now,_uploadedAt:now,_deviceID:_instance._deviceId,_type:eventName};isValidKey=function(key){return key!=null&&key.match(keyPattern)!=null};isValidArrayContents=function(array){var j,len,type,val;for(j=0,len=array.length;j<len;j++){val=array[j];type=typeof val;if(type!=="string"&&type!=="boolean"&&type!=="number"){return false}if(type==="string"){if(val.length<=0){return false}}else if(type==="number"){if(!(isFinite(val)&&!isNaN(val))){return false}}}return true};isValidValue=function(value){var type;type=typeof value;if(type==="string"){return value.length>0}else if(type==="number"){return isFinite(value)&&!isNaN(value)}else if(type==="object"){return value instanceof Array&&value.length>0&&isValidArrayContents(value)}else if(type==="boolean"){return true}else{return false}};for(key in extras){value=extras[key];if(isValidKey(key)&&isValidValue(value)){payload[key]=value}else{root.KiiAnalytics.logger("ignoring invalid key/value pair, key:"+key+" value:"+value)}}uri=KiiAnalytics.getBaseURL()+"/apps/"+KiiAnalytics.getAppID()+"/event";wrapper=KiiAnalyticsXHRWrapperFactory.createXHRWrapper("POST",uri);wrapper.setKiiHeaders();wrapper.setContentType("application/vnd.kii.Event+json");trackingCallbacks={success:function(){return callbacks!=null?callbacks.success():void 0},failure:function(){var errorString;errorString=wrapper.getErrorString("track event");return callbacks!=null?callbacks.failure(errorString,wrapper.xhr.status):void 0}};return wrapper.sendData(JSON.stringify(payload),trackingCallbacks)};KiiAnalytics.setBaseURL=function(url){root.KiiAnalytics.logger("Setting base URL: "+url);return _instance._baseURL=url};KiiAnalytics.getSDKVersion=function(){return root.Kii.getSDKVersion()};KiiAnalytics._setHttpRequestType=function(requestType){root.KiiAnalytics.logger("Set http request as "+requestType);return _instance._httpRequestType=requestType};KiiAnalytics._getHttpRequestType=function(){return _instance._httpRequestType};return KiiAnalytics}();_KiiAnalytics=function(){_KiiAnalytics.prototype._httpRequestType=null;function _KiiAnalytics(appID,appKey,site,deviceId){if(site==null){site=root.KiiAnalyticsSite.US}if(!!!deviceId){deviceId=_KiiAnalytics.generateDeviceId()}this._appKey=appKey;this._appID=appID;this._baseURL=site;this._deviceId=deviceId}_KiiAnalytics.generateDeviceId=function(){var _p8;_p8=function(s){var p;p=(Math.random().toString(16)+"000000000").substr(2,8);if(s){return"-"+p.substr(0,4)+"-"+p.substr(4,4)}else{return p}};return _p8()+_p8(true)+_p8(true)+_p8()};return _KiiAnalytics}();KiiAnalyticsXHRWrapper=function(superClass){extend(KiiAnalyticsXHRWrapper,superClass);function KiiAnalyticsXHRWrapper(){return KiiAnalyticsXHRWrapper.__super__.constructor.apply(this,arguments)}KiiAnalyticsXHRWrapper.prototype.getAppID=function(){return root.KiiAnalytics.getAppID()};KiiAnalyticsXHRWrapper.prototype.getAppKey=function(){return root.KiiAnalytics.getAppKey()};KiiAnalyticsXHRWrapper.prototype.getLogger=function(){return root.KiiAnalytics.logger()};KiiAnalyticsXHRWrapper.prototype.getCurrentUser=function(){return null};return KiiAnalyticsXHRWrapper}(KiiXHRWrapper);KiiAnalyticsJQXHRWrapper=function(superClass){extend(KiiAnalyticsJQXHRWrapper,superClass);function KiiAnalyticsJQXHRWrapper(){return KiiAnalyticsJQXHRWrapper.__super__.constructor.apply(this,arguments)}KiiAnalyticsJQXHRWrapper.prototype.getAppID=function(){return root.KiiAnalytics.getAppID()};KiiAnalyticsJQXHRWrapper.prototype.getAppKey=function(){return root.KiiAnalytics.getAppKey()};KiiAnalyticsJQXHRWrapper.prototype.getLogger=function(){return root.KiiAnalytics.logger()};KiiAnalyticsJQXHRWrapper.prototype.getCurrentUser=function(){return null};return KiiAnalyticsJQXHRWrapper}(KiiJQXHRWrapper);KiiAnalyticsTiXHRWrapper=function(superClass){extend(KiiAnalyticsTiXHRWrapper,superClass);function KiiAnalyticsTiXHRWrapper(){return KiiAnalyticsTiXHRWrapper.__super__.constructor.apply(this,arguments)}KiiAnalyticsTiXHRWrapper.prototype.getAppID=function(){return root.KiiAnalytics.getAppID()};KiiAnalyticsTiXHRWrapper.prototype.getAppKey=function(){return root.KiiAnalytics.getAppKey()};KiiAnalyticsTiXHRWrapper.prototype.getLogger=function(){return root.KiiAnalytics.logger()};KiiAnalyticsTiXHRWrapper.prototype.getCurrentUser=function(){return null};return KiiAnalyticsTiXHRWrapper}(KiiTiXHRWrapper);KiiAnalyticsXHRWrapperFactory=function(){function KiiAnalyticsXHRWrapperFactory(){}KiiAnalyticsXHRWrapperFactory.createXHRWrapper=function(method,url){var wrapper;wrapper=null;if(root.KiiAnalytics._getHttpRequestType()===null){if(typeof jQuery!=="undefined"){root.KiiAnalytics.logger("Use jQuery");wrapper=new KiiAnalyticsJQXHRWrapper(method,url)}else if(typeof XMLHttpRequest!=="undefined"){root.KiiAnalytics.logger("Use XMLHttpRequest");wrapper=new KiiAnalyticsXHRWrapper(method,url)}else if(typeof Titanium!=="undefined"){root.KiiAnalytics.logger("Use Titanium");wrapper=new KiiAnalyticsTiXHRWrapper(method,url)}}else{root.KiiAnalytics.logger("Use http request backdoor");if(root.KiiAnalytics._getHttpRequestType()===root._KiiHttpRequestType.jQuery){root.KiiAnalytics.logger("Use jQuery");wrapper=new KiiAnalyticsJQXHRWrapper(method,url)}else if(root.KiiAnalytics._getHttpRequestType()===root._KiiHttpRequestType.XMLHttpRequest){root.Kii.logger("Use XMLHttpRequest");wrapper=new KiiAnalyticsXHRWrapper(method,url)}else if(root.KiiAnalytics._getHttpRequestType()===root._KiiHttpRequestType.Titanium){root.Kii.logger("Use Titanium");wrapper=new KiiAnalyticsTiXHRWrapper(method,url)}}return wrapper};return KiiAnalyticsXHRWrapperFactory}();root.KiiSCNGoogle=function(superClass){extend(KiiSCNGoogle,superClass);function KiiSCNGoogle(){this._unlinkFromCurrentUser=bind(this._unlinkFromCurrentUser,this);this._linkWithCurrentUser=bind(this._linkWithCurrentUser,this);this._logOut=bind(this._logOut,this);this._logIn=bind(this._logIn,this);this._getAccessToken=bind(this._getAccessToken,this);this._createTokenObject=bind(this._createTokenObject,this);this._setup=bind(this._setup,this);KiiSCNGoogle.__super__.constructor.call(this,root.KiiSocialNetworkName.GOOGLEPLUS)}KiiSCNGoogle.prototype._setup=function(_key,_secret,_extras){this._key=_key;this._secret=_secret;this._extras=_extras;return KiiSCNGoogle.__super__._setup.call(this,this._key,this._secret,this._extras)};KiiSCNGoogle.prototype._createTokenObject=function(options,data){var tokenObject;tokenObject={access_token:options.access_token};if(data!=null&&data.new_user_created!=null){tokenObject["kii_new_user"]=data.new_user_created}return tokenObject};KiiSCNGoogle.prototype._getAccessToken=function(options){return options.access_token};KiiSCNGoogle.prototype._logIn=function(options,callbacks){var requestData;root.Kii.logger("should auth google");root.Kii.logger("Checking options");if(options==null||!options.access_token){throw root.InvalidArgumentException("options.access_token is required")}if(root.KiiUser.getCurrentUser()!=null){root.KiiUser.logOut()}requestData={accessToken:options.access_token};return this._register("google","application/vnd.kii.AuthTokenGoogleRequest+json",requestData,options,callbacks)};KiiSCNGoogle.prototype._logOut=function(){KiiSCNGoogle.__super__._logOut.apply(this,arguments);return root.Kii.logger("Log out google")};KiiSCNGoogle.prototype._linkWithCurrentUser=function(options,callbacks){var requestData;if(root.KiiUser.getCurrentUser()!=null){if(options==null||!options.access_token){throw root.InvalidArgumentException("options.access_token is required")}requestData={accessToken:options.access_token};return this._link("google","application/vnd.kii.LinkGoogleRequest+json",requestData,options,callbacks)}else if(callbacks!=null){return callbacks.failure(null,this._network,"A KiiUser must be logged in before linking to Google")}};KiiSCNGoogle.prototype._unlinkFromCurrentUser=function(callbacks){if(root.KiiUser.getCurrentUser()!=null){return this._unlink("google",callbacks)}else if(callbacks!=null){return callbacks.failure("A KiiUser must be logged in before unlinking from Google")}};return KiiSCNGoogle}(root.KiiSocialConnectNetwork);root.KiiSCNRenRen=function(superClass){extend(KiiSCNRenRen,superClass);function KiiSCNRenRen(){this._unlinkFromCurrentUser=bind(this._unlinkFromCurrentUser,this);this._linkWithCurrentUser=bind(this._linkWithCurrentUser,this);this._logOut=bind(this._logOut,this);this._logIn=bind(this._logIn,this);this._getAccessToken=bind(this._getAccessToken,this);this._createTokenObject=bind(this._createTokenObject,this);this._setup=bind(this._setup,this);KiiSCNRenRen.__super__.constructor.call(this,root.KiiSocialNetworkName.RENREN)}KiiSCNRenRen.prototype._setup=function(_key,_secret,_extras){this._key=_key;this._secret=_secret;this._extras=_extras;return KiiSCNRenRen.__super__._setup.call(this,this._key,this._secret,this._extras)};KiiSCNRenRen.prototype._createTokenObject=function(options,data){var tokenObject;tokenObject={access_token:options.access_token};if(data!=null&&data.new_user_created!=null){tokenObject["kii_new_user"]=data.new_user_created}return tokenObject};KiiSCNRenRen.prototype._getAccessToken=function(options){return options.access_token};KiiSCNRenRen.prototype._logIn=function(options,callbacks){var requestData;root.Kii.logger("should auth renren");root.Kii.logger("Checking options");if(options==null||!options.access_token){throw root.InvalidArgumentException("options.access_token is required")}if(root.KiiUser.getCurrentUser()!=null){root.KiiUser.logOut()}requestData={accessToken:options.access_token};return this._register("renren","application/vnd.kii.AuthTokenRenRenRequest+json",requestData,options,callbacks)};KiiSCNRenRen.prototype._logOut=function(){KiiSCNRenRen.__super__._logOut.apply(this,arguments);return root.Kii.logger("Log out renren")};KiiSCNRenRen.prototype._linkWithCurrentUser=function(options,callbacks){var requestData;if(root.KiiUser.getCurrentUser()!=null){if(options==null||!options.access_token){throw root.InvalidArgumentException("options.access_token is required")}requestData={accessToken:options.access_token};return this._link("renren","application/vnd.kii.LinkRenRenRequest+json",requestData,options,callbacks)}else if(callbacks!=null){return callbacks.failure(null,this._network,"A KiiUser must be logged in before linking to RenRen")}};KiiSCNRenRen.prototype._unlinkFromCurrentUser=function(callbacks){if(root.KiiUser.getCurrentUser()!=null){return this._unlink("renren",callbacks)}else if(callbacks!=null){return callbacks.failure("A KiiUser must be logged in before unlinking from RenRen")}};return KiiSCNRenRen}(root.KiiSocialConnectNetwork);root.KiiThingContext=function(){function KiiThingContext(spec){this._objectWithURI=bind(this._objectWithURI,this);this._getToken=bind(this._getToken,this);this.pushInstallation=bind(this.pushInstallation,this);this.getAuthenticatedThing=bind(this.getAuthenticatedThing,this);this.listTopics=bind(this.listTopics,this);this.topicWithName=bind(this.topicWithName,this);this._token=spec.token;this._thingId=spec.thingId;if(spec.vendorThingID!=null){this._vendorThingID=spec.vendorThingID}}KiiThingContext.prototype.bucketWithName=function(bucketName){var adminBucket;adminBucket=new root.KiiBucketWithToken(bucketName,null,this._token);return adminBucket};KiiThingContext.prototype.encryptedBucketWithName=function(bucketName){var bucket;bucket=new root.KiiEncryptedBucketWithToken(bucketName,null,this._token);return bucket};KiiThingContext.prototype.objectWithURI=function(objectURI){var object;object=this._objectWithURI(objectURI);return object};KiiThingContext.prototype.topicWithName=function(topicName){if(typeof topicName!=="string"||topicName===""){throw new root.InvalidArgumentException("topicName should not null or empty")}return new root.KiiTopicWithToken(root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID(),topicName,this._token)};KiiThingContext.prototype.listTopics=function(callbacks,paginationKey){return root.Kii._listTopics(callbacks,paginationKey,this)};KiiThingContext.prototype.getAuthenticatedThing=function(){var thingContext;thingContext=root.KiiThingWithToken.thingWithID(this._thingId,this._token);thingContext._accessToken=this._token;thingContext._vendorThingID=this._vendorThingID;return thingContext};KiiThingContext.prototype.pushInstallation=function(){return new root.KiiPushInstallationWithToken(this._token)};KiiThingContext.prototype._getToken=function(){return this._token};KiiThingContext.prototype._objectWithURI=function(objectUri){var bucket,bucketIndex,bucketName,compLength,components,newURI,obj,subject,valid;if(!objectUri){throw new root.InvalidURIException}valid=objectUri.indexOf("kiicloud://")===0;newURI=objectUri.substr("kiicloud://".length);components=newURI.split("/");compLength=components.length;if(compLength>=4&&valid){bucketIndex=compLength===4?1:3;bucketName=components[bucketIndex];subject=null;if(components[0]==="groups"&&compLength===6){subject=new root.KiiGroupWithToken._groupWithID(components[1],this._token)}else if(components[0]==="users"&&compLength===6){subject=root.KiiUserWithToken._userWithID(components[1],this._token)}else if(components[0]==="things"&&compLength===6){subject=root.KiiThingWithToken.thingWithID(components[1],this._token)}else if(compLength!==4){throw new root.InvalidURIException}bucket=new root.KiiBucketWithToken(bucketName,subject,this._token);obj=bucket.createObject();obj._setUUID(components[compLength-1])}else{throw new root.InvalidURIException}return obj};return KiiThingContext}();root.KiiUserBuilder=function(){function KiiUserBuilder(){this._password=null;this._username=null;this._emailAddress=null;this._phoneNumber=null;this._country=null}KiiUserBuilder.builderWithIdentifier=function(identifier,password){var builder,trimmed;if(identifier==null){throw new root.InvalidArgumentException("Identifier must not be null or undefined")}if(!KiiUtilities._validatePassword(password)){throw new root.InvalidPasswordException}builder=new root.KiiUserBuilder;builder._password=password;if(KiiUtilities._validatePhoneNumber(identifier)){builder._phoneNumber=identifier}else{trimmed=KiiUtilities._trim(identifier);if(KiiUtilities._validateEmail(trimmed)){builder._emailAddress=trimmed}else if(KiiUtilities._validateUsername(trimmed)){builder._username=trimmed}else{throw new root.InvalidArgumentException}}return builder};KiiUserBuilder.builderWithEmailAddress=function(emailAddress,password){var builder;if(!KiiUtilities._validateEmail(emailAddress)){throw new root.InvalidEmailException}if(!KiiUtilities._validatePassword(password)){throw new root.InvalidPasswordException}builder=new root.KiiUserBuilder;builder._emailAddress=KiiUtilities._trim(emailAddress);builder._password=password;return builder};KiiUserBuilder.builderWithGlobalPhoneNumber=function(phoneNumber,password){var builder;if(!KiiUtilities._validatePhoneNumber(phoneNumber)){throw new root.InvalidPhoneNumberException}if(!KiiUtilities._isGlobalPhoneNumber(phoneNumber)){throw new root.InvalidPhoneNumberException}if(!KiiUtilities._validatePassword(password)){throw new root.InvalidPasswordException}builder=new root.KiiUserBuilder;builder._phoneNumber=phoneNumber;builder._password=password;return builder};KiiUserBuilder.builderWithLocalPhoneNumber=function(phoneNumber,country,password){var builder;if(!KiiUtilities._validateLocalPhone(phoneNumber)){throw new root.InvalidPhoneNumberException}if(!KiiUtilities._validateCountryCode(country)){throw new root.InvalidCountryException}if(!KiiUtilities._validatePassword(password)){throw new root.InvalidPasswordException}builder=new root.KiiUserBuilder;builder._phoneNumber=phoneNumber;builder._country=country;builder._password=password;return builder};KiiUserBuilder.builderWithUsername=function(username,password){var builder,trimmed;trimmed=KiiUtilities._trim(username);if(!KiiUtilities._validateUsername(trimmed)){throw new root.InvalidUsernameException}if(!KiiUtilities._validatePassword(password)){throw new root.InvalidPasswordException}builder=new root.KiiUserBuilder;builder._username=trimmed;builder._password=password;return builder};KiiUserBuilder.prototype.setUsername=function(username){var trimmed;if(username!=null){trimmed=KiiUtilities._trim(username);if(KiiUtilities._validateUsername(trimmed)){this._username=trimmed}else{throw new root.InvalidUsernameException}}return this};KiiUserBuilder.prototype.setEmailAddress=function(emailAddress){var trimmed;if(emailAddress!=null){trimmed=KiiUtilities._trim(emailAddress);if(KiiUtilities._validateEmail(trimmed)){this._emailAddress=trimmed}else{throw new root.InvalidEmailException}}return this};KiiUserBuilder.prototype.setGlobalPhoneNumber=function(phoneNumber){if(phoneNumber!=null){if(KiiUtilities._validatePhoneNumber(phoneNumber)){this._phoneNumber=phoneNumber;this._country=null}else{throw new root.InvalidPhoneNumberException}}return this};KiiUserBuilder.prototype.setLocalPhoneNumber=function(phoneNumber,country){if(phoneNumber!=null&&!KiiUtilities._validateLocalPhone(phoneNumber)){throw new root.InvalidPhoneNumberException}if(country!=null&&!KiiUtilities._validateCountryCode(country)){throw new root.InvalidCountryException}if(phoneNumber!=null){this._phoneNumber=phoneNumber}if(country!=null){this._country=country}return this};KiiUserBuilder.prototype.build=function(){var kiiUser;kiiUser=new root.KiiUser;if(this._username!=null){kiiUser._setUsername(this._username)}if(this._emailAddress!=null){kiiUser._setEmailAddress(this._emailAddress)}if(this._country!=null){kiiUser._setLocalPhone(this._phoneNumber,this._country)}else if(this._phoneNumber!=null){kiiUser._setPhoneNumber(this._phoneNumber)}kiiUser._setPassword(this._password);return kiiUser};return KiiUserBuilder}();root.KiiPushInstallation=function(){function KiiPushInstallation(user){this._setAuthToken=bind(this._setAuthToken,this);this.uninstallByInstallationID=bind(this.uninstallByInstallationID,this);this.uninstall=bind(this.uninstall,this);this._getMqttEndpoint=bind(this._getMqttEndpoint,this);this.getMqttEndpoint=bind(this.getMqttEndpoint,this);this._install=bind(this._install,this);this.installMqtt=bind(this.installMqtt,this);this.installGcm=bind(this.installGcm,this);this._user=user}KiiPushInstallation.prototype.installGcm=function(installationRegistrationID,development,callbacks){if(!KiiUtilities._isNonEmptyString(installationRegistrationID)){return new Promise(function(_this){return function(resolve,reject){var errObj;errObj=KiiUtilities._Error("installationRegistrationID must not be null or empty.",_this);if(callbacks!=null){callbacks.failure(errObj)}return reject(errObj)}}(this))}return this._install(installationRegistrationID,"ANDROID",development,callbacks)};KiiPushInstallation.prototype.installMqtt=function(development,callbacks){return this._install(null,"MQTT",development,callbacks)};KiiPushInstallation.prototype._install=function(installationRegistrationID,deviceType,development,callbacks){return new Promise(function(_this){return function(resolve,reject){var errObj,requestBody,sendCallbacks,wrapper;if(typeof development!=="boolean"){errObj=KiiUtilities._Error("type of development must be boolean.",_this);if(callbacks!=null){callbacks.failure(errObj)}reject(errObj)}wrapper=KiiXHRWrapperFactory.createXHRWrapper("POST",root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+"/installations");wrapper.setKiiHeaders();_this._setAuthToken(wrapper);wrapper.setContentType("application/vnd.kii.InstallationCreationRequest+json");requestBody={deviceType:deviceType,development:development};if(installationRegistrationID!=null){requestBody["installationRegistrationID"]=installationRegistrationID}sendCallbacks={success:function(){var respJson;respJson=JSON.parse(decodeURIComponent(wrapper.xhr.responseText));if(callbacks!=null){callbacks.success(respJson)}return resolve(respJson)},failure:function(){var errString;errString=wrapper.getErrorString("install push");errObj=KiiUtilities._Error(errString,_this);if(callbacks!=null){callbacks.failure(errObj)}return reject(errObj)}};return wrapper.sendData(JSON.stringify(requestBody),sendCallbacks)}}(this))};KiiPushInstallation.prototype.getMqttEndpoint=function(installationID,callbacks){return new Promise(function(_this){return function(resolve,reject){var errObj,getMqttEndpointCallback;if(!KiiUtilities._isNonEmptyString(installationID)){errObj=KiiUtilities._Error("installationID must not be null or empty.",_this);if(callbacks!=null){callbacks.failure(errObj)}reject(errObj)}getMqttEndpointCallback={success:function(respJson){if(callbacks!=null){callbacks.success(respJson)}return resolve(respJson)},failure:function(err){if(callbacks!=null){callbacks.failure(err)}return reject(err)}};return _this._getMqttEndpoint(installationID,3,getMqttEndpointCallback)}}(this))};KiiPushInstallation.prototype._getMqttEndpoint=function(installationID,retry,callbacks){var instance,requestCallback,wrapper;instance=this;wrapper=KiiXHRWrapperFactory.createXHRWrapper("GET",root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+"/installations/"+installationID+"/mqtt-endpoint");wrapper.setKiiHeaders();this._setAuthToken(wrapper);requestCallback={success:function(_this){return function(){var respJson;respJson=JSON.parse(decodeURIComponent(wrapper.xhr.responseText));return callbacks.success(respJson)}}(this),failure:function(_this){return function(){var errObj,errString;if(wrapper.xhr.status===503){retry--;if(retry<=0){errString=wrapper.getErrorString("get mqtt endpoint");errObj=KiiUtilities._Error(errString,instance);return callbacks.failure(errObj)}else{return setTimeout(function(){return instance._getMqttEndpoint(installationID,retry,callbacks)},1e3)}}else{errString=wrapper.getErrorString("get mqtt endpoint");errObj=KiiUtilities._Error(errString,instance);return callbacks.failure(errObj)}}}(this)};return wrapper.send(requestCallback)};KiiPushInstallation.prototype.uninstall=function(installationRegistrationID,deviceType,callbacks){return new Promise(function(_this){return function(resolve,reject){var errObj,sendCallbacks,wrapper;if(!KiiUtilities._isNonEmptyString(installationRegistrationID)){errObj=KiiUtilities._Error("installationRegistrationID must not be null or empty.",_this);if(callbacks!=null){callbacks.failure(errObj)}reject(errObj)}if(!root.KiiPushInstallation._validateDeviceType(deviceType)){errObj=KiiUtilities._Error("Unsupported deviceType "+deviceType,_this);if(callbacks!=null){callbacks.failure(errObj)}reject(errObj)}wrapper=KiiXHRWrapperFactory.createXHRWrapper("DELETE",root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+"/installations/"+deviceType+":"+installationRegistrationID);wrapper.setKiiHeaders();_this._setAuthToken(wrapper);sendCallbacks={success:function(){if(callbacks!=null){callbacks.success()}return resolve()},failure:function(){var errString;errString=wrapper.getErrorString("uninstall push");errObj=KiiUtilities._Error(errString,_this);if(callbacks!=null){callbacks.failure(errObj)}return reject(errObj)}};return wrapper.send(sendCallbacks)}}(this))};KiiPushInstallation.prototype.uninstallByInstallationID=function(installationID,callbacks){return new Promise(function(_this){return function(resolve,reject){var errObj,sendCallbacks,wrapper;if(!KiiUtilities._isNonEmptyString(installationID)){errObj=KiiUtilities._Error("installationID must not be null or empty.",_this);if(callbacks!=null){callbacks.failure(errObj)}reject(errObj)}wrapper=KiiXHRWrapperFactory.createXHRWrapper("DELETE",root.Kii.getBaseURL()+"/apps/"+root.Kii.getAppID()+"/installations/"+installationID);wrapper.setKiiHeaders();_this._setAuthToken(wrapper);sendCallbacks={success:function(){if(callbacks!=null){callbacks.success()}return resolve()},failure:function(){var errString;errString=wrapper.getErrorString("uninstall push");errObj=KiiUtilities._Error(errString,_this);if(callbacks!=null){callbacks.failure(errObj)}return reject(errObj)}};return wrapper.send(sendCallbacks)}}(this))};KiiPushInstallation._validateDeviceType=function(deviceType){return deviceType==="ANDROID"||deviceType==="MQTT"};KiiPushInstallation.prototype._setAuthToken=function(wrapper){return wrapper.setCurrentUserToken()};return KiiPushInstallation}();root.KiiPushInstallationWithToken=function(superClass){extend(KiiPushInstallationWithToken,superClass);function KiiPushInstallationWithToken(_authToken){this._authToken=_authToken;this._setAuthToken=bind(this._setAuthToken,this)}KiiPushInstallationWithToken.prototype._setAuthToken=function(wrapper){return wrapper.setAuthToken(this._authToken)};return KiiPushInstallationWithToken}(root.KiiPushInstallation);return root};(function(){var b=typeof module!=="undefined"&&module!==null;if(b&&module.exports){module.exports={exportedClasses:["ForTest","Kii","KiiACL","KiiACLEntry","KiiACLWithToken","KiiAnalytics","KiiAnonymousUser","KiiAnyAuthenticatedUser","KiiAppAdminContext","KiiBucket","KiiBucketWithToken","KiiClause","KiiEncryptedBucket","KiiEncryptedBucketWithToken","KiiGeoPoint","KiiGroup","KiiGroupWithToken","KiiObject","KiiObjectWithToken","KiiPushInstallation","KiiPushInstallationWithToken","KiiPushSubscription","KiiPushSubscriptionWithToken","KiiQuery","KiiSCNFacebook","KiiSCNGoogle","KiiSCNQQ","KiiSCNRenRen","KiiSCNTwitter","KiiSDKClientInfo","KiiServerCodeEntry","KiiServerCodeExecResult","KiiSocialConnect","KiiSocialConnectNetwork","KiiThing","KiiThingContext","KiiThingWithToken","KiiTopic","KiiPushMessageBuilder","KiiTopicWithToken","KiiUser","KiiUserBuilder","KiiUserWithToken","KiiSocialNetworkName","KiiSite","_KiiHttpRequestType","KiiACLAction","KiiAnalyticsSite","InvalidDisplayNameException","InvalidPasswordException","InvalidUsernameException","InvalidUserIdentifierException","InvalidEmailException","InvalidPhoneNumberException","InvalidLocalPhoneNumberException","InvalidCountryException","InvalidURIException","InvalidACLAction","InvalidACLSubject","InvalidACLGrant","InvalidLimitException","InvalidArgumentException","IllegalStateException","ArithmeticException","UnsupportedOperationException"],create:function(){return ctor.call(this)}}}else{ctor()}})()})();
